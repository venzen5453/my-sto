                                                                                    <!DOCTYPE html>
                                                                                    <html lang="ko">

                                                                                    <head>
                                                                                        <link rel="apple-touch-icon" href="./aisa.jpg">
                                                                                        <meta charset="UTF-8">
                                                                                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                                                                        <meta name="apple-mobile-web-app-capable" content="yes">
                                                                                        <meta name="apple-mobile-web-app-status-bar-style" content="black">
                                                                                    

                                                                                        <style>
                                                                                            :root {
                                                                                                --primary-color: #4a90e2; --income-color: #2ecc71; --expense-color: #e74c3c;
                                                                                                --bg-color: #f8f9fa; --card-bg: #ffffff; --header-bg: #2c3e50;
                                                                                                --text-main: #2c3e50; --border-color: #e0e0e0;
                                                                                                --cash-accent: #fcc419; --card-accent: #4dabf7;
                                                                                                --input-bg: #ffffff; --input-text: #2c3e50;
                                                                                                --btn-plus-bg: #e8f5e9; --btn-plus-text: #2ecc71;
                                                                                                --btn-minus-bg: #ffebee; --btn-minus-text: #e74c3c;
                                                                                            }
                                                                                            [data-theme='dark'] {
                                                                                                --bg-color: #121212; --card-bg: #1e1e1e; --header-bg: #000000;
                                                                                                --text-main: #f5f5f5; --border-color: #333333;
                                                                                                --input-bg: #2d2d2d; --input-text: #ffffff;
                                                                                                --btn-plus-bg: #1b3322; --btn-plus-text: #2ecc71;
                                                                                                --btn-minus-bg: #331b1b; --btn-minus-text: #ff6b6b;
                                                                                            }
                                                                                    html, body {
                                                                                    height: 100%;
                                                                                    margin: 0;
                                                                                    padding: 0;
                                                                                    overflow: hidden;
                                                                                    background: var(--bg-color);
                                                                                    }
                                                                                            .app-container { 
                                                                                                position: fixed; 
                                                                                                inset: 0; 
                                                                                                width: 100%; 
                                                                                                height: 100dvh;
                                                                                                background: var(--bg-color); 
                                                                                                color: var(--text-main); 
                                                                                                display: flex; 
                                                                                                flex-direction: column;
                                                                                                
                                                                                                
                                                                                            }
                                                                                            .tab-content { display: none; flex-direction: column; flex: 1; overflow: hidden; }
                                                                                            .tab-content.active { display: flex; }
                                                                                            .header { background: var(--header-bg); color: white;  padding: calc(env(safe-area-inset-top) + 10px) 20px 20px 20px; text-align: center; flex-shrink: 0; transition: background 0.3s; }
                                                                                            .total-amount { font-size: 1.6rem; font-weight: 700; margin: 5px 0; opacity: 0.9; }
                                                                                            .asset-split { display: flex; justify-content: space-around; gap: 8px; margin-top: 15px; }
                                                                                            .asset-item { flex: 1; background: rgba(255,255,255,0.07); padding: 12px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
                                                                                            .asset-label { font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 4px; }
                                                                                            .asset-value { font-size: 1.1rem; font-weight: 800; }
                                                                                            .monthly-summary { display: flex; background: rgba(0,0,0,0.25); border-radius: 12px; margin: 15px 0 5px 0; padding: 12px; font-size: 0.8rem; justify-content: space-around; }
                                                                                            .action-box { padding: 25px 20px; border-bottom: 4px solid var(--border-color); flex-shrink: 0; background: var(--bg-color); }
                                                                                            .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
                                                                                            .button-grid button { padding: 22px 10px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 1.0rem; }
                                                                                            .btn-plus { background: var(--btn-plus-bg) !important; color: var(--btn-plus-text) !important; }
                                                                                            .btn-minus { background: var(--btn-minus-bg) !important; color: var(--btn-minus-text) !important; }
                                                                                            .scroll-area { flex: 1; overflow-y: auto;  -webkit-overflow-scrolling: touch; padding: 0 20px 90px; background: var(--bg-color); }
                                                                                        

                                                                                    /* --------------------------------------------------------------------------------- */
                                                                                            
                                                                                    /* Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Îã¥Îäî 2Îã® Ïª®ÌÖåÏù¥ÎÑà */
                                                                                    /* --- [Ìôà ÌôîÎ©¥] ÏöîÏ≤≠ÌïòÏã† Ïª¥Ìå©Ìä∏ Ïä§ÌÉÄÏùº --- */
                                                                                    .history-split-container {
                                                                                        display: flex;
                                                                                        gap: 10px;
                                                                                        padding: 15px 0;
                                                                                        border-bottom: 1px solid var(--border-color);
                                                                                    }
                                                                                    .history-column {
                                                                                        flex: 1;
                                                                                        display: flex;
                                                                                        flex-direction: column;
                                                                                        gap: 8px;
                                                                                        min-height: 20px;
                                                                                    }
                                                                                    .column-divider {
                                                                                        width: 1px;
                                                                                        background-color: var(--border-color);
                                                                                    }
                                                                                    .history-mini-item {
                                                                                        font-size: 0.8rem;
                                                                                        padding: 6px 5px; /* Ïª¥Ìå©Ìä∏ÌïòÏßÄÎßå Í∞ÄÎèÖÏÑ± ÏûàÍ≤å Ï°∞Ï†ï */
                                                                                        border-radius: 8px;
                                                                                        background: rgba(120, 120, 120, 0.05); /* Îã§ÌÅ¨/ÎùºÏù¥Ìä∏ Î≤îÏö© Î∞∞Í≤Ω */
                                                                                    }


                                                                                    /* --- [Í≤ÄÏÉâ ÌôîÎ©¥] ÏÑ∏Î†®Îêú ÎØ∏ÎãàÎ©Ä Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏàòÏ†ïÎ≥∏) --- */
                                                                                    .search-item {
                                                                                        display: flex;
                                                                                        justify-content: space-between;
                                                                                        align-items: center;
                                                                                        /* ÏôºÏ™Ω Ìå®Îî©ÏùÑ 25pxÎ°ú ÎäòÎ†§ ÏÉâÏÉÅ Î∞îÏôÄ Í∏ÄÏî® ÏÇ¨Ïù¥Ïùò Í∞ÑÍ≤©ÏùÑ ÌôïÎ≥¥Ìï©ÎãàÎã§ */
                                                                                        padding: 10px 10px 10px 20px; 
                                                                                        margin-bottom: 10px;
                                                                                        background: var(--card-bg);
                                                                                        border-radius: 10px; /* Ï¢Ä Îçî Îë•Í∏ÄÍ≤å ÏàòÏ†ï */
                                                                                        border: 1px solid var(--border-color);
                                                                                        position: relative;
                                                                                        overflow: hidden;
                                                                                    }

                                                                                    /* ÏôºÏ™Ω Ìè¨Ïù∏Ìä∏ ÎùºÏù∏ (ÎëêÍªòÎ•º ÏÇ¥Ïßù ÏñáÍ≤å Ï°∞Ï†ïÌïòÏó¨ Îçî ÏÑ∏Î†®ÎêòÍ≤å Î≥ÄÍ≤Ω) */
                                                                                    .search-item::before {
                                                                                        content: '';
                                                                                        position: absolute;
                                                                                        left: 0; top: 0; bottom: 0; 
                                                                                        width: 5px; /* Í∏∞Ï°¥ 5pxÏóêÏÑú 4pxÎ°ú Ï°∞Ï†à */
                                                                                    }
                                                                                    .search-cash::before { background-color: #fcc419; }
                                                                                    .search-card::before { background-color: #4dabf7; }

                                                                                    /* Í≤∞Ï†úÏàòÎã® ÌÉúÍ∑∏: Î∞∞Í≤ΩÏùÑ Ìà¨Î™ÖÌïòÍ≤å Í≥†Ï†ï */
                                                                                    .method-tag {
                                                                                        font-size: 0.75rem;
                                                                                        font-weight: 800;
                                                                                        display: inline-block;
                                                                                        background: transparent !important; 
                                                                                        padding: 0 !important;
                                                                                        margin-right: 6px;
                                                                                    }

                                                                                    /* Í∏ÄÏûêÏÉâ Ìè¨Ïù∏Ìä∏ */
                                                                                    .tag-cash { color: #fcc419 !important; } 
                                                                                    .tag-card { color: #4dabf7 !important; }

                                                                                    /* Îã§ÌÅ¨Î™®Îìú Í∞ÄÎèÖÏÑ± Î≥¥Ï†ï */
                                                                                    [data-theme='dark'] .tag-cash { color: #ffec99 !important; }
                                                                                    [data-theme='dark'] .tag-card { color: #a5d8ff !important; }

                                                                                    .search-cat { font-size: 1.05rem; font-weight: 700; display: block; margin-top: 2px; }
                                                                                    .search-amt { font-size: 1.1rem; font-weight: 800; text-align: right; }

                                                                                    /* ---------------------------------------------------------------------- */

                                                                                            .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 5px; }
                                                                                            .tag-cash { background: #fff9db; color: #f08c00; }
                                                                                            .tag-card { background: #e7f5ff; color: #1971c2; }

                                                                                            
                                                                                    /* ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞îÎ•º Í≥µÏ§ëÏúºÎ°ú ÎùÑÏõÄ */
                                                                                    .nav-bar { 
                                                                                        position: absolute; 
                                                                                        bottom: calc(env(safe-area-inset-bottom) + 15px);
                                                                                        left: 20px;
                                                                                        right: 20px;
                                                                                        max-width: 440px;

                                                                                        height: 70px;
                                                                                        background: var(--card-bg); 
                                                                                        border: 1px solid var(--border-color); 
                                                                                        border-radius: 28px;

                                                                                        display: flex; 
                                                                                        justify-content: space-around; 
                                                                                        align-items: center; 

                                                                                        z-index: 1000;
                                                                                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                                                                                    }


                                                                                    /* Î©îÎâ¥ ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï */
                                                                                    .nav-item { 
                                                                                        border: none; 
                                                                                        background: none; 
                                                                                        color: #888; 
                                                                                        cursor: pointer; 
                                                                                        display: flex; 
                                                                                        flex-direction: column; 
                                                                                        align-items: center; 
                                                                                        justify-content: center;
                                                                                        flex: 1; 
                                                                                        height: 100%;
                                                                                    }

                                                                                    /* ÌôúÏÑ±Ìôî ÏÉÅÌÉú */
                                                                                    .nav-item.active { 
                                                                                        color: var(--primary-color); 
                                                                                    }




                                                                                    /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ Í≥†Ï†ï (Ïù¥Ï†ÑÍ≥º ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ) */
                                                                                    .nav-item span:first-child {
                                                                                        font-size: 1.4rem; /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞Îäî ÏãúÏõêÌïòÍ≤å Ïú†ÏßÄ */
                                                                                        margin-bottom: 0px;
                                                                                    }
                                                                                            .nav-item.active { color: var(--primary-color); font-weight: bold; }
                                                                                            .styled-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--input-text); box-sizing: border-box; outline: none; font-size: 1rem; }
                                                                                            #modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
                                                                                            .modal { background: var(--card-bg); width: 88%; border-radius: 25px; padding: 25px; box-sizing: border-box; color: var(--text-main); }
                                                                                            .modal-input { width: 100%; padding: 15px; border: 2px solid var(--primary-color); border-radius: 15px; font-size: 1.8rem; font-weight: bold; text-align: center; margin-bottom: 20px; background: var(--input-bg); color: var(--input-text); outline: none; box-sizing: border-box; }

                                                                                            /* ÌÜµÍ≥Ñ Í∑∏ÎûòÌîÑ Ïä§ÌÉÄÏùº */
                                                                                            .chart-container { padding: 20px 0; }
                                                                                            .chart-row { margin-bottom: 20px; }
                                                                                            .chart-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; }
                                                                                            .chart-bar-bg { width: 100%; height: 12px; background: var(--border-color); border-radius: 6px; overflow: hidden; }
                                                                                            .chart-bar-fill { height: 100%; background: var(--expense-color); border-radius: 6px; transition: width 0.5s ease-out; }
                                                                                        </style>
                                                                                    </head>
                                                                                    <body>

                                                                                    <div class="app-container">
                                                                                        <div id="modal-overlay">
                                                                                            <div class="app-inner">
                                                                                                <div id="modal-type-title" style="font-weight: bold; margin-bottom: 15px; text-align: center; color: var(--primary-color);">ÎÇ¥Ïó≠ ÏûÖÎ†•</div>
                                                                                                <input type="number" id="modal-amount-input" class="modal-input" inputmode="numeric" placeholder="0">
                                                                                                <div id="category-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;"></div>
                                                                                                <input type="text" id="modal-note-input" class="styled-input" style="margin-bottom:20px;" placeholder="ÏÉÅÏÑ∏ Î©îÎ™®">
                                                                                                <div style="display:flex; gap:10px;">
                                                                                                    <button onclick="closeModal()" style="flex:1; padding:15px; border:none; background:#666; border-radius:12px; color:white; font-weight:bold;">Ï∑®ÏÜå</button>
                                                                                                    <button onclick="confirmTransaction()" style="flex:1; padding:15px; border:none; background:var(--primary-color); color:white; border-radius:12px; font-weight:bold;">Ï†ÄÏû•ÌïòÍ∏∞</button>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <div id="tab-home" class="tab-content active">
                                                                                            <div class="header">
                                                                                                <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:10px;">
                                                                                                    <button onclick="moveDate(-1)" style="background:none; border:none; color:white; font-size:1rem;">‚óÄ</button>
                                                                                                    <input type="date" id="date-picker" onchange="updateUI();" style="background:rgba(255,255,255,0.15); border:none; color:white; padding:6px 10px; border-radius:8px; font-size:0.9rem; color-scheme:dark;">
                                                                                                    <button onclick="moveDate(1)" style="background:none; border:none; color:white; font-size:1rem;">‚ñ∂</button>
                                                                                                </div>
                                                                                                <div class="total-amount" id="total-balance">ÌÜ†ÌÉà ¬•0</div>
                                                                                                <div class="asset-split">
                                                                                                    <div class="asset-item"><span class="asset-label" style="color:var(--cash-accent)">Ï†ÑÏ≤¥ ÌòÑÍ∏à</span><div id="cash-balance" class="asset-value" style="color:var(--cash-accent)">¬•0</div></div>
                                                                                                    <div class="asset-item"><span class="asset-label" style="color:var(--card-accent)">Ï†ÑÏ≤¥ Ïπ¥Îìú</span><div id="card-balance" class="asset-value" style="color:var(--card-accent)">¬•0</div></div>
                                                                                                </div>
                                                                                                <div class="monthly-summary">
                                                                                                    <div>Ïù¥Î≤àÎã¨ ÏàòÏûÖ <b id="month-in" style="color:#2ecc71">¬•0</b></div>
                                                                                                    <div style="width:1px; background:rgba(255,255,255,0.2);"></div>
                                                                                                    <div>Ïù¥Î≤àÎã¨ ÏßÄÏ∂ú <b id="month-out" style="color:#ff6b6b">¬•0</b></div>
                                                                                                </div>
                                                                                            </div>
                                                                                            <div class="action-box">
                                                                                                <div class="button-grid">
                                                                                                    <button class="btn-plus" onclick="openModal('plus', 'cash')">üí∞ ÌòÑÍ∏à ÏûÖÍ∏à</button>
                                                                                                    <button class="btn-plus" onclick="openModal('plus', 'card')">üí≥ Ïπ¥Îìú ÏûÖÍ∏à</button>
                                                                                                    <button class="btn-minus" onclick="openModal('minus', 'cash')">üí∏ ÌòÑÍ∏à Ï∂úÍ∏à</button>
                                                                                                    <button class="btn-minus" onclick="openModal('minus', 'card')">üõçÔ∏è Ïπ¥Îìú Ï∂úÍ∏à</button>
                                                                                                </div>
                                                                                            </div>


                                                                                            
                                                                                            <div class="scroll-area" id="history-list"></div>
                                                                                        </div>

                                                                                    <div id="tab-chart" class="tab-content">
                                                                                            <div class="header">
                                                                                                <h2 style="margin:0;">üìä Ïù¥Î≤à Îã¨ ÏßÄÏ∂ú Î∂ÑÏÑù</h2>
                                                                                                <div id="chart-month-label" style="opacity:0.8; margin-top:5px; height: 1.2rem;"></div> </div>
                                                                                            <div class="scroll-area">
                                                                                                <div id="chart-list" class="chart-container"></div>
                                                                                                <div id="chart-empty" style="text-align:center; padding:50px; opacity:0.5; display:none;">ÏßÄÏ∂ú ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <div id="tab-search" class="tab-content">
                                                                                            <div class="header">
                                                                                                <h2 style="margin:0;">üîç Í±∞Îûò Í≤ÄÏÉâ</h2>
                                                                                                <div style="opacity:0.8; margin-top:5px; font-size: 0.9rem;">ÎÇ¥Ïó≠ ÌïÑÌÑ∞ÎßÅ Î∞è Í≤ÄÏÉâ</div> </div>
                                                                                            <div style="padding: 20px;"><input type="text" id="search-input" class="styled-input" placeholder="Î∂ÑÎ•òÎÇò Î©îÎ™® Í≤ÄÏÉâ..." onkeyup="searchHistory()"></div>
                                                                                            <div class="scroll-area" id="search-results"></div>
                                                                                        </div>

                                                                                        <div id="tab-more" class="tab-content">
                                                                                            <div class="header">
                                                                                                <h2 style="margin:0;">‚öôÔ∏è ÏÑ§Ï†ï</h2>
                                                                                                <div style="opacity:0.8; margin-top:5px; font-size: 0.9rem;">Ïï± ÌôòÍ≤Ω ÏÑ§Ï†ï Î∞è Í¥ÄÎ¶¨</div> </div>
                                                                                            <div class="scroll-area" style="padding-top:20px;">
                                                                                                <div style="background:var(--card-bg); padding:20px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border-color); margin-bottom:15px;">
                                                                                                    <span>üåô Îã§ÌÅ¨ Î™®Îìú</span>
                                                                                                    <button onclick="toggleTheme()" id="theme-status" style="padding:10px 25px; border-radius:20px; border:2px solid var(--primary-color); background:none; color:var(--primary-color); font-weight:bold;">OFF</button>
                                                                                                </div>
                                                                                                <button onclick="exportMonthlyExcel()" style="width:100%; padding:18px; border-radius:15px; border:none; background:var(--header-bg); color:white; font-weight:bold; cursor:pointer; margin-bottom:25px;">üìÇ Ïù¥Î≤à Îã¨ ÎÇ¥Ïó≠ ÏóëÏÖÄÎ°ú Ï†ÄÏû•</button>
                                                                                                
                                                                                                <h4 style="margin:0 0 10px 5px;">üîÅ Í≥†Ï†ï ÏßÄÏ∂ú ÏÑ§Ï†ï</h4>
                                                                                                <div style="background:var(--card-bg); padding:18px; border-radius:15px; border:1px solid var(--border-color); margin-bottom:40px;">
                                                                                                    <input type="text" id="fixed-name" class="styled-input" placeholder="Ìï≠Î™©" style="margin-bottom:8px;">
                                                                                                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                                                                                                        <input type="number" id="fixed-day" class="styled-input" placeholder="ÎÇ†Ïßú(1~31)" style="flex:1;">
                                                                                                        <input type="number" id="fixed-amount" class="styled-input" placeholder="Í∏àÏï°" style="flex:2;">
                                                                                                    </div>
                                                                                                    <button onclick="addFixedItem()" style="width:100%; padding:14px; background:var(--primary-color); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size: 1.1rem;">Í≥†Ï†ïÏßÄÏ∂úÎπÑ Îì±Î°ùÌïòÍ∏∞</button>
                                                                                                    <div id="fixed-list" style="margin-top:15px;"></div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <nav class="nav-bar">
                                                                                            <button class="nav-item active" onclick="switchTab('home', this)">üè†<span>Ìôà</span></button>
                                                                                            <button class="nav-item" onclick="switchTab('chart', this)">üìä<span>ÌÜµÍ≥Ñ</span></button>
                                                                                            <button class="nav-item" onclick="switchTab('search', this)">üîç<span>Í≤ÄÏÉâ</span></button>
                                                                                            <button class="nav-item" onclick="switchTab('more', this)">‚öôÔ∏è<span>ÏÑ§Ï†ï</span></button>
                                                                                        </nav>
                                                                                    </div>

                                                                                    <script>
                                                                                        const categories = {
                                                                                        plus: [
                                                                                            {name:'ÏõîÍ∏â', icon:'üí∞'},
                                                                                            {name:'Î≥¥ÎÑàÏä§', icon:'üéä'},
                                                                                            {name:'Ïö©Îèà', icon:'üéÅ'},
                                                                                            {name:'Î∂ÄÏàòÏûÖ', icon:'üìà'},
                                                                                            {name:'Ïù¥Ïõî', icon:'üîÑ'},
                                                                                            {name:'ÌôòÍ∏âÍ∏à', icon:'ü™ô'},
                                                                                            {name:'Í∏àÏúµÏàòÏùµ', icon:'üè¶'},
                                                                                            {name:'Í∏∞ÌÉÄÏûÖÍ∏à', icon:'‚ûï'}
                                                                                        ],
                                                                                        minus: [
                                                                                            {name:'ÏãùÎπÑ', icon:'üçî'},
                                                                                            {name:'Ïπ¥Ìéò/Í∞ÑÏãù', icon:'‚òï'},
                                                                                            {name:'ÍµêÌÜµ/Ï∞®Îüâ', icon:'üöå'},
                                                                                            {name:'ÏáºÌïë', icon:'üõçÔ∏è'},
                                                                                            {name:'ÏùòÎ£å/Í±¥Í∞ï', icon:'üíä'},
                                                                                            {name:'Î¨∏Ìôî/Ïó¨Í∞Ä', icon:'üéÆ'},
                                                                                            {name:'ÍµêÏú°/Ï∑®ÎØ∏', icon:'üìö'},
                                                                                            {name:'ÏÉùÌôúÏö©Ìíà', icon:'üßª'},
                                                                                            {name:'Í≤ΩÏ°∞ÏÇ¨/ÏÑ†Î¨º', icon:'üíå'},
                                                                                            {name:'Ï£ºÍ±∞/ÌÜµÏã†', icon:'üè†'},
                                                                                            {name:'Î≥¥Ìóò/ÏÑ∏Í∏à', icon:'üìÑ'},
                                                                                            {name:'Í∏∞ÌÉÄÏßÄÏ∂ú', icon:'‚ûñ'}
                                                                                        ]
                                                                                        };
                                                                                        let state = JSON.parse(localStorage.getItem('finalLedger_V41')) || { cash: 0, card: 0, dailyHistory: {}, isDark: false, fixedItems: [] };
                                                                                        let currentTransaction = {}, selectedCategory = "";

                                                                                        function init() {
                                                                                            const now = new Date();
                                                                                            const offset = now.getTimezoneOffset() * 60000;
                                                                                            const todayStr = new Date(now.getTime() - offset).toISOString().split('T')[0];
                                                                                            document.getElementById('date-picker').value = todayStr;
                                                                                            if(state.isDark) { document.documentElement.setAttribute('data-theme', 'dark'); document.getElementById('theme-status').innerText = 'ON'; }
                                                                                            updateUI();
                                                                                            renderFixedList();
                                                                                        }

                                                                                        // Í≥†Ï†ï ÏßÄÏ∂ú Ï≤òÎ¶¨
                                                                                        function checkAndProcessFixed() {
                                                                                            const activeDateStr = document.getElementById('date-picker').value; 
                                                                                            const [year, month, day] = activeDateStr.split('-').map(Number);
                                                                                            state.fixedItems.forEach(item => {
                                                                                                const fDay = parseInt(item.day);
                                                                                                if (fDay <= day) {
                                                                                                    const targetDateStr = `${year}-${String(month).padStart(2, '0')}-${String(fDay).padStart(2, '0')}`;
                                                                                                    if (!state.dailyHistory[targetDateStr]) state.dailyHistory[targetDateStr] = [];
                                                                                                    if (!state.dailyHistory[targetDateStr].some(h => h.note === "[ÏûêÎèô] " + item.name)) {
                                                                                                        state.dailyHistory[targetDateStr].unshift({ type: 'minus', method: 'Ïπ¥Îìú', category: 'Í≥†Ï†ïÎπÑ', note: "[ÏûêÎèô] " + item.name, amount: item.amount });
                                                                                                        state.card -= item.amount; save();
                                                                                                    }
                                                                                                }
                                                                                            });
                                                                                        }

                                                                                        function updateUI() {
                                                                                            checkAndProcessFixed();
                                                                                            const activeDate = document.getElementById('date-picker').value;
                                                                                            const curMonth = activeDate.substring(0, 7);
                                                                                            let dCash = state.cash, dCard = state.card;
                                                                                            Object.keys(state.dailyHistory).forEach(d => {
                                                                                                if (d > activeDate) {
                                                                                                    state.dailyHistory[d].forEach(h => {
                                                                                                        if (h.method === 'ÌòÑÍ∏à') dCash += (h.type === 'plus' ? -h.amount : h.amount);
                                                                                                        else dCard += (h.type === 'plus' ? -h.amount : h.amount);
                                                                                                    });
                                                                                                }
                                                                                            });
                                                                                            document.getElementById('cash-balance').innerText = "¬•" + dCash.toLocaleString();
                                                                                            document.getElementById('card-balance').innerText = "¬•" + dCard.toLocaleString();
                                                                                            document.getElementById('total-balance').innerText = "ÌÜ†ÌÉà ¬•" + (dCash + dCard).toLocaleString();

                                                                                            let mIn = 0, mOut = 0;
                                                                                            Object.keys(state.dailyHistory).forEach(d => { 
                                                                                                if(d.startsWith(curMonth)) state.dailyHistory[d].forEach(h => h.type==='plus'? mIn+=h.amount : mOut+=h.amount); 
                                                                                            });
                                                                                            document.getElementById('month-in').innerText = "¬•" + mIn.toLocaleString();
                                                                                            document.getElementById('month-out').innerText = "¬•" + mOut.toLocaleString();

                                                                                        // (updateUI Ìï®Ïàò ÎÇ¥Î∂Ä ÌïòÎã®Î∂Ä)
                                                                                        const dayData = state.dailyHistory[activeDate] || [];
                                                                                        const historyListEl = document.getElementById('history-list');

                                                                                        if (dayData.length === 0) {
                                                                                            historyListEl.innerHTML = '<p style="text-align:center; padding:40px; opacity:0.5;">Í±∞Îûò ÏóÜÏùå</p>';
                                                                                        } else {
                                                                                            // ÌòÑÍ∏àÍ≥º Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÎ¶¨
                                                                                            const cashItems = dayData.filter(h => h.method === 'ÌòÑÍ∏à');
                                                                                            const cardItems = dayData.filter(h => h.method === 'Ïπ¥Îìú');

                                                                                    const renderMiniItem = (h, i) => `
                                                                                        <div class="history-mini-item">
                                                                                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                                                                                <span style="font-weight:bold;">${h.category}</span>
                                                                                                <button onclick="deleteItem('${activeDate}', ${dayData.indexOf(h)})" 
                                                                                                        style="color:#e74c3c; background:none; border:none; font-size:0.65rem; padding:0; cursor:pointer; font-weight:bold;">
                                                                                                    ÏÇ≠Ï†ú
                                                                                                </button>
                                                                                            </div>
                                                                                            <div style="font-size:0.7rem; opacity:0.8; margin:2px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                                                                ${h.note}
                                                                                            </div>
                                                                                            <span class="mini-amt" style="color:${h.type==='plus'?'#2ecc71':'#e74c3c'}">
                                                                                                ${h.type==='plus'?'+':'-'}¬•${h.amount.toLocaleString()}
                                                                                            </span>
                                                                                        </div>
                                                                                    `;

                                                                                            historyListEl.innerHTML = `
                                                                                                <div style="display:flex; justify-content:space-around; font-size:0.75rem; font-weight:bold; padding-top:15px; opacity:0.7;">
                                                                                                    <span>üíµ ÌòÑÍ∏à ÎÇ¥Ïó≠</span>
                                                                                                    <span>üí≥ Ïπ¥Îìú ÎÇ¥Ïó≠</span>
                                                                                                </div>
                                                                                                <div class="history-split-container">
                                                                                                    <div class="history-column" id="cash-col">${cashItems.map(h => renderMiniItem(h)).join('')}</div>
                                                                                                    <div class="column-divider"></div>
                                                                                                    <div class="history-column" id="card-col">${cardItems.map(h => renderMiniItem(h)).join('')}</div>
                                                                                                </div>
                                                                                            `;
                                                                                        }
                                                                                        save();
                                                                                        }

                                                                                        // ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÏÉâÏÉÅ/Ïù¥Î™®ÏßÄ/Î∂ÑÎ•ò Í∞ïÌôî Î≤ÑÏ†Ñ)
                                                                                    function exportMonthlyExcel() {
                                                                                        const activeDate = document.getElementById('date-picker').value;
                                                                                        const curMonth = activeDate.substring(0, 7);
                                                                                        
                                                                                        const emojiMap = {};
                                                                                        [...categories.plus, ...categories.minus].forEach(c => emojiMap[c.name] = c.icon);

                                                                                        let excelContent = `
                                                                                        <html>
                                                                                        <head>
                                                                                            <meta charset="UTF-8">
                                                                                            <meta name="apple-mobile-web-app-capable" content="yes">
                                                                                            <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
                                                                                            <meta name="apple-mobile-web-app-title" content="Í∞ÄÍ≥ÑÎ∂ÄPro">

                                                                                        <link rel="apple-touch-icon" href="aisa.jpg">

                                                                                            <style>
                                                                                                table { border-collapse: collapse; width: 900px; font-family: 'Malgun Gothic', sans-serif; }
                                                                                                /* Î™®Îì† ÏÖÄÏùÑ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨Î°ú ÌÜµÏùº */
                                                                                                td { border: 1px solid #dddddd; padding: 10px; text-align: center; vertical-align: middle; }
                                                                                                .header { 
                                                                                        background: var(--header-bg); 
                                                                                        color: white; 
                                                                                        padding: 0 20px 20px 20px; /* ÏÉÅÎã® Ìå®Îî© Ï†úÍ±∞, ÌïòÎã®Îßå Ïú†ÏßÄ */
                                                                                        text-align: center; 
                                                                                        flex-shrink: 0; 
                                                                                        transition: background 0.3s;
                                                                                        
                                                                                        /* Ï∂îÍ∞Ä: ÌÜµÍ≥Ñ ÌÉ≠ ÎÜíÏù¥Ïóê ÎßûÏ∂∞ 150pxÎ°ú Í≥†Ï†ï */
                                                                                        height: 150px; 
                                                                                        display: flex;
                                                                                        flex-direction: column;
                                                                                        justify-content: flex-end; /* Ï†úÎ™©Îì§Ïù¥ Í∞ôÏùÄ Î∞îÎã• ÎùºÏù∏Ïóê Ïò§ÎèÑÎ°ù ÏÑ§Ï†ï */
                                                                                        box-sizing: border-box;
                                                                                    }
                                                                                                .income { color: #27ae60; background-color: #f1fef6; }
                                                                                                .expense { color: #e74c3c; background-color: #fef5f5; }
                                                                                                .cash-tag { color: #f39c12; font-weight: bold; }
                                                                                                .card-tag { color: #3498db; font-weight: bold; }
                                                                                                /* Í∏àÏï° ÏÖÄ: Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ Ïú†ÏßÄ + Ïà´Ïûê Ìè¨Îß∑ */
                                                                                                .amt { mso-number-format:"\#\,\#\#0"; font-weight: bold; }
                                                                                            </style>
                                                                                        </head>
                                                                                        <body>
                                                                                        <table>
                                                                                    <tr>
                                                                                        <td colspan="6"
                                                                                            style="
                                                                                            font-size:18px;
                                                                                            font-weight:bold;
                                                                                            text-align:center;
                                                                                            padding:12px;
                                                                                            ">
                                                                                        üìä ${curMonth} Í∞ÄÍ≥ÑÎ∂Ä ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏
                                                                                        </td>
                                                                                    </tr>

                                                                                    <tr>
                                                                                        <td>ÎÇ†Ïßú</td>
                                                                                        <td>Íµ¨Î∂Ñ</td>
                                                                                        <td>Í≤∞Ï†úÏàòÎã®</td>
                                                                                        <td>Ïπ¥ÌÖåÍ≥†Î¶¨</td>
                                                                                        <td>ÏÉÅÏÑ∏ Î©îÎ™®</td>
                                                                                        <td>Í∏àÏï°</td>
                                                                                    </tr>`;
                                                                                        const sortedDates = Object.keys(state.dailyHistory).filter(d => d.startsWith(curMonth)).sort();
                                                                                        
                                                                                        if (sortedDates.length === 0) return alert("Ìï¥Îãπ ÏõîÏùò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.");

                                                                                        sortedDates.forEach(date => {
                                                                                            state.dailyHistory[date].forEach(h => {
                                                                                                const isPlus = h.type === 'plus';
                                                                                                const rowClass = isPlus ? 'income' : 'expense';
                                                                                                const methodClass = h.method === 'ÌòÑÍ∏à' ? 'cash-tag' : 'card-tag';
                                                                                                const methodEmoji = h.method === 'ÌòÑÍ∏à' ? 'üíµ' : 'üí≥';
                                                                                                const catEmoji = emojiMap[h.category] || 'üìù';

                                                                                                excelContent += `
                                                                                                <tr class="${rowClass}">
                                                                                                    <td>${date}</td>
                                                                                                    <td><b>${isPlus ? 'ÏàòÏûÖ' : 'ÏßÄÏ∂ú'}</b></td>
                                                                                                    <td class="${methodClass}">${methodEmoji} ${h.method}</td>
                                                                                                    <td>${catEmoji} ${h.category}</td>
                                                                                                    <td>${h.note}</td> <td class="amt">${isPlus ? '' : '-'}${h.amount.toLocaleString()}</td> </tr>`;
                                                                                            });
                                                                                        });

                                                                                        excelContent += `</table></body></html>`;
                                                                                        // ... (Ïù¥Ìïò ÌååÏùº Îã§Ïö¥Î°úÎìú Î°úÏßÅ ÎèôÏùº)

                                                                                            const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                                                                                            const link = document.createElement("a");
                                                                                            link.href = URL.createObjectURL(blob);
                                                                                            link.download = `Í∞ÄÍ≥ÑÎ∂Ä_${curMonth}.xls`;
                                                                                            link.click();
                                                                                        }

                                                                                        // ÌÜµÍ≥Ñ Í∑∏ÎûòÌîÑ
                                                                                        function renderChart() {
                                                                                            const activeDate = document.getElementById('date-picker').value;
                                                                                            const curMonth = activeDate.substring(0, 7);
                                                                                            document.getElementById('chart-month-label').innerText = `${curMonth.split('-')[1]}Ïõî ÏßÄÏ∂ú ÏöîÏïΩ`;
                                                                                            const stats = {}; let totalExpense = 0;
                                                                                            Object.keys(state.dailyHistory).forEach(d => {
                                                                                                if(d.startsWith(curMonth)) {
                                                                                                    state.dailyHistory[d].forEach(h => { if(h.type === 'minus') { stats[h.category] = (stats[h.category] || 0) + h.amount; totalExpense += h.amount; }});
                                                                                                }
                                                                                            });
                                                                                            const chartList = document.getElementById('chart-list');
                                                                                            if(totalExpense === 0) { chartList.innerHTML = ""; document.getElementById('chart-empty').style.display = 'block'; return; }
                                                                                            document.getElementById('chart-empty').style.display = 'none';
                                                                                            const sorted = Object.entries(stats).sort((a, b) => b[1] - a[1]);
                                                                                            const iconMap = {}; categories.minus.forEach(c => iconMap[c.name] = c.icon);
                                                                                            chartList.innerHTML = sorted.map(([cat, amt]) => {
                                                                                                const pct = ((amt / totalExpense) * 100).toFixed(1);
                                                                                                return `<div class="chart-row"><div class="chart-label"><span>${iconMap[cat] || 'üìù'} <b>${cat}</b></span><span>¬•${amt.toLocaleString()} (${pct}%)</span></div><div class="chart-bar-bg"><div class="chart-bar-fill" style="width: ${pct}%"></div></div></div>`;
                                                                                            }).join('');
                                                                                        }

                                                                                        function addFixedItem() {
                                                                                            const name = document.getElementById('fixed-name').value;
                                                                                            const day = document.getElementById('fixed-day').value;
                                                                                            const amt = parseInt(document.getElementById('fixed-amount').value);
                                                                                            if (!name || !day || !amt) return alert("Ï†ïÎ≥¥Î•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                                                                                            state.fixedItems.push({ name, day, amount: amt });
                                                                                            renderFixedList(); updateUI();
                                                                                            document.getElementById('fixed-name').value=""; document.getElementById('fixed-day').value=""; document.getElementById('fixed-amount').value="";
                                                                                        }
                                                                                        function renderFixedList() {
                                                                                            document.getElementById('fixed-list').innerHTML = state.fixedItems.map((item, i) => `<div style="background:var(--bg-color); padding:12px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; border:1px solid var(--border-color); align-items:center;"><div style="font-size:0.85rem;"><b>Îß§Îã¨ ${item.day}Ïùº</b><br>${item.name} (¬•${item.amount.toLocaleString()})</div><button onclick="removeFixed(${i})" style="color:#ff4d4d; background:none; border:none; font-weight:bold;">ÏÇ≠Ï†ú</button></div>`).join('');
                                                                                        }
                                                                                        function removeFixed(i) { if(confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { state.fixedItems.splice(i, 1); renderFixedList(); save(); } }
                                                                                        function switchTab(n, el) {
                                                                                            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
                                                                                            document.querySelectorAll('.nav-item').forEach(v=>v.classList.remove('active'));
                                                                                            document.getElementById('tab-'+n).classList.add('active');
                                                                                            el.classList.add('active');
                                                                                            if(n === 'chart') renderChart();
                                                                                            if(n === 'search') searchHistory();
                                                                                        }
                                                                                        function openModal(t, m) { currentTransaction = { t, m }; document.getElementById('modal-amount-input').value = ""; document.getElementById('modal-note-input').value = ""; selectedCategory = ""; document.getElementById('category-selector').innerHTML = categories[t].map(c => `<button class="cat-btn" style="padding:12px 5px; border:1px solid var(--border-color); border-radius:12px; background:var(--input-bg); color:var(--text-main); font-size:0.8rem; display:flex; flex-direction:column; align-items:center; cursor:pointer;" onclick="selectedCategory='${c.name}'; Array.from(this.parentNode.children).forEach(b=>b.style.borderColor='var(--border-color)'); this.style.borderColor='var(--primary-color)'">${c.icon}<br>${c.name}</button>`).join(''); document.getElementById('modal-overlay').style.display = 'flex'; }
                                                                                        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
                                                                                        function confirmTransaction() { const amt = parseInt(document.getElementById('modal-amount-input').value); if(!amt || !selectedCategory) return alert("Ï†ïÎ≥¥ ÌôïÏù∏!"); if(currentTransaction.m==='cash') state.cash += (currentTransaction.t==='plus'? amt : -amt); else state.card += (currentTransaction.t==='plus'? amt : -amt); const date = document.getElementById('date-picker').value; if(!state.dailyHistory[date]) state.dailyHistory[date] = []; state.dailyHistory[date].unshift({ type: currentTransaction.t, method: currentTransaction.m==='cash'?'ÌòÑÍ∏à':'Ïπ¥Îìú', category: selectedCategory, note: document.getElementById('modal-note-input').value || selectedCategory, amount: amt }); closeModal(); updateUI(); }
                                                                                        function deleteItem(d, i) {
                                                                                        // ÏÇ≠Ï†ú Ï†Ñ Îã§Ïãú Ìïú Î≤à Î¨ºÏñ¥Î≥¥Í∏∞
                                                                                        if (!confirm("Ïù¥ Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                                                                                            return; // 'Ï∑®ÏÜå'Î•º ÎàÑÎ•¥Î©¥ Ìï®Ïàò Ï¢ÖÎ£å
                                                                                        }

                                                                                        const h = state.dailyHistory[d][i];
                                                                                        
                                                                                        // ÏûêÏÇ∞ Î≥µÍµ¨ Î°úÏßÅ
                                                                                        if (h.method === 'ÌòÑÍ∏à') {
                                                                                            state.cash += (h.type === 'plus' ? -h.amount : h.amount);
                                                                                        } else {
                                                                                            state.card += (h.type === 'plus' ? -h.amount : h.amount);
                                                                                        }

                                                                                        // ÎÇ¥Ïó≠ÏóêÏÑú ÏÇ≠Ï†ú
                                                                                        state.dailyHistory[d].splice(i, 1);
                                                                                        
                                                                                        // UI ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ï†ÄÏû•
                                                                                        updateUI();
                                                                                        save();
                                                                                    }
                                                                                        function moveDate(o) { const p = document.getElementById('date-picker'); let d = new Date(p.value); d.setDate(d.getDate()+o); p.value = d.toISOString().split('T')[0]; updateUI(); }
                                                                                        function toggleTheme() { state.isDark = !state.isDark; document.documentElement.setAttribute('data-theme', state.isDark?'dark':'light'); document.getElementById('theme-status').innerText = state.isDark?'ON':'OFF'; save(); }
                                                                                        function searchHistory() {
                                                                                        const q = document.getElementById('search-input').value.toLowerCase();
                                                                                        const res = [];
                                                                                        
                                                                                        Object.keys(state.dailyHistory).forEach(d => {
                                                                                            state.dailyHistory[d].forEach(h => {
                                                                                                if(h.category.toLowerCase().includes(q) || h.note.toLowerCase().includes(q)) {
                                                                                                    res.push({...h, date: d});
                                                                                                }
                                                                                            });
                                                                                        });

                                                                                            // Í≤ÄÏÉâ Í≤∞Í≥º Î†åÎçîÎßÅ Î∂ÄÎ∂ÑÏóêÏÑú Î∞òÎìúÏãú .search-item ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî
                                                                                            document.getElementById('search-results').innerHTML = res.map(h => {
                                                                                                const isCash = h.method === 'ÌòÑÍ∏à';
                                                                                                return `
                                                                                                    <div class="search-item ${isCash ? 'search-cash' : 'search-card'}">
                                                                                                        <div>
                                                                                                            <div style="display:flex; align-items:center; gap:6px;">
                                                                                                                <span class="method-tag ${isCash ? 'tag-cash' : 'tag-card'}">${h.method}</span>
                                                                                                                <small style="opacity:0.5;">${h.date}</small>
                                                                                                            </div>
                                                                                                            <span class="search-cat">${h.category}</span>
                                                                                                            <div style="font-size:0.85rem; opacity:0.6;">${h.note}</div>
                                                                                                        </div>
                                                                                                        <div class="search-amt" style="color:${h.type==='plus'?'#2ecc71':'#e74c3c'}">
                                                                                                            ${h.type==='plus'?'+':'-'}¬•${h.amount.toLocaleString()}
                                                                                                        </div>
                                                                                                    </div>
                                                                                                `;
                                                                                            }).join('');
                                                                                    }
                                                                                        function save() { localStorage.setItem('finalLedger_V41', JSON.stringify(state)); }
                                                                                        init();
                                                                                    </script>
                                                                                    </body>
                                                                                    </html>;
