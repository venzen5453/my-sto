<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì‹¬í”Œ ìŠ¤ë§ˆíŠ¸ ê°€ê³„ë¶€</title>
    
    <link rel="apple-touch-icon" href="./aisa.jpg">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ê°€ê³„ë¶€">

    <style>
        :root {
            --primary-color: #4a90e2; --income-color: #2ecc71; --expense-color: #e74c3c;
            --bg-color: #f8f9fa; --card-bg: #ffffff; --header-bg: #2c3e50;
            --text-main: #2c3e50; --border-color: #e0e0e0;
            --cash-accent: #fcc419; --card-accent: #4dabf7;
            --input-bg: #ffffff; --input-text: #2c3e50;
            --btn-plus-bg: #e8f5e9; --btn-plus-text: #2ecc71;
            --btn-minus-bg: #ffebee; --btn-minus-text: #e74c3c;
        }
        [data-theme='dark'] {
            --bg-color: #121212; --card-bg: #1e1e1e; --header-bg: #000000;
            --text-main: #f5f5f5; --border-color: #333333;
            --input-bg: #2d2d2d; --input-text: #ffffff;
            --btn-plus-bg: #1b3322; --btn-plus-text: #2ecc71;
            --btn-minus-bg: #331b1b; --btn-minus-text: #ff6b6b;
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #333; display: flex; justify-content: center; align-items: center; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .app-container { width: 430px; height: 932px; background: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; transition: 0.3s; }
        .tab-content { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .tab-content.active { display: flex; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { background: var(--header-bg); color: white; padding: 60px 20px 20px 20px; text-align: center; flex-shrink: 0; transition: background 0.3s; }
        .total-amount { font-size: 1.6rem; font-weight: 700; margin: 5px 0; opacity: 0.9; }
        .asset-split { display: flex; justify-content: space-around; gap: 8px; margin-top: 15px; }
        .asset-item { flex: 1; background: rgba(255,255,255,0.07); padding: 12px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .asset-label { font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 4px; }
        .asset-value { font-size: 1.1rem; font-weight: 800; }
        .monthly-summary { display: flex; background: rgba(0,0,0,0.25); border-radius: 12px; margin: 15px 0 5px 0; padding: 12px; font-size: 0.8rem; justify-content: space-around; }
        
        .action-box { padding: 25px 20px; border-bottom: 4px solid var(--border-color); flex-shrink: 0; background: var(--bg-color); }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .button-grid button { padding: 22px 10px; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 1.0rem; }
        .btn-plus { background: var(--btn-plus-bg) !important; color: var(--btn-plus-text) !important; }
        .btn-minus { background: var(--btn-minus-bg) !important; color: var(--btn-minus-text) !important; }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 0 20px; background: var(--bg-color); padding-bottom: 120px; }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë°” (ê³µì¤‘ í”Œë¡œíŒ… ìŠ¤íƒ€ì¼ë¡œ ìœ„ì¹˜ ìƒí–¥) */
        .nav-bar { 
            position: absolute;
            bottom: calc(30px + env(safe-area-inset-bottom)); 
            left: 20px;
            right: 20px;
            height: 75px;
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .nav-item { 
            border: none; background: none; color: #888; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; flex: 1; gap: 2px;
        }
        .nav-item span:first-child { font-size: 1.5rem; }
        .nav-item span:last-child { font-size: 0.7rem; font-weight: 600; }
        .nav-item.active { color: var(--primary-color); }

        /* ê²€ìƒ‰/ì—­ì‚¬ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .history-split-container { display: flex; gap: 10px; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .history-column { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .column-divider { width: 1px; background-color: var(--border-color); }
        .history-mini-item { font-size: 0.8rem; padding: 8px; border-radius: 10px; background: rgba(120, 120, 120, 0.08); }
        
        .search-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 15px 15px 25px; margin-bottom: 10px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
        .search-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .search-cash::before { background-color: #fcc419; }
        .search-card::before { background-color: #4dabf7; }
        .method-tag { font-size: 0.75rem; font-weight: 800; margin-right: 5px; }
        .tag-cash { color: #fcc419; } .tag-card { color: #4dabf7; }
        
        .styled-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--input-text); box-sizing: border-box; outline: none; }
        #modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: var(--card-bg); width: 88%; border-radius: 25px; padding: 25px; box-sizing: border-box; }
        .modal-input { width: 100%; padding: 15px; border: 2px solid var(--primary-color); border-radius: 15px; font-size: 1.8rem; font-weight: bold; text-align: center; margin-bottom: 20px; background: var(--input-bg); color: var(--input-text); outline: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="modal-overlay">
        <div class="modal">
            <div id="modal-type-title" style="font-weight: bold; margin-bottom: 15px; text-align: center; color: var(--primary-color);">ë‚´ì—­ ì…ë ¥</div>
            <input type="number" id="modal-amount-input" class="modal-input" inputmode="numeric" placeholder="0">
            <div id="category-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;"></div>
            <input type="text" id="modal-note-input" class="styled-input" style="margin-bottom:20px;" placeholder="ìƒì„¸ ë©”ëª¨">
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal()" style="flex:1; padding:15px; border:none; background:#666; border-radius:12px; color:white; font-weight:bold;">ì·¨ì†Œ</button>
                <button onclick="confirmTransaction()" style="flex:1; padding:15px; border:none; background:var(--primary-color); color:white; border-radius:12px; font-weight:bold;">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="header">
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:10px;">
                <button onclick="moveDate(-1)" style="background:none; border:none; color:white; font-size:1.2rem;">â—€</button>
                <input type="date" id="date-picker" onchange="updateUI();" style="background:rgba(255,255,255,0.15); border:none; color:white; padding:8px 12px; border-radius:10px; font-size:0.95rem; color-scheme:dark; outline:none;">
                <button onclick="moveDate(1)" style="background:none; border:none; color:white; font-size:1.2rem;">â–¶</button>
            </div>
            <div class="total-amount" id="total-balance">í† íƒˆ Â¥0</div>
            <div class="asset-split">
                <div class="asset-item"><span class="asset-label" style="color:var(--cash-accent)">ì „ì²´ í˜„ê¸ˆ</span><div id="cash-balance" class="asset-value" style="color:var(--cash-accent)">Â¥0</div></div>
                <div class="asset-item"><span class="asset-label" style="color:var(--card-accent)">ì „ì²´ ì¹´ë“œ</span><div id="card-balance" class="asset-value" style="color:var(--card-accent)">Â¥0</div></div>
            </div>
            <div class="monthly-summary">
                <div>ì´ë²ˆë‹¬ ìˆ˜ì… <b id="month-in" style="color:#2ecc71">Â¥0</b></div>
                <div style="width:1px; background:rgba(255,255,255,0.2);"></div>
                <div>ì´ë²ˆë‹¬ ì§€ì¶œ <b id="month-out" style="color:#ff6b6b">Â¥0</b></div>
            </div>
        </div>
        <div class="action-box">
            <div class="button-grid">
                <button class="btn-plus" onclick="openModal('plus', 'cash')">ğŸ’° í˜„ê¸ˆ ì…ê¸ˆ</button>
                <button class="btn-plus" onclick="openModal('plus', 'card')">ğŸ’³ ì¹´ë“œ ì…ê¸ˆ</button>
                <button class="btn-minus" onclick="openModal('minus', 'cash')">ğŸ’¸ í˜„ê¸ˆ ì¶œê¸ˆ</button>
                <button class="btn-minus" onclick="openModal('minus', 'card')">ğŸ›ï¸ ì¹´ë“œ ì¶œê¸ˆ</button>
            </div>
        </div>
        <div class="scroll-area" id="history-list"></div>
    </div>

    <div id="tab-chart" class="tab-content">
        <div class="header">
            <h2 style="margin:0;">ğŸ“Š ì´ë²ˆ ë‹¬ ì§€ì¶œ ë¶„ì„</h2>
            <div id="chart-month-label" style="opacity:0.8; margin-top:5px;"></div>
        </div>
        <div class="scroll-area">
            <div id="chart-list" style="padding: 20px 0;"></div>
            <div id="chart-empty" style="text-align:center; padding:50px; opacity:0.5; display:none;">ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="tab-search" class="tab-content">
        <div class="header">
            <h2 style="margin:0;">ğŸ” ê±°ë˜ ê²€ìƒ‰</h2>
        </div>
        <div style="padding: 20px;"><input type="text" id="search-input" class="styled-input" placeholder="ë¶„ë¥˜ë‚˜ ë©”ëª¨ ê²€ìƒ‰..." onkeyup="searchHistory()"></div>
        <div class="scroll-area" id="search-results"></div>
    </div>

    <div id="tab-more" class="tab-content">
        <div class="header">
            <h2 style="margin:0;">âš™ï¸ ì„¤ì •</h2>
        </div>
        <div class="scroll-area" style="padding-top:20px;">
            <div style="background:var(--card-bg); padding:20px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border-color); margin-bottom:15px;">
                <span>ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</span>
                <button onclick="toggleTheme()" id="theme-status" style="padding:10px 25px; border-radius:20px; border:2px solid var(--primary-color); background:none; color:var(--primary-color); font-weight:bold;">OFF</button>
            </div>
            <button onclick="exportMonthlyExcel()" style="width:100%; padding:18px; border-radius:15px; border:none; background:var(--header-bg); color:white; font-weight:bold; cursor:pointer; margin-bottom:25px;">ğŸ“‚ ì´ë²ˆ ë‹¬ ë‚´ì—­ ì—‘ì…€ë¡œ ì €ì¥</button>
            
            <h4 style="margin:0 0 10px 5px;">ğŸ” ê³ ì • ì§€ì¶œ ì„¤ì •</h4>
            <div style="background:var(--card-bg); padding:18px; border-radius:15px; border:1px solid var(--border-color); margin-bottom:40px;">
                <input type="text" id="fixed-name" class="styled-input" placeholder="í•­ëª© (ì˜ˆ: ì›”ì„¸)" style="margin-bottom:8px;">
                <div style="display:flex; gap:8px; margin-bottom:12px;">
                    <input type="number" id="fixed-day" class="styled-input" placeholder="ë‚ ì§œ(1~31)" style="flex:1;">
                    <input type="number" id="fixed-amount" class="styled-input" placeholder="ê¸ˆì•¡" style="flex:2;">
                </div>
                <button onclick="addFixedItem()" style="width:100%; padding:14px; background:var(--primary-color); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ê³ ì •ì§€ì¶œë¹„ ë“±ë¡í•˜ê¸°</button>
                <div id="fixed-list" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="switchTab('home', this)"><span>ğŸ </span><span>í™ˆ</span></button>
        <button class="nav-item" onclick="switchTab('chart', this)"><span>ğŸ“Š</span><span>í†µê³„</span></button>
        <button class="nav-item" onclick="switchTab('search', this)"><span>ğŸ”</span><span>ê²€ìƒ‰</span></button>
        <button class="nav-item" onclick="switchTab('more', this)"><span>âš™ï¸</span><span>ì„¤ì •</span></button>
    </nav>
</div>

<script>
    const categories = {
        plus: [
            {name:'ì›”ê¸‰', icon:'ğŸ’°'}, {name:'ë³´ë„ˆìŠ¤', icon:'ğŸŠ'}, {name:'ìš©ëˆ', icon:'ğŸ'},
            {name:'ë¶€ìˆ˜ì…', icon:'ğŸ“ˆ'}, {name:'ì´ì›”', icon:'ğŸ”„'}, {name:'í™˜ê¸‰ê¸ˆ', icon:'ğŸª™'},
            {name:'ê¸ˆìœµìˆ˜ìµ', icon:'ğŸ¦'}, {name:'ê¸°íƒ€ì…ê¸ˆ', icon:'â•'}
        ],
        minus: [
            {name:'ì‹ë¹„', icon:'ğŸ”'}, {name:'ì¹´í˜/ê°„ì‹', icon:'â˜•'}, {name:'êµí†µ/ì°¨ëŸ‰', icon:'ğŸšŒ'},
            {name:'ì‡¼í•‘', icon:'ğŸ›ï¸'}, {name:'ì˜ë£Œ/ê±´ê°•', icon:'ğŸ’Š'}, {name:'ë¬¸í™”/ì—¬ê°€', icon:'ğŸ®'},
            {name:'êµìœ¡/ì·¨ë¯¸', icon:'ğŸ“š'}, {name:'ìƒí™œìš©í’ˆ', icon:'ğŸ§»'}, {name:'ê²½ì¡°ì‚¬/ì„ ë¬¼', icon:'ğŸ’Œ'},
            {name:'ì£¼ê±°/í†µì‹ ', icon:'ğŸ '}, {name:'ë³´í—˜/ì„¸ê¸ˆ', icon:'ğŸ“„'}, {name:'ê¸°íƒ€ì§€ì¶œ', icon:'â–'}
        ]
    };

    let state = JSON.parse(localStorage.getItem('finalLedger_V42')) || { cash: 0, card: 0, dailyHistory: {}, isDark: false, fixedItems: [] };
    let currentTransaction = {}, selectedCategory = "";

    function init() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const todayStr = new Date(now.getTime() - offset).toISOString().split('T')[0];
        document.getElementById('date-picker').value = todayStr;
        if(state.isDark) { document.documentElement.setAttribute('data-theme', 'dark'); document.getElementById('theme-status').innerText = 'ON'; }
        updateUI();
        renderFixedList();
    }

    function updateUI() {
        checkAndProcessFixed();
        const activeDate = document.getElementById('date-picker').value;
        const curMonth = activeDate.substring(0, 7);
        
        let dCash = state.cash, dCard = state.card;
        Object.keys(state.dailyHistory).forEach(d => {
            if (d > activeDate) {
                state.dailyHistory[d].forEach(h => {
                    if (h.method === 'í˜„ê¸ˆ') dCash += (h.type === 'plus' ? -h.amount : h.amount);
                    else dCard += (h.type === 'plus' ? -h.amount : h.amount);
                });
            }
        });

        document.getElementById('cash-balance').innerText = "Â¥" + dCash.toLocaleString();
        document.getElementById('card-balance').innerText = "Â¥" + dCard.toLocaleString();
        document.getElementById('total-balance').innerText = "í† íƒˆ Â¥" + (dCash + dCard).toLocaleString();

        let mIn = 0, mOut = 0;
        Object.keys(state.dailyHistory).forEach(d => { 
            if(d.startsWith(curMonth)) state.dailyHistory[d].forEach(h => h.type==='plus'? mIn+=h.amount : mOut+=h.amount); 
        });
        document.getElementById('month-in').innerText = "Â¥" + mIn.toLocaleString();
        document.getElementById('month-out').innerText = "Â¥" + mOut.toLocaleString();

        const dayData = state.dailyHistory[activeDate] || [];
        const historyListEl = document.getElementById('history-list');

        if (dayData.length === 0) {
            historyListEl.innerHTML = '<p style="text-align:center; padding:40px; opacity:0.5;">ê±°ë˜ ì—†ìŒ</p>';
        } else {
            const cashItems = dayData.filter(h => h.method === 'í˜„ê¸ˆ');
            const cardItems = dayData.filter(h => h.method === 'ì¹´ë“œ');
            const renderMiniItem = (h) => `
                <div class="history-mini-item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <span style="font-weight:bold;">${h.category}</span>
                        <button onclick="deleteItem('${activeDate}', ${state.dailyHistory[activeDate].indexOf(h)})" style="color:#e74c3c; background:none; border:none; font-size:0.7rem; cursor:pointer;">ì‚­ì œ</button>
                    </div>
                    <div style="font-size:0.75rem; opacity:0.7; margin:3px 0;">${h.note}</div>
                    <span style="font-weight:800; color:${h.type==='plus'?'#2ecc71':'#e74c3c'}">${h.type==='plus'?'+':'-'}Â¥${h.amount.toLocaleString()}</span>
                </div>`;

            historyListEl.innerHTML = `
                <div style="display:flex; justify-content:space-around; font-size:0.75rem; font-weight:bold; padding:15px 0 5px 0; opacity:0.6;">
                    <span>ğŸ’µ í˜„ê¸ˆ ë‚´ì—­</span><span>ğŸ’³ ì¹´ë“œ ë‚´ì—­</span>
                </div>
                <div class="history-split-container">
                    <div class="history-column">${cashItems.map(h => renderMiniItem(h)).join('')}</div>
                    <div class="column-divider"></div>
                    <div class="history-column">${cardItems.map(h => renderMiniItem(h)).join('')}</div>
                </div>`;
        }
        save();
    }

    function checkAndProcessFixed() {
        const activeDateStr = document.getElementById('date-picker').value; 
        const [year, month, day] = activeDateStr.split('-').map(Number);
        state.fixedItems.forEach(item => {
            const fDay = parseInt(item.day);
            if (fDay <= day) {
                const targetDateStr = `${year}-${String(month).padStart(2, '0')}-${String(fDay).padStart(2, '0')}`;
                if (!state.dailyHistory[targetDateStr]) state.dailyHistory[targetDateStr] = [];
                if (!state.dailyHistory[targetDateStr].some(h => h.note === "[ìë™] " + item.name)) {
                    state.dailyHistory[targetDateStr].unshift({ type: 'minus', method: 'ì¹´ë“œ', category: 'ê³ ì •ë¹„', note: "[ìë™] " + item.name, amount: item.amount });
                    state.card -= item.amount; save();
                }
            }
        });
    }

    function switchTab(n, el) {
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(v=>v.classList.remove('active'));
        document.getElementById('tab-'+n).classList.add('active');
        el.classList.add('active');
        if(n === 'chart') renderChart();
        if(n === 'search') searchHistory();
    }

    function openModal(t, m) { 
        currentTransaction = { t, m }; 
        document.getElementById('modal-amount-input').value = ""; 
        document.getElementById('modal-note-input').value = ""; 
        selectedCategory = ""; 
        document.getElementById('category-selector').innerHTML = categories[t].map(c => `<button style="padding:10px; border:1px solid var(--border-color); border-radius:12px; background:var(--input-bg); color:var(--text-main); font-size:0.8rem; display:flex; flex-direction:column; align-items:center; cursor:pointer;" onclick="selectedCategory='${c.name}'; Array.from(this.parentNode.children).forEach(b=>b.style.borderColor='var(--border-color)'); this.style.borderColor='var(--primary-color)'">${c.icon}<br>${c.name}</button>`).join(''); 
        document.getElementById('modal-overlay').style.display = 'flex'; 
    }
    
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function confirmTransaction() { 
        const amt = parseInt(document.getElementById('modal-amount-input').value); 
        if(!amt || !selectedCategory) return alert("ê¸ˆì•¡ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!"); 
        if(currentTransaction.m==='cash') state.cash += (currentTransaction.t==='plus'? amt : -amt); 
        else state.card += (currentTransaction.t==='plus'? amt : -amt); 
        const date = document.getElementById('date-picker').value; 
        if(!state.dailyHistory[date]) state.dailyHistory[date] = []; 
        state.dailyHistory[date].unshift({ type: currentTransaction.t, method: currentTransaction.m==='cash'?'í˜„ê¸ˆ':'ì¹´ë“œ', category: selectedCategory, note: document.getElementById('modal-note-input').value || selectedCategory, amount: amt }); 
        closeModal(); updateUI(); 
    }

    function deleteItem(d, i) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const h = state.dailyHistory[d][i];
        if (h.method === 'í˜„ê¸ˆ') state.cash += (h.type === 'plus' ? -h.amount : h.amount);
        else state.card += (h.type === 'plus' ? -h.amount : h.amount);
        state.dailyHistory[d].splice(i, 1);
        updateUI(); save();
    }

    function searchHistory() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const res = [];
        Object.keys(state.dailyHistory).forEach(d => {
            state.dailyHistory[d].forEach(h => {
                if(h.category.toLowerCase().includes(q) || h.note.toLowerCase().includes(q)) res.push({...h, date: d});
            });
        });
        document.getElementById('search-results').innerHTML = res.reverse().map(h => `
            <div class="search-item ${h.method === 'í˜„ê¸ˆ' ? 'search-cash' : 'search-card'}">
                <div>
                    <div style="font-size:0.7rem; opacity:0.5; margin-bottom:4px;">${h.date} | <span class="${h.method==='í˜„ê¸ˆ'?'tag-cash':'tag-card'}">${h.method}</span></div>
                    <div style="font-weight:bold; font-size:1.1rem;">${h.category}</div>
                    <div style="font-size:0.85rem; opacity:0.7;">${h.note}</div>
                </div>
                <div style="font-weight:800; font-size:1.1rem; color:${h.type==='plus'?'#2ecc71':'#e74c3c'}">${h.type==='plus'?'+':'-'}Â¥${h.amount.toLocaleString()}</div>
            </div>`).join('');
    }

    function renderChart() {
        const activeDate = document.getElementById('date-picker').value;
        const curMonth = activeDate.substring(0, 7);
        const stats = {}; let total = 0;
        Object.keys(state.dailyHistory).forEach(d => {
            if(d.startsWith(curMonth)) state.dailyHistory[d].forEach(h => { if(h.type === 'minus') { stats[h.category] = (stats[h.category] || 0) + h.amount; total += h.amount; }});
        });
        const list = document.getElementById('chart-list');
        if(total === 0) { list.innerHTML = ""; document.getElementById('chart-empty').style.display = 'block'; return; }
        document.getElementById('chart-empty').style.display = 'none';
        const sorted = Object.entries(stats).sort((a,b)=>b[1]-a[1]);
        list.innerHTML = sorted.map(([cat, amt]) => {
            const pct = ((amt/total)*100).toFixed(1);
            return `<div style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:8px;"><span><b>${cat}</b></span><span>Â¥${amt.toLocaleString()} (${pct}%)</span></div>
                <div style="width:100%; height:12px; background:var(--border-color); border-radius:6px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:var(--expense-color); border-radius:6px;"></div></div>
            </div>`;
        }).join('');
    }

    function moveDate(o) { const p = document.getElementById('date-picker'); let d = new Date(p.value); d.setDate(d.getDate()+o); p.value = d.toISOString().split('T')[0]; updateUI(); }
    function toggleTheme() { state.isDark = !state.isDark; document.documentElement.setAttribute('data-theme', state.isDark?'dark':'light'); document.getElementById('theme-status').innerText = state.isDark?'ON':'OFF'; save(); }
    function save() { localStorage.setItem('finalLedger_V42', JSON.stringify(state)); }
    function addFixedItem() { /* ê³ ì • ì§€ì¶œ ì¶”ê°€ ë¡œì§ ë™ì¼ */ }
    function renderFixedList() { /* ê³ ì • ì§€ì¶œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ë™ì¼ */ }
    
    init();
</script>
</body>
</html>
