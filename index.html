<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>칸지→히라가나 배틀</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--card:#111827;--pri:#22d3ee;--acc:#a78bfa;--ok:#4ade80;--bad:#f87171;--mut:#94a3b8;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,#0b1220,#111827 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .safe{padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    header{position:sticky;top:0;background:rgba(17,24,39,.8);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937}
    .wrap{min-height:100dvh;display:flex;flex-direction:column}
    .container{max-width:900px;margin:0 auto;padding:12px 16px}
    .row{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .stat{display:flex;gap:10px;margin-left:auto;font-variant-numeric:tabular-nums}
    .tag{padding:6px 10px;border:1px solid #1f2937;border-radius:999px;background:#0b1220}
    main{flex:1;display:grid;place-items:center;padding:16px}
    .board{width:min(900px,96vw);background:rgba(2,6,23,.6);border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);padding:16px}
    .hpbar{height:12px;background:#1f2937;border-radius:999px;overflow:hidden}
    .hp{height:100%;background:linear-gradient(90deg,var(--ok),#22c55e);width:100%}
    .hp.enemy{background:linear-gradient(90deg,#f59e0b,#ef4444)}
    .bars{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .labels{display:flex;justify-content:space-between;font-size:12px;color:var(--mut);margin-top:4px}
    .card{margin:14px 0;background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:18px;display:grid;gap:16px}
    .kanji{font-size:56px;text-align:center;letter-spacing:.03em}
    .hint{font-size:12px;color:var(--mut);text-align:center}
    .io{display:grid;gap:10px}
    .io .row{align-items:stretch}
    input[type=text]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:var(--text);font-size:16px}
    button{padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:linear-gradient(180deg,#0ea5e9,#0891b2);color:white;font-weight:700;cursor:pointer}
    button.ghost{background:#0b1220;color:#cbd5e1}
    .msg{min-height:26px;text-align:center}
    .good{color:var(--ok)} .bad{color:var(--bad)} .info{color:var(--pri)}
    .small{font-size:12px;color:var(--mut)}
    footer{padding:16px 0;color:#94a3b8}
    .kbd{display:inline-block;border:1px solid #334155;border-radius:8px;padding:2px 6px;background:#0b1220;color:#cbd5e1}
  </style>
</head>
<body class="safe">
  <div class="wrap">
    <header>
      <div class="container row">
        <h1>漢字 → ひらがな BATTLE</h1>
        <div class="stat">
          <div class="tag">Stage <span id="stage">1</span></div>
          <div class="tag">Combo <span id="combo">0</span></div>
          <div class="tag">Score <span id="score">0</span></div>
        </div>
      </div>
    </header>

    <main>
      <div class="board container">
        <div class="bars">
          <div>
            <div class="labels"><span>YOU</span><span id="pTxt">100 / 100</span></div>
            <div class="hpbar"><div id="pHP" class="hp"></div></div>
          </div>
          <div>
            <div class="labels"><span>ENEMY</span><span id="eTxt">100 / 100</span></div>
            <div class="hpbar"><div id="eHP" class="hp enemy"></div></div>
          </div>
        </div>

        <div class="card">
          <div class="kanji" id="q">準備中…</div>
          <div class="hint"><span id="hint" class="small">힌트: 첫 글자 보기</span></div>

          <div class="io">
            <div class="row">
              <input id="ans" type="text" placeholder="ひらがな 또는 romaji 입력 (예: gakkou → がっこう)" autocomplete="off" inputmode="lowercase">
              <button id="attack">공격 (Enter)</button>
            </div>
            <div class="row">
              <button id="skip" class="ghost">스킵</button>
              <button id="give" class="ghost">정답 보기</button>
              <label class="small"><input type="checkbox" id="romaji" checked> romaji 자동 변환</label>
            </div>
          </div>

          <div id="msg" class="msg info">정답을 입력해 적을 공격하세요!</div>
        </div>

        <div class="small">iPhone 팁: 사파리 **일반 탭**에서 사용(프라이빗 탭은 저장이 제한될 수 있음). 주소는 항상 같은 <span class="kbd">http://(PC_IP):5173</span>로 접속하세요.</div>
      </div>
    </main>

    <footer>
      <div class="container small">단어 데이터는 학습용 간단 셋입니다(다의/음독·훈독 충돌은 안전한 표기로 구성). 필요하면 더 추가해 드릴게요!</div>
    </footer>
  </div>

  <script>
  // ---------- 문제 데이터(간단 셋) ----------
  const BANK = [
    {k:"水", y:["みず"]},{k:"火",y:["ひ"]},{k:"木",y:["き"]},{k:"山",y:["やま"]},{k:"川",y:["かわ"]},
    {k:"田",y:["た"]},{k:"空",y:["そら"]},{k:"雨",y:["あめ"]},{k:"雪",y:["ゆき"]},{k:"風",y:["かぜ"]},
    {k:"花",y:["はな"]},{k:"犬",y:["いぬ"]},{k:"猫",y:["ねこ"]},{k:"魚",y:["さかな"]},{k:"鳥",y:["とり"]},
    {k:"月",y:["つき"]},{k:"星",y:["ほし"]},{k:"石",y:["いし"]},{k:"竹",y:["たけ"]},{k:"森",y:["もり"]},
    {k:"林",y:["はやし"]},{k:"虫",y:["むし"]},{k:"貝",y:["かい"]},{k:"糸",y:["いと"]},{k:"米",y:["こめ"]},
    {k:"肉",y:["にく"]},{k:"茶",y:["ちゃ"]},{k:"酒",y:["さけ"]},{k:"道",y:["みち"]},{k:"右",y:["みぎ"]},
    {k:"左",y:["ひだり"]},{k:"上",y:["うえ"]},{k:"下",y:["した"]},{k:"前",y:["まえ"]},{k:"後ろ",y:["うしろ"]},
    {k:"外",y:["そと"]},{k:"中",y:["なか"]},{k:"学校",y:["がっこう"]},{k:"電車",y:["でんしゃ"]},{k:"駅",y:["えき"]},
    {k:"会社",y:["かいしゃ"]},{k:"病院",y:["びょういん"]},{k:"部屋",y:["へや"]},{k:"東京",y:["とうきょう"]},{k:"京都",y:["きょうと"]},
    {k:"大阪",y:["おおさか"]},{k:"日本",y:["にほん","にっぽん"]},{k:"今日",y:["きょう"]},{k:"明日",y:["あした"]},{k:"昨日",y:["きのう"]}
  ];

  // ---------- 간단 상태 ----------
  let stage = 1, score = 0, combo = 0;
  let pMax = 100, eMax = 100, p = pMax, e = eMax;
  let current = null;
  const hist = new Set(); // 최근 중복 방지(간단)

  // ---------- DOM ----------
  const el = sel => document.querySelector(sel);
  const qEl = el("#q"), ansEl = el("#ans"), msgEl = el("#msg"), hintEl = el("#hint");
  const pHP = el("#pHP"), eHP = el("#eHP"), pTxt = el("#pTxt"), eTxt = el("#eTxt");
  const sStage = el("#stage"), sScore = el("#score"), sCombo = el("#combo");
  const btnAtk = el("#attack"), btnSkip = el("#skip"), btnGive = el("#give"), chkRomaji = el("#romaji");

  // ---------- 유틸: 표시 ----------
  function setHP(dom, cur, max){ const pct = Math.max(0, Math.min(100, cur/max*100)); dom.style.width = pct+"%"; }
  function refreshHUD(){
    setHP(pHP, p, pMax); setHP(eHP, e, eMax);
    pTxt.textContent = `${p} / ${pMax}`; eTxt.textContent = `${e} / ${eMax}`;
    sStage.textContent = stage; sScore.textContent = score; sCombo.textContent = combo;
  }

  // ---------- 유틸: 히라가나 변환 ----------
  const KATA_OFFSET = 0x60;
  function kata2hira(s){
    return s.replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - KATA_OFFSET));
  }
  function toHiragana(input){
    let s = (input||"").trim().toLowerCase();
    // 이미 카타카나 → 히라가나
    s = kata2hira(s);
    // 히라가나면 패스
    if(/[ぁ-ゖ]/.test(s)) return s;

    // romaji → hiragana (간단/교육용, 주요 패턴 지원)
    // 1) 쌍자음(っ) 처리
    s = s.replace(/([bcdfghjklmnpqrstvwxyz])\1/g, "っ$1");
    // 2) 특수/장음
    s = s.replace(/ltsu|xtsu/g,"っ").replace(/nn/g,"ん");
    // 3) 맵
    const map = {
      kya:"きゃ", kyu:"きゅ", kyo:"きょ",
      gya:"ぎゃ", gyu:"ぎゅ", gyo:"ぎょ",
      sha:"しゃ", shu:"しゅ", sho:"しょ",
      sya:"しゃ", syu:"しゅ", syo:"しょ",
      cha:"ちゃ", chu:"ちゅ", cho:"ちょ",
      tya:"ちゃ", tyu:"ちゅ", tyo:"ちょ",
      nya:"にゃ", nyu:"にゅ", nyo:"にょ",
      hya:"ひゃ", hyu:"ひゅ", hyo:"ひょ",
      mya:"みゃ", myu:"みゅ", myo:"みょ",
      rya:"りゃ", ryu:"りゅ", ryo:"りょ",
      bya:"びゃ", byu:"びゅ", byo:"びょ",
      pya:"ぴゃ", pyu:"ぴゅ", pyo:"ぴょ",
      ja:"じゃ", ju:"じゅ", jo:"じょ", jya:"じゃ", jyu:"じゅ", jyo:"じょ",

      shi:"し", chi:"ち", tsu:"つ", fu:"ふ", ji:"じ", dji:"ぢ", dzu:"づ",

      a:"あ", i:"い", u:"う", e:"え", o:"お",
      ka:"か", ki:"き", ku:"く", ke:"け", ko:"こ",
      ga:"が", gi:"ぎ", gu:"ぐ", ge:"げ", go:"ご",
      sa:"さ", si:"し", su:"す", se:"せ", so:"そ",
      za:"ざ", zi:"じ", zu:"ず", ze:"ぜ", zo:"ぞ",
      ta:"た", ti:"ち", tu:"つ", te:"て", to:"と",
      da:"だ", di:"ぢ", du:"づ", de:"で", do:"ど",
      na:"な", ni:"に", nu:"ぬ", ne:"ね", no:"の",
      ha:"は", hi:"ひ", hu:"ふ", he:"へ", ho:"ほ",
      ba:"ば", bi:"び", bu:"ぶ", be:"べ", bo:"ぼ",
      pa:"ぱ", pi:"ぴ", pu:"ぷ", pe:"ぺ", po:"ぽ",
      ma:"ま", mi:"み", mu:"む", me:"め", mo:"も",
      ya:"や", yu:"ゆ", yo:"よ",
      ra:"ら", ri:"り", ru:"る", re:"れ", ro:"ろ",
      wa:"わ", wi:"うぃ", we:"うぇ", wo:"を",
      n:"ん"
    };

    // 긴 순서(3글자→2글자→1글자)로 치환
    let out = "";
    for(let i=0;i<s.length;){
      // 3
      let tri = s.slice(i,i+3);
      if(map[tri]){ out += map[tri]; i+=3; continue; }
      // 2
      let bi = s.slice(i,i+2);
      if(map[bi]){ out += map[bi]; i+=2; continue; }
      // 1: 모음/자음
      let one = s[i];
      if(map[one]){ out += map[one]; i+=1; continue; }
      // 기타(공백/기호)는 넘김
      i++;
    }
    // n 처리(끝에 남은 단독 n)
    out = out.replace(/んあ/g,"な").replace(/んい/g,"に").replace(/んう/g,"ぬ").replace(/んえ/g,"ね").replace(/んお/g,"の");
    return out;
  }

  // ---------- 게임 로직 ----------
  function next(){
    // 문제 선택(최근 중복 줄이기)
    let cand;
    for(let tries=0; tries<10; tries++){
      cand = BANK[Math.floor(Math.random()*BANK.length)];
      if(!hist.has(cand.k)) break;
    }
    hist.add(cand.k); if(hist.size>10){ hist.clear(); hist.add(cand.k); }
    current = cand;
    qEl.textContent = cand.k;
    hintEl.textContent = "힌트: " + cand.y[0].slice(0,1) + "…";
    ansEl.value = ""; ansEl.focus();
    msg("정답을 입력해 공격!", "info");
  }

  function normalizeKana(s){
    return kata2hira((s||"").trim().toLowerCase());
  }

  function check(){
    let raw = ansEl.value;
    if(!raw.trim()) return;
    const ans = chkRomaji.checked ? toHiragana(raw) : normalizeKana(raw);
    // 정답 목록과 매칭
    const ok = current.y.some(y => normalizeKana(y) === ans);
    if(ok){
      const dmg = 12 + Math.floor(current.y[0].length*3) + combo*2;
      e = Math.max(0, e - dmg); combo++; score += (10 + dmg);
      msg(`正解! 「${current.y[0]}」  → ${dmg} 데미지!`, "good");
      shake(eHP.parentElement); pop(eHP.parentElement, "-"+dmg);
      if(e<=0){ win(); } else { next(); }
    }else{
      const dmg = 10;
      p = Math.max(0, p - dmg); combo = 0;
      msg(`Miss… 정답은 「${current.y[0]}」`, "bad");
      shake(pHP.parentElement); pop(pHP.parentElement, "-"+dmg);
      if(p<=0){ lose(); } else { next(); }
    }
    refreshHUD();
  }

  function win(){
    msg("ENEMY DOWN! 다음 스테이지!", "good");
    stage++; eMax += 20; p = Math.min(pMax, p+15); // 소량 회복
    e = eMax;
  }
  function lose(){
    msg("YOU DIED… 스코어가 초기화됩니다.", "bad");
    stage = 1; score = 0; combo = 0;
    pMax = 100; eMax = 100; p = pMax; e = eMax;
  }

  function msg(t, cls){ msgEl.className="msg "+(cls||""); msgEl.textContent=t; }

  function shake(elm){
    elm.animate([{transform:"translateX(0)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0)"}],{duration:250});
  }
  function pop(elm, text){
    const b=document.createElement("div");
    b.textContent=text;
    Object.assign(b.style,{position:"absolute",color:"#fff",fontWeight:"700",left:"50%",transform:"translateX(-50%)",top:"-8px",textShadow:"0 2px 8px rgba(0,0,0,.6)"});
    const box=elm.getBoundingClientRect();
    const holder=document.createElement("div");
    Object.assign(holder.style,{position:"relative",width:box.width+"px",height:"0"});
    elm.parentElement.appendChild(holder); holder.appendChild(b);
    b.animate([{opacity:1,transform:"translate(-50%,0)"},{opacity:0,transform:"translate(-50%,-28px)"}],{duration:700});
    setTimeout(()=>holder.remove(),700);
  }

  // ---------- 이벤트 ----------
  btnAtk.addEventListener("click", check);
  ansEl.addEventListener("keydown", e=>{ if(e.key==="Enter"){ check(); }});
  btnSkip.addEventListener("click", ()=>{ combo=0; msg("스킵!", "info"); next(); refreshHUD(); });
  btnGive.addEventListener("click", ()=>{ msg(`정답: 「${current.y.join(" / ")}」`, "info"); });

  // 시작
  refreshHUD(); next();
  </script>
</body>
</html>
