<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>è£æ‹ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼‹ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<style>
:root{
  --bg:#f7fbff; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e5eaf1;
  --primary:#2563eb; --accent:#22c55e; --accent2:#0ea5e9; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:linear-gradient(160deg,#f7fbff,#ffffff 40%,#f3f8ff);
  color:var(--text);padding:20px;
}
.wrap{width:min(1080px,94vw);margin:0 auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;
  box-shadow:0 10px 30px rgba(15,23,42,.08);padding:22px}
.panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
.row{display:flex;align-items:center;gap:12px;margin:12px 0}
input[type="range"]{width:100%}
input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
button{padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-secondary{background:#e9edf3;border:1px solid #dbe2ea}
.kbd{background:#eef2ff;border:1px solid #c7d2fe;padding:4px 7px;border-radius:8px}
.meter{height:12px;border-radius:8px;background:#eef2f7;overflow:hidden;
  border:1px solid var(--line)}
.bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),#34d399,#86efac);
  transition:width .08s ease}
#pulse{
  width:42px;height:42px;border-radius:50%;
  background:#2563eb;margin:12px auto;opacity:.4;
  transition:transform .12s, opacity .12s;
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>è£æ‹ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>

<div class="panel">
  <div class="row">
    <label>BPM</label>
    <input id="bpm" type="range" min="30" max="240" value="100">
    <input id="bpmNum" type="number" min="30" max="240" value="100">
  </div>

  <div class="row">
    <label>æ‹å­ï¼ˆåˆ†å­ï¼‰</label>
    <input id="beats" type="range" min="1" max="12" value="4">
    <input id="beatsNum" type="number" min="1" max="12" value="4">
  </div>

  <div class="row">
    <label>éŸ³é‡</label>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7">
    <input id="volNum" type="number" min="0" max="1" step="0.01" value="0.7">
  </div>

  <div class="row">
    <label>ç´°åˆ†åŒ–</label>
    <select id="subdiv">
      <option value="1">ãªã—</option>
      <option value="2">8åˆ†ï¼ˆ2åˆ†å‰²ï¼‰</option>
      <option value="3">3é€£ç¬¦</option>
      <option value="4">16åˆ†ï¼ˆ4åˆ†å‰²ï¼‰</option>
    </select>
  </div>

  <div class="row">
    <input id="swingToggle" type="checkbox">
    <label for="swingToggle">ã‚¹ã‚¦ã‚£ãƒ³ã‚°ï¼ˆShuffleï¼‰</label>
  </div>

  <div class="row">
    <input id="offbeatToggle" type="checkbox" checked>
    <label>è£æ‹ã‚’é³´ã‚‰ã™</label>
  </div>

  <div class="row">
    <input id="autoBpm" type="checkbox">
    <label>è‡ªå‹•ãƒ†ãƒ³ãƒä¸Šæ˜‡</label>
    <input id="autoStep" type="number" value="2" min="1" max="20" style="width:60px">
    <span>BPMã”ã¨</span>
  </div>

  <div class="row">
    <label>ç·´ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³</label>
    <select id="sessionTimer">
      <option value="0">ãªã—</option>
      <option value="60">1åˆ†</option>
      <option value="180">3åˆ†</option>
      <option value="300">5åˆ†</option>
    </select>
  </div>

  <button id="playToggle" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button id="panicBtn" class="btn-danger">â–  åœæ­¢</button>

  <div id="pulse"></div>

  <div class="row">
    <label>é€²è¡Œ</label>
    <div class="meter" style="flex:1"><div id="bar" class="bar"></div></div>
    <span id="beatNow" class="kbd">â€“</span>
  </div>

  <div class="center" style="text-align:center;margin-top:10px">
    <div id="offbeatLamp" style="
      width:22px;height:22px;border-radius:50%;background:#ccc;
      box-shadow:0 0 8px rgba(0,0,0,0.15);transition:.1s;">
    </div>
    <div style="margin-left:8px;color:#64748b">è£æ‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼</div>
  </div>

</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="panel" style="margin-top:30px;text-align:center">
<h2>ğŸ® ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ </h2>

<div id="game" style="
  position:relative;width:400px;height:600px;margin:0 auto;
  background:#222;border:3px solid #555;overflow:hidden;border-radius:20px">
</div>

<div id="scoreLabel" style="font-size:20px;font-weight:bold;margin:12px 0">Score: 0</div>

<button id="gameStart" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

</div>

</div>
</div>

<script>
let ctx, gain;
function audioInit(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  gain = ctx.createGain();
  gain.gain.value = parseFloat(vol.value);
  gain.connect(ctx.destination);
}
function clickSound(time,accent=false){
  const osc = ctx.createOscillator();
  const g = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = accent?1760:1320;
  g.gain.setValueAtTime(accent?.8:.5,time);
  g.gain.exponentialRampToValueAtTime(.001,time+.05);
  osc.connect(g);g.connect(gain);
  osc.start(time); osc.stop(time+.06);
}
function offbeatSound(time){
  const osc = ctx.createOscillator();
  const g = ctx.createGain();
  osc.type='square';osc.frequency.value=880;
  g.gain.setValueAtTime(.5,time);
  g.gain.exponentialRampToValueAtTime(.001,time+.05);
  osc.connect(g);g.connect(gain);
  osc.start(time);osc.stop(time+.06);
}
function flashLamp(time){
  const t=(time-ctx.currentTime)*1000;
  setTimeout(()=>{
    offbeatLamp.style.background='#22c55e';
    offbeatLamp.style.boxShadow='0 0 14px #22c55e';
    setTimeout(()=>{
      offbeatLamp.style.background='#ccc';
      offbeatLamp.style.boxShadow='0 0 6px rgba(0,0,0,.15)';
    },120);
  },t);
}

function pulseBeat(time){
  const t=(time-ctx.currentTime)*1000;
  setTimeout(()=>{
    pulse.style.transform='scale(1.5)';
    pulse.style.opacity='1';
    setTimeout(()=>{
      pulse.style.transform='scale(1)';
      pulse.style.opacity='.4';
    },140);
  },t);
}

const bpm=document.getElementById('bpm');
const bpmNum=document.getElementById('bpmNum');
[bpm,bpmNum].forEach(el=>el.addEventListener("input",()=>{
  bpm.value=bpmNum.value=el.value;
}));

const beats=document.getElementById('beats');
const beatsNum=document.getElementById('beatsNum');
[beats,beatsNum].forEach(el=>el.addEventListener("input",()=>{
  beats.value=beatsNum.value=el.value;
}));
vol.addEventListener("input",()=>gain&&(gain.gain.value=parseFloat(vol.value)));
volNum.addEventListener("input",()=>gain&&(gain.gain.value=parseFloat(volNum.value)));

let running=false,nextNote=0,beatIdx=0,timer;
let sessionLeft=0,sessionInterval;

function schedule(){
  const bp=parseFloat(bpm.value);
  const spb=60/bp;
  while(running && nextNote < ctx.currentTime+.15){
    clickSound(nextNote,beatIdx===0);
    pulseBeat(nextNote);

    const sub=parseInt(subdiv.value);
    if(sub>1){
      const base=spb/sub;
      for(let i=1;i<sub;i++){
        let ss=nextNote+base*i;
        clickSound(ss,false);
      }
    }

    if(swingToggle.checked && parseInt(subdiv.value)===2){
      const long=spb*.66;
      const short=spb*.34;
      clickSound(nextNote+long,false);
    }

    if(offbeatToggle.checked){
      const half=spb/2;
      offbeatSound(nextNote+half);
      flashLamp(nextNote+half);
    }

    uiUpdate(nextNote,beatIdx);
    beatIdx=(beatIdx+1)%parseInt(beats.value);
    nextNote+=spb;

    if(autoBpm.checked && beatIdx===0){
      bpm.value=Number(bpm.value)+Number(autoStep.value);
      bpmNum.value=bpm.value;
    }
  }
  timer=setTimeout(schedule,25);
}
function uiUpdate(t,i){
  const d=(t-ctx.currentTime)*1000;
  setTimeout(()=>{
    beatNow.textContent=i+1;
    const pct=((i+1)/beats.value)*100;
    bar.style.width=pct+"%";
    if(pct>=99) setTimeout(()=>bar.style.width='0%',80);
  },d);
}
function start(){
  audioInit();
  if(ctx.state==='suspended') ctx.resume();
  running=true;
  beatIdx=parseInt(beats.value)-1;
  nextNote=ctx.currentTime+.1;
  schedule();
  playToggle.textContent="â–  ã‚¹ãƒˆãƒƒãƒ—";

  sessionLeft=parseInt(sessionTimer.value);
  if(sessionLeft>0){
    sessionInterval=setInterval(()=>{
      sessionLeft--;
      if(sessionLeft<=0){
        stop();
        clearInterval(sessionInterval);
      }
    },1000);
  }
}
function stop(){
  running=false;
  clearTimeout(timer);
  beatNow.textContent='â€“';
  bar.style.width='0%';
  playToggle.textContent="â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ";
}
function panic(){
  stop();
  if(ctx){ctx.close();ctx=null;gain=null;}
}

playToggle.onclick=()=>running?stop():start();
panicBtn.onclick=panic;

function save(){
  localStorage.setItem("mset",JSON.stringify({
    bpm:bpm.value,beats:beats.value,vol:vol.value,
    subdiv:subdiv.value,swing:swingToggle.checked,
    off:offbeatToggle.checked
  }));
}
[bpm,beats,vol,subdiv,swingToggle,offbeatToggle].forEach(e=>e.addEventListener("change",save));

const S=JSON.parse(localStorage.getItem("mset")||"null");
if(S){
  bpm.value=bpmNum.value=S.bpm;
  beats.value=beatsNum.value=S.beats;
  vol.value=volNum.value=S.vol;
  subdiv.value=S.subdiv;
  swingToggle.checked=S.swing;
  offbeatToggle.checked=S.off;
}

/* â˜…â˜…â˜… Rhythm Game â˜…â˜…â˜… */
const game=document.getElementById("game");
const scoreLabel=document.getElementById("scoreLabel");
const gameStart=document.getElementById("gameStart");

let notes=[],gRun=false,gScore=0,genTimer,moveTimer;

function genNote(){
  const n=document.createElement('div');
  Object.assign(n.style,{
    position:'absolute',left:'180px',width:'40px',height:'20px',
    background:'#00ffea',borderRadius:'5px',top:'0px'
  });
  game.appendChild(n);notes.push(n);
}
function moveNotes(){
  for(let i=0;i<notes.length;i++){
    let n=notes[i];
    let t=parseInt(n.style.top);
    n.style.top=(t+5)+'px';
    if(t>600){n.remove();notes.splice(i,1);i--;}
  }
}
function hit(){
  for(let i=0;i<notes.length;i++){
    let n=notes[i];
    let t=parseInt(n.style.top);
    if(t>470 && t<530){
      gScore+=100;
      scoreLabel.textContent="Score: "+gScore;
      n.remove();notes.splice(i,1);
      break;
    }
  }
}
document.addEventListener("keydown",e=>{
  if(e.code==="Space" && gRun)hit();
});
gameStart.onclick=()=>{
  if(!gRun){
    gRun=true;gScore=0;scoreLabel.textContent="Score: 0";
    gameStart.textContent='â–  ã‚¹ãƒˆãƒƒãƒ—';
    genTimer=setInterval(genNote,900);
    moveTimer=setInterval(moveNotes,30);
  }else{
    gRun=false;
    clearInterval(genTimer);clearInterval(moveTimer);
    notes.forEach(n=>n.remove());notes=[];
    gameStart.textContent='â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ';
  }
};
</script>
</body>
</html>
