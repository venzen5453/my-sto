<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>„Ç¶„Çß„Éñ„Éª„É°„Éà„É≠„Éé„Éº„É†ÔºàË£èÊãçÔºã„ÇÆ„Çø„Éº„Éà„É¨„Éº„Éä„ÉºÔºã„É™„Ç∫„É†„Ç≤„Éº„É†Ôºâ</title>
  <style>
    :root{
      --bg:#f7fbff; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e5eaf1;
      --primary:#2563eb; --secondary:#64748b; --accent:#22c55e; --accent2:#0ea5e9; --danger:#ef4444;
      --kbd-bg:#eef2ff; --kbd-bd:#c7d2fe; --chip:#e9f7ff;
    }
    *{box-sizing:border-box}
    html,body{height:auto;min-height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#f7fbff,#ffffff 40%,#f3f8ff);color:var(--text);display:block;padding:20px 10px;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
    .wrap{width:min(1100px,94vw);margin:0 auto;padding:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.08);padding:22px}
    h1{font-size:clamp(20px,3.2vw,28px);margin:0 0 6px}
    p.sub{margin:0 0 16px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.25fr 1fr;gap:18px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;align-items:center;gap:12px;margin:12px 0}
    label{min-width:120px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
    .inline-help{font-size:12px;color:#64748b}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--kbd-bg);border:1px solid var(--kbd-bd);padding:5px 7px;border-radius:8px}
    .tog{display:flex;align-items:center;gap:10px}
    .meter{height:12px;border-radius:8px;background:#eef2f7;overflow:hidden;border:1px solid var(--line)}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),#34d399,#86efac);transition:width .08s ease}
    button{appearance:none;border:1px solid transparent;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#e9edf3;color:#0f172a;border-color:#dbe2ea}
    .btn-ghost{background:#f4f8ff;color:#0f172a;border-color:#dbe2ea}
    .btn-danger{background:var(--danger);color:#fff}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>„Ç¶„Çß„Éñ„Éª„É°„Éà„É≠„Éé„Éº„É† <span class="chip">Ë£èÊãç„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº‰ªò„Åç</span></h1>

      <div class="panel">
        <div class="row nowrap">
          <label for="bpm">„ÉÜ„É≥„ÉùÔºàBPMÔºâ</label>
          <input id="bpm" type="range" min="30" max="240" value="100">
          <input id="bpmNum" type="number" min="30" max="240" value="100">
        </div>
        <div class="row nowrap">
          <label for="beats">ÊãçÂ≠êÔºàÂàÜÂ≠êÔºâ</label>
          <input id="beats" type="range" min="1" max="12" value="4">
          <input id="beatsNum" type="number" min="1" max="12" value="4">
        </div>
        <div class="row nowrap">
          <label for="vol">Èü≥Èáè</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7">
          <input id="volNum" type="number" min="0" max="1" step="0.01" value="0.7">
        </div>
        <div class="row tog"><input id="offbeatToggle" type="checkbox" checked><label for="offbeatToggle">Ë£èÊãç„ÇíÈ≥¥„Çâ„Åô</label></div>
        <button id="playToggle" class="btn-primary">‚ñ∂ „Çπ„Çø„Éº„Éà</button>
        <button id="panicBtn" class="btn-danger">‚ñ† ÂÅúÊ≠¢</button>

        <div class="row" style="margin-top:10px">
          <label>ÈÄ≤Ë°å</label>
          <div class="meter" style="flex:1"><div id="bar" class="bar"></div></div>
          <span id="beatNow" class="kbd">‚Äì</span>
        </div>

        <!-- üëá Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂ÑÔºöË£èÊãç„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div class="center" style="margin-top:8px;">
          <div id="offbeatLamp" style="
            width:20px;
            height:20px;
            border-radius:50%;
            background:#ccc;
            box-shadow:0 0 8px rgba(0,0,0,0.1);
            transition:background 0.1s, box-shadow 0.1s;">
          </div>
          <span class="inline-help" style="margin-left:8px;">Ë£èÊãç„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let ctx, masterGain;
    function ensureAudio(){
      if(ctx) return;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = ctx.createGain();
      masterGain.gain.value = parseFloat(vol.value);
      masterGain.connect(ctx.destination);
    }

    function clickSound(time, accent=false){
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = accent ? 1760 : 1320;
      g.gain.setValueAtTime(accent ? 0.8 : 0.5, time);
      g.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
      osc.connect(g); g.connect(masterGain);
      osc.start(time); osc.stop(time + 0.06);
    }

    function offbeatSound(time){
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'square';
      osc.frequency.value = 880;
      g.gain.setValueAtTime(0.5, time);
      g.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
      osc.connect(g); g.connect(masterGain);
      osc.start(time); osc.stop(time + 0.06);
    }

    // üí°Ë£èÊãç„É©„É≥„ÉóÁÇπÁÅØ Ìï®Ïàò
    function flashOffbeatLamp(time) {
      const delay = Math.max(0, (time - ctx.currentTime) * 1000);
      setTimeout(() => {
        offbeatLamp.style.background = '#22c55e';
        offbeatLamp.style.boxShadow = '0 0 16px #22c55e';
        setTimeout(() => {
          offbeatLamp.style.background = '#ccc';
          offbeatLamp.style.boxShadow = '0 0 8px rgba(0,0,0,0.1)';
        }, 150);
      }, delay);
    }

    const bpm = document.getElementById('bpm');
    const bpmNum = document.getElementById('bpmNum');
    const beats = document.getElementById('beats');
    const beatsNum = document.getElementById('beatsNum');
    const vol = document.getElementById('vol');
    const volNum = document.getElementById('volNum');
    const playToggle = document.getElementById('playToggle');
    const panicBtn = document.getElementById('panicBtn');
    const offbeatLamp = document.getElementById('offbeatLamp');
    const offbeatToggle = document.getElementById('offbeatToggle');
    const beatNow = document.getElementById('beatNow');
    const bar = document.getElementById('bar');

    let running = false, nextNoteTime = 0, beatIdx = 0, timerID;

    function nextNote(){
      const spb = 60 / Number(bpm.value);
      nextNoteTime += spb;
      beatIdx = (beatIdx + 1) % Number(beats.value);
    }

    function schedule(){
      while (running && nextNoteTime < ctx.currentTime + 0.15){
        clickSound(nextNoteTime, beatIdx===0);
        if (offbeatToggle.checked){
          const half = (60 / Number(bpm.value)) / 2;
          offbeatSound(nextNoteTime + half);
          flashOffbeatLamp(nextNoteTime + half); // ‚ú®Ë£èÊãç„Çø„Ç§„Éü„É≥„Ç∞„Å´ÂÖâ„ÇãÔºÅ
        }
        queueBeatUI(nextNoteTime, beatIdx);
        nextNote();
      }
      timerID = setTimeout(schedule, 25);
    }

    function queueBeatUI(time, idx){
      const delay = Math.max(0, (time - ctx.currentTime)*1000);
      setTimeout(()=>{
        beatNow.textContent = idx+1;
        const pct = ((idx+1)/Number(beats.value))*100;
        bar.style.width = pct + '%';
        if(pct>=99) setTimeout(()=> bar.style.width='0%', 60);
      }, delay);
    }

    function start(){
      ensureAudio();
      if (ctx.state === 'suspended') ctx.resume();
      if (running) return;
      running = true;
      beatIdx = Number(beats.value)-1;
      nextNoteTime = ctx.currentTime + 0.1;
      schedule();
      playToggle.textContent = '‚ñ† „Çπ„Éà„ÉÉ„Éó';
    }

    function stop(){
      running = false;
      clearTimeout(timerID);
      beatNow.textContent = '‚Äì';
      bar.style.width = '0%';
      playToggle.textContent = '‚ñ∂ „Çπ„Çø„Éº„Éà';
    }

    function panic(){
      stop();
      if(ctx){ ctx.close(); ctx = null; masterGain = null; }
    }

    playToggle.addEventListener('click', ()=> running ? stop() : start());
    panicBtn.addEventListener('click', panic);
  </script>

  <!-- üéÆ Í∞ÑÎã® Î¶¨Îì¨Í≤åÏûÑ -->
  <script>
    const gameContainer = document.createElement('div');
    gameContainer.style.marginTop = '40px';
    gameContainer.style.textAlign = 'center';
    document.querySelector('.card').appendChild(gameContainer);

    const title = document.createElement('h2');
    title.textContent = 'üéÆ „Ç∑„É≥„Éó„É´„Éª„É™„Ç∫„É†„Ç≤„Éº„É†';
    gameContainer.appendChild(title);

    const game = document.createElement('div');
    game.id = 'rhythmGame';
    Object.assign(game.style, {
      position: 'relative',
      width: '400px',
      height: '600px',
      margin: '0 auto',
      background: '#222',
      border: '3px solid #555',
      overflow: 'hidden',
      borderRadius: '20px'
    });
    gameContainer.appendChild(game);

    const line = document.createElement('div');
    Object.assign(line.style, {
      position: 'absolute',
      bottom: '100px',
      left: '0',
      width: '100%',
      height: '4px',
      background: '#ff0077'
    });
    game.appendChild(line);

    const scoreLabel = document.createElement('div');
    scoreLabel.textContent = 'Score: 0';
    Object.assign(scoreLabel.style, {
      color: '#222',
      fontSize: '22px',
      fontWeight: 'bold',
      marginTop: '10px'
    });
    gameContainer.appendChild(scoreLabel);

    const startBtn = document.createElement('button');
    startBtn.textContent = '‚ñ∂ „Çπ„Çø„Éº„Éà';
    Object.assign(startBtn.style, {
      background: '#2563eb',
      color: '#fff',
      border: 'none',
      borderRadius: '10px',
      padding: '10px 20px',
      fontSize: '16px',
      cursor: 'pointer'
    });
    gameContainer.appendChild(startBtn);

    let notes = [], score = 0, runningGame = false, createTimer, moveTimer;

    function createNote() {
      const note = document.createElement('div');
      Object.assign(note.style, {
        position: 'absolute',
        left: '180px',
        width: '40px',
        height: '20px',
        background: '#00ffea',
        borderRadius: '5px',
        top: '0px'
      });
      game.appendChild(note);
      notes.push(note);
    }

    function updateNotes() {
      for (let i = 0; i < notes.length; i++) {
        let n = notes[i];
        let top = parseInt(n.style.top);
        n.style.top = top + 5 + 'px';
        if (top > 600) { n.remove(); notes.splice(i, 1); i--; }
      }
    }

    function checkHit() {
      for (let i = 0; i < notes.length; i++) {
        let n = notes[i];
        let top = parseInt(n.style.top);
        if (top > 470 && top < 530) {
          score += 100;
          scoreLabel.textContent = 'Score: ' + score;
          n.remove();
          notes.splice(i, 1);
          break;
        }
      }
    }

    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && runningGame) checkHit();
    });

    startBtn.addEventListener('click', () => {
      if (!runningGame) {
        runningGame = true;
        score = 0;
        scoreLabel.textContent = 'Score: 0';
        startBtn.textContent = '‚ñ† „Çπ„Éà„ÉÉ„Éó';
        createTimer = setInterval(createNote, 1000);
        moveTimer = setInterval(updateNotes, 30);
      } else {
        runningGame = false;
        clearInterval(createTimer);
        clearInterval(moveTimer);
        notes.forEach(n => n.remove());
        notes = [];
        startBtn.textContent = '‚ñ∂ „Çπ„Çø„Éº„Éà';
      }
    });
  </script>
</body>
</html>
