<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>è£æ‹ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  â€” å®Œå…¨ç‰ˆ</title>

<style>
:root{
  --bg:#f7fbff; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e5eaf1;
  --primary:#2563eb; --accent:#22c55e; --accent2:#0ea5e9; --danger:#ef4444;
}
.dark{
  --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --line:#334155;
  --primary:#3b82f6; --accent:#4ade80; --accent2:#38bdf8; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--text);padding:20px;
}
.wrap{width:min(1080px,94vw);margin:0 auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;
  box-shadow:0 10px 30px rgba(15,23,42,.08);padding:22px}
.panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:14px}
.row{display:flex;align-items:center;gap:12px;margin:12px 0}
input[type="range"]{width:100%}
input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
button{padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-secondary{background:#e9edf3;border:1px solid #dbe2ea}
.meter{height:12px;border-radius:8px;background:#eef2f7;border:1px solid var(--line);
  overflow:hidden}
.bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),#34d399,#86efac);
  transition:width .1s ease}
#pulse{
  width:42px;height:42px;border-radius:50%;background:var(--primary);
  margin:12px auto;opacity:.4;transition:transform .12s, opacity .12s;
}
.beatGrid{
  display:flex;gap:8px;justify-content:center;margin-top:12px;
}
.beatDot{
  width:16px;height:16px;border-radius:50%;background:#cbd5e1;transition:.1s;
}
.dark .beatDot{background:#475569}
.beatDot.active{background:var(--primary);box-shadow:0 0 8px var(--primary)}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1>è£æ‹ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Settings Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="panel">

  <div class="row">
    <label>BPM</label>
    <input id="bpm" type="range" min="30" max="240" value="100">
    <input id="bpmNum" type="number" min="30" max="240" value="100">
    <button id="tapBtn" class="btn-secondary">TAP</button>
  </div>

  <div class="row">
    <label>æ‹å­</label>
    <input id="beats" type="range" min="1" max="12" value="4">
    <input id="beatsNum" type="number" min="1" max="12" value="4">
  </div>

  <div class="beatGrid" id="beatGrid"></div>

  <div class="row">
    <label>éŸ³é‡</label>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7">
    <input id="volNum" type="number" min="0" max="1" step="0.01" value="0.7">
  </div>

  <div class="row">
    <label>ç´°åˆ†åŒ–</label>
    <select id="subdiv">
      <option value="1">ãªã—</option>
      <option value="2">8åˆ†ï¼ˆ2åˆ†å‰²ï¼‰</option>
      <option value="3">3é€£ç¬¦</option>
      <option value="4">16åˆ†ï¼ˆ4åˆ†å‰²ï¼‰</option>
    </select>
  </div>

  <div class="row">
    <input id="swingToggle" type="checkbox">
    <label>ã‚¹ã‚¦ã‚£ãƒ³ã‚°ï¼ˆShuffleï¼‰</label>
  </div>

  <div class="row">
    <input id="offbeatToggle" type="checkbox" checked>
    <label>è£æ‹ã‚’é³´ã‚‰ã™</label>
  </div>

  <div class="row">
    <input id="autoBpm" type="checkbox">
    <label>è‡ªå‹•ãƒ†ãƒ³ãƒä¸Šæ˜‡</label>
    <input id="autoStep" type="number" value="2" min="1" max="20" style="width:60px">
  </div>

  <div class="row">
    <label>ã‚»ãƒƒã‚·ãƒ§ãƒ³</label>
    <select id="sessionTimer">
      <option value="0">ãªã—</option>
      <option value="60">1åˆ†</option>
      <option value="180">3åˆ†</option>
      <option value="300">5åˆ†</option>
    </select>
  </div>

  <div class="row">
    <input id="countInToggle" type="checkbox">
    <label>ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³ï¼ˆ4æ‹ï¼‰</label>
  </div>

  <div class="row">
    <button id="presetSave" class="btn-secondary">ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</button>
    <select id="presetList">
      <option value="0">ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—</option>
    </select>
    <button id="presetLoad" class="btn-primary">èª­è¾¼</button>
  </div>

  <button id="playToggle" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button id="panicBtn" class="btn-danger">â–  åœæ­¢</button>

  <div id="pulse"></div>

  <div class="row">
    <label>é€²è¡Œ</label>
    <div style="flex:1" class="meter"><div id="bar" class="bar"></div></div>
    <span id="beatNow" style="padding:4px 10px;border:1px solid var(--line);border-radius:8px">â€“</span>
  </div>

  <div style="text-align:center;margin-top:10px">
    <div id="offbeatLamp" style="
      width:22px;height:22px;border-radius:50%;background:#ccc;
      box-shadow:0 0 6px rgba(0,0,0,0.15);margin:auto;"></div>
    <div style="font-size:12px;color:var(--muted)">è£æ‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼</div>
  </div>

  <div class="row" style="justify-content:center;margin-top:20px">
    <button id="themeToggle" class="btn-secondary">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

</div>
</div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
let ctx, gain;
function audioInit(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  gain = ctx.createGain();
  gain.gain.value = parseFloat(vol.value);
  gain.connect(ctx.destination);
}

function clickSound(t,accent=false){
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type='sine';o.frequency.value=accent?1760:1320;
  g.gain.setValueAtTime(accent?.8:.5,t);
  g.gain.exponentialRampToValueAtTime(.001,t+.06);
  o.connect(g);g.connect(gain);
  o.start(t);o.stop(t+.06);
}

function offbeatSound(t){
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type='square';o.frequency.value=880;
  g.gain.setValueAtTime(.5,t);
  g.gain.exponentialRampToValueAtTime(.001,t+.05);
  o.connect(g);g.connect(gain);
  o.start(t);o.stop(t+.06);
}

function flashLamp(t){
  const d=(t-ctx.currentTime)*1000;
  setTimeout(()=>{
    offbeatLamp.style.background= "var(--accent)";
    offbeatLamp.style.boxShadow="0 0 14px var(--accent)";
    setTimeout(()=>{
      offbeatLamp.style.background="#ccc";
      offbeatLamp.style.boxShadow="0 0 6px rgba(0,0,0,.15)";
    },120);
  },d);
}

function pulseBeat(t){
  const d=(t-ctx.currentTime)*1000;
  setTimeout(()=>{
    pulse.style.transform='scale(1.5)';pulse.style.opacity='1';
    setTimeout(()=>{pulse.style.transform='scale(1)';pulse.style.opacity='.4';},120);
  },d);
}

/* â”€â”€â”€â”€â”€ UI Sync â”€â”€â”€â”€â”€ */
[bpm,bpmNum].forEach(el=>el.oninput=()=>bpm.value=bpmNum.value=el.value);
[beats,beatsNum].forEach(el=>el.oninput=()=>beats.value=beatsNum.value=el.value);
vol.oninput=()=>gain&&(gain.gain.value=parseFloat(vol.value));
volNum.oninput=()=>gain&&(gain.gain.value=parseFloat(volNum.value));

/* â”€â”€â”€â”€â”€ Beat Grid â”€â”€â”€â”€â”€ */
function renderBeatGrid(){
  beatGrid.innerHTML="";
  for(let i=0;i<beats.value;i++){
    const d=document.createElement("div");
    d.className="beatDot";
    beatGrid.appendChild(d);
  }
}
renderBeatGrid();
beats.oninput=renderBeatGrid;

/* â”€â”€â”€â”€â”€ Tap Tempo â”€â”€â”€â”€â”€ */
let taps=[];
tapBtn.onclick=()=>{
  const now=performance.now();
  taps.push(now);
  if(taps.length>6) taps.shift();
  if(taps.length>=2){
    const diffs=[];
    for(let i=1;i<taps.length;i++) diffs.push(taps[i]-taps[i-1]);
    const avg=diffs.reduce((a,b)=>a+b)/diffs.length;
    const bpmCalc=Math.round(60000/avg);
    bpm.value=bpmNum.value=Math.max(30,Math.min(240,bpmCalc));
  }
};

/* â”€â”€â”€â”€â”€ Metronome Core â”€â”€â”€â”€â”€ */
let running=false,nextT=0,beatIdx=0,timer;
let sessionLeft=0,sessionInt;

function schedule(){
  const spb=60/parseFloat(bpm.value);
  while(running && nextT<ctx.currentTime+.15){
    clickSound(nextT,beatIdx===0);
    pulseBeat(nextT);

    document.querySelectorAll(".beatDot").forEach((el,i)=>{
      el.classList.toggle("active",i===beatIdx);
    });

    const sub=parseInt(subdiv.value);
    if(sub>1){
      const base=spb/sub;
      for(let i=1;i<sub;i++) clickSound(nextT+base*i,false);
    }

    if(swingToggle.checked && sub===2){
      clickSound(nextT+spb*.66,false);
    }

    if(offbeatToggle.checked){
      offbeatSound(nextT+spb/2);
      flashLamp(nextT+spb/2);
    }

    uiBeat(nextT,beatIdx);
    beatIdx=(beatIdx+1)%parseInt(beats.value);
    nextT+=spb;

    if(autoBpm.checked && beatIdx===0){
      bpm.value=bpmNum.value=parseInt(bpm.value)+parseInt(autoStep.value);
    }
  }
  timer=setTimeout(schedule,20);
}

function uiBeat(t,i){
  const d=(t-ctx.currentTime)*1000;
  setTimeout(()=>{
    beatNow.textContent=i+1;
    const pct=((i+1)/beats.value)*100;
    bar.style.width=pct+"%";
    if(pct>=99) setTimeout(()=>bar.style.width='0%',80);
  },d);
}

async function start(){
  audioInit();
  if(ctx.state==="suspended") await ctx.resume();

  if(countInToggle.checked){
    let ct=ctx.currentTime+.1;
    for(let i=0;i<4;i++){
      clickSound(ct,true);
      pulseBeat(ct);
      ct+=.5;
    }
    nextT=ct;
  } else {
    nextT=ctx.currentTime+.1;
  }

  running=true;
  beatIdx=parseInt(beats.value)-1;
  schedule();
  playToggle.textContent="â–  ã‚¹ãƒˆãƒƒãƒ—";

  sessionLeft=parseInt(sessionTimer.value);
  if(sessionLeft>0){
    sessionInt=setInterval(()=>{
      sessionLeft--;
      if(sessionLeft<=0){ stop();clearInterval(sessionInt);}
    },1000);
  }
}

function stop(){
  running=false;
  clearTimeout(timer);
  beatNow.textContent="â€“";
  bar.style.width="0%";
  playToggle.textContent="â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ";
}

function panic(){
  stop();
  if(ctx){ctx.close();ctx=null;gain=null;}
}

playToggle.onclick=()=>running?stop():start();
panicBtn.onclick=panic;

/* â”€â”€â”€â”€â”€ Preset Save / Load â”€â”€â”€â”€â”€ */
presetSave.onclick=()=>{
  const name=prompt("ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›:");
  if(!name) return;
  const obj={
    bpm:bpm.value,beats:beats.value,vol:vol.value,
    subdiv:subdiv.value,swing:swingToggle.checked,
    off:offbeatToggle.checked
  };
  localStorage.setItem("preset_"+name,JSON.stringify(obj));
  const opt=document.createElement("option");
  opt.textContent=name; presetList.appendChild(opt);
  alert("ä¿å­˜ã—ã¾ã—ãŸ!");
};

presetLoad.onclick=()=>{
  const name=presetList.value;
  if(name==="0") return;
  const data=JSON.parse(localStorage.getItem("preset_"+name)||"null");
  if(!data) return;
  bpm.value=bpmNum.value=data.bpm;
  beats.value=beatsNum.value=data.beats;
  vol.value=volNum.value=data.vol;
  subdiv.value=data.subdiv;
  swingToggle.checked=data.swing;
  offbeatToggle.checked=data.off;
  renderBeatGrid();
};

/* â”€â”€â”€â”€â”€ Dark Mode â”€â”€â”€â”€â”€ */
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
};

</script>
</body>
</html>
