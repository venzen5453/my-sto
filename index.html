<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ãƒ‘ã‚¹ãƒ†ãƒ« Ã— DAW ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ </title>

<style>
/* ==========================================================
   PART 1 â€” Pastel Ã— DAW Style CSS
========================================================== */

:root{
  --bg:#fdfcff;
  --card:#ffffffee;
  --text:#1e1b2e;
  --muted:#7a7890;
  --pastel1:#ffd8e8;
  --pastel2:#d8eaff;
  --pastel3:#e8ffe6;
  --daw-accent:#ff0077;
  --daw-blue:#6aa3ff;
  --line:#eae8f2;
}

body{
  margin:0;
  font-family: "Inter",sans-serif;
  background:linear-gradient(135deg,var(--pastel1),var(--pastel2));
  padding:20px;
  color:var(--text);
}

.wrap{
  width:min(1100px,96%);
  margin:0 auto;
}

.card{
  background:var(--card);
  padding:20px 26px;
  border-radius:22px;
  box-shadow:0 10px 35px rgba(0,0,0,0.1);
}

h1.title{
  margin:0 0 8px;
  font-size:26px;
  font-weight:800;
}
.subtitle{
  color:var(--muted);
  margin:0 0 18px;
}

.panel{
  border:1px solid var(--line);
  padding:16px;
  border-radius:16px;
  margin:20px 0;
  background:#ffffffcc;
}

.row{
  display:flex;
  align-items:center;
  gap:16px;
  margin:10px 0;
}

label{ width:140px; color:var(--muted); }

input[type=range]{ flex:1; }
input[type=number],
select{
  padding:5px 8px;
  border:1px solid var(--line);
  border-radius:6px;
}

/* Buttons */
button{
  border:none;
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
}
.btn-primary{
  background:var(--daw-blue);
  color:#fff;
}
.btn-secondary{
  background:#e7ecf7;
}
.btn-ghost{
  background:#fff;
  border:1px solid var(--line);
}

/* Progress bar */
.progress{
  width:100%;
  height:10px;
  background:#eee;
  border-radius:6px;
  overflow:hidden;
  margin-top:10px;
}
.bar{
  width:0%;
  height:100%;
  background:linear-gradient(90deg,var(--pastel1),var(--pastel3));
  transition:.1s;
}
.beat-indicator{
  margin-top:6px;
}
.beat-now{
  font-weight:700;
}

/* Pulse */
.pulse{
  width:26px; height:26px;
  border-radius:50%;
  margin:10px auto 0;
  background:var(--pastel1);
  opacity:.35;
  transform:scale(1);
  transition:.15s;
}

/* Offbeat lamp */
.offbeat-lamp{
  width:20px; height:20px;
  border-radius:50%;
  background:#ccc;
  box-shadow:0 0 5px rgba(0,0,0,.2);
}

/* Pattern grid */
.pattern-grid{
  display:flex;
  gap:10px;
}
.patternBtn{
  padding:8px 12px;
  background:#eee;
  border-radius:10px;
  cursor:pointer;
}
.patternBtn.active{
  background:var(--pastel2);
  font-weight:700;
}

/* Beat grid */
.beat-grid{
  margin-top:10px;
  display:flex;
  gap:6px;
}
.beatDot{
  width:16px; height:16px;
  border-radius:50%;
  background:#ddd;
}
.beatDot.active{
  background:var(--daw-accent);
}

/* Accuracy */
.accuracy-box{
  padding:14px;
  border-radius:12px;
  background:#f8f8ff;
  border:1px solid var(--line);
  margin-top:10px;
}

/* History */
.history-area{
  padding:10px;
  background:#fafaff;
  border-radius:10px;
  border:1px solid var(--line);
  margin-top:10px;
}

/* Dark mode */
body.dark{
  --bg:#111;
  --card:#222;
  --text:#eee;
  --muted:#bbb;
  --line:#333;
  background:#000;
}

</style>
</head>

<body>

<div class="wrap">
<div class="card">

<h1 class="title">ğŸ€ ãƒ‘ã‚¹ãƒ†ãƒ« Ã— DAW ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  ğŸ¶</h1>
<p class="subtitle">ã‹ã‚ã„ã„ Ã— ãƒ—ãƒ­ä»•æ§˜ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ»ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ </p>

<!-- =====================================================
     BASIC CONTROLS (PART1)
===================================================== -->
<section class="panel">
<h2>åŸºæœ¬ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>

<div class="row">
<label>BPM</label>
<input id="bpm" type="range" min="30" max="240" value="100"/>
<input id="bpmNum" type="number" min="30" max="240" value="100"/>
</div>

<div class="row">
<label>æ‹å­</label>
<input id="beats" type="range" min="1" max="12" value="4"/>
<input id="beatsNum" type="number" min="1" max="12" value="4"/>
</div>

<div class="row">
<label>éŸ³é‡</label>
<input id="vol" type="range" min="0" max="1" step="0.01" value="0.7"/>
<input id="volNum" type="number" min="0" max="1" step="0.01" value="0.7"/>
</div>

<div class="row">
<label>éŸ³è‰²</label>
<select id="soundType">
<option value="default">æ¨™æº–ã‚¯ãƒªãƒƒã‚¯</option>
<option value="hihat">ãƒã‚¤ãƒãƒƒãƒˆ</option>
<option value="snare">ã‚¹ãƒã‚¢</option>
<option value="kick">ã‚­ãƒƒã‚¯</option>
</select>
</div>

<button id="playToggle" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<button id="panicBtn" class="btn-danger">â–  åœæ­¢</button>

<div class="progress"><div id="bar" class="bar"></div></div>
<div class="beat-indicator">
ç¾åœ¨ã®æ‹: <span id="beatNow" class="beat-now">â€“</span>
</div>

<div id="pulse" class="pulse"></div>
</section>

<!-- =====================================================
     RHYTHM SETTINGS
===================================================== -->
<section class="panel">
<h2>ãƒªã‚ºãƒ è¨­å®š</h2>

<div class="row">
<input id="offbeatToggle" type="checkbox" checked/>
<label for="offbeatToggle">è£æ‹ã‚’é³´ã‚‰ã™</label>
<div id="offbeatLamp" class="offbeat-lamp"></div>
</div>

<div class="row">
<label>ã‚µãƒ–ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³</label>
<select id="subdiv">
<option value="1">ãªã—</option>
<option value="2">2åˆ†å‰²</option>
<option value="3">3åˆ†å‰²</option>
<option value="4">4åˆ†å‰²</option>
</select>
</div>

<div class="row">
<input id="swingToggle" type="checkbox"/>
<label for="swingToggle">ã‚¹ã‚¤ãƒ³ã‚°ï¼ˆ2é€£ï¼‰</label>
</div>
</section>

<!-- =====================================================
     ACCENT PATTERNS
===================================================== -->
<section class="panel">
<h2>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³</h2>

<div class="row">
<label>ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
<select id="patternSelect">
<option value="default">æœ€å¼·æ‹ã®ã¿</option>
<option value="rock">ãƒ­ãƒƒã‚¯ (1,3)</option>
<option value="backbeat">ãƒãƒƒã‚¯ãƒ“ãƒ¼ãƒˆ (2,4)</option>
<option value="clave">ã‚¯ãƒ©ãƒ¼ãƒ™</option>
<option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
</select>
</div>

<div id="customPatternArea" class="panel-inner" style="display:none;">
<p>ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šï¼š</p>
<div id="patternButtons" class="pattern-grid"></div>
</div>

<div id="beatGrid" class="beat-grid"></div>
</section>

<!-- =====================================================
     LOOP PRACTICE / SESSION TIMER
===================================================== -->
<section class="panel">
<h2>ãƒ«ãƒ¼ãƒ—ç·´ç¿’</h2>

<div class="row">
<label>ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰</label>
<select id="loopMode">
<option value="none">ãªã—</option>
<option value="2-4">2æ‹ã‚ªãƒ³ / 4æ‹ã‚ªãƒ•</option>
<option value="4-4">4æ‹ã‚ªãƒ³ / 4æ‹ã‚ªãƒ•</option>
<option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
</select>
</div>

<div id="customLoopArea" style="display:none;">
<div class="row">
<label>ã‚ªãƒ³æ‹</label>
<input id="loopOn" type="number" min="1" max="32" value="4"/>
</div>
<div class="row">
<label>ã‚ªãƒ•æ‹</label>
<input id="loopOff" type="number" min="0" max="32" value="4"/>
</div>
</div>

<h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</h2>
<div class="row">
<label>ç·´ç¿’æ™‚é–“ï¼ˆç§’ï¼‰</label>
<input id="sessionTimer" type="number" min="0" max="3600" value="0"/>
</div>
</section>

<!-- =====================================================
     AUTO BPM / BPM CURVE
===================================================== -->
<section class="panel">
<h2>BPM è‡ªå‹•å¤‰åŒ–</h2>

<div class="row">
<input id="autoBpm" type="checkbox"/>
<label for="autoBpm">å°ç¯€ã”ã¨ã«è‡ªå‹•BPMã‚¢ãƒƒãƒ—</label>
</div>

<div class="row">
<label>ä¸Šæ˜‡é‡</label>
<input id="autoStep" type="number" min="0" max="20" value="1"/>
</div>

<div class="row">
<label>ãƒ†ãƒ³ãƒã‚«ãƒ¼ãƒ–</label>
<select id="bpmCurve">
<option value="none">ãªã—</option>
<option value="accel">åŠ é€Ÿ</option>
<option value="rit">æ¸›é€Ÿ</option>
</select>
</div>
</section>

<!-- =====================================================
     TAP TEMPO / PRESETS
===================================================== -->
<section class="panel">
<h2>Tap Tempo</h2>
<button id="tapBtn" class="btn-secondary">TAP</button>

<h2>ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2>
<div class="row">
<button id="presetSave" class="btn-ghost">ä¿å­˜</button>
<button id="presetLoad" class="btn-secondary">èª­è¾¼</button>
</div>
<select id="presetList"><option value="0">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ</option></select>
</section>

<!-- =====================================================
     ACCURACY
===================================================== -->
<section class="panel">
<h2>ãƒªã‚ºãƒ ç²¾åº¦ã®æ¸¬å®š</h2>
<div class="row">
<button id="accuracyStart" class="btn-primary">æ¸¬å®šé–‹å§‹</button>
<button id="accuracyReset" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div id="accuracyResult" class="accuracy-box">ï¼ˆSpaceã‚­ãƒ¼ã§æ¸¬å®šï¼‰</div>
</section>

<!-- =====================================================
     VISUALIZER
===================================================== -->
<section class="panel">
<h2>ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</h2>

<div class="row">
<label>ãƒ¢ãƒ¼ãƒ‰</label>
<select id="visualMode">
<option value="pulse">ãƒ‘ãƒ«ã‚¹</option>
<option value="bars">DAWãƒãƒ¼</option>
<option value="sweep">ã‚¹ã‚¤ãƒ¼ãƒ—</option>
<option value="none">ãªã—</option>
</select>
</div>
</section>

<!-- =====================================================
     WAV EXPORT
===================================================== -->
<section class="panel">
<h2>WAVæ›¸ãå‡ºã—</h2>
<button id="exportWav" class="btn-primary">WAVç”Ÿæˆ</button>
</section>

<!-- =====================================================
     HISTORY
===================================================== -->
<section class="panel">
<h2>ç·´ç¿’å±¥æ­´</h2>
<button id="showHistory" class="btn-secondary">è¡¨ç¤º/éš ã™</button>
<div id="historyArea" class="history-area" style="display:none;"></div>
</section>

<!-- =====================================================
     DARK MODE
===================================================== -->
<section class="panel center">
<button id="themeToggle" class="btn-ghost">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
</section>

</div></div>


<!-- ==========================================================
   PART 2~5 â€” JS ENGINE
   â€» ë„ˆë¬´ ê¸¸ì–´ ì¤‘ê°„ì—ì„œ ëŠê²¼ì„ ê°€ëŠ¥ì„± ìˆìŒ
========================================================== -->

<script>
/* ============================================================
   PART 2 â€” Audio Setup
=========================================================== */
let ctx=null, masterGain=null;

function ensureAudio(){
  if(ctx) return;
  ctx=new (window.AudioContext||window.webkitAudioContext)();
  masterGain=ctx.createGain();
  masterGain.gain.value=parseFloat(vol.value);
  masterGain.connect(ctx.destination);
}

function playClick(time,type="accent"){
  const osc=ctx.createOscillator();
  const g=ctx.createGain();
  
  let freq=1000;
  if(type==="accent") freq=1500;
  if(type==="subdiv") freq=800;

  if(soundType.value==="snare") freq=1800;
  if(soundType.value==="hihat") freq=3500;
  if(soundType.value==="kick") freq=180;

  osc.frequency.value=freq;
  g.gain.setValueAtTime(1.0,time);
  g.gain.exponentialRampToValueAtTime(0.001,time+0.07);
  osc.connect(g); g.connect(masterGain);
  osc.start(time); osc.stop(time+0.08);
}

function playOffbeat(time){
  const osc=ctx.createOscillator();
  const g=ctx.createGain();
  osc.frequency.value=900;
  g.gain.setValueAtTime(0.6,time);
  g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  osc.connect(g); g.connect(masterGain);
  osc.start(time); osc.stop(time+0.06);
}

/* ============================================================
   PART 3 â€” Core Scheduling Engine
=========================================================== */
const bar=document.getElementById("bar");
const beatNow=document.getElementById("beatNow");
const pulse=document.getElementById("pulse");
const offbeatLamp=document.getElementById("offbeatLamp");
const beatGrid=document.getElementById("beatGrid");
const customPatternArea=document.getElementById("customPatternArea");
const patternButtons=document.getElementById("patternButtons");

let customPattern=[];
function updateBeatGrid(count){
  beatGrid.innerHTML="";
  for(let i=0;i<count;i++){
    const d=document.createElement("div");
    d.className="beatDot";
    beatGrid.appendChild(d);
  }
}
updateBeatGrid(4);

let nextTime=0, running=false, beatIndex=0, timerID;
let loopCounter=0, loopPlaying=true;

function flashOffbeat(time){
  const d=Math.max(0,(time-ctx.currentTime)*1000);
  setTimeout(()=>{
    offbeatLamp.style.background="#22c55e";
    offbeatLamp.style.boxShadow="0 0 14px #22c55e";
    setTimeout(()=>{
      offbeatLamp.style.background="#ccc";
      offbeatLamp.style.boxShadow="0 0 6px rgba(0,0,0,0.2)";
    },140);
  },d);
}

function pulseBeat(time){
  const delay=Math.max(0,(time-ctx.currentTime)*1000);
  setTimeout(()=>{
    pulse.style.transform="scale(1.6)";
    pulse.style.opacity="1";
    setTimeout(()=>{
      pulse.style.transform="scale(1)";
      pulse.style.opacity=".35";
    },150);
  },delay);
}

function activeBeatDot(time,idx){
  const dots=beatGrid.children;
  const delay=Math.max(0,(time-ctx.currentTime)*1000);
  setTimeout(()=>{
    [...dots].forEach((d,i)=>d.classList.toggle("active",i===idx));
  },delay);
}

function isStrongBeat(i){
  const b=Number(beats.value);
  const mode=patternSelect.value;
  if(mode==="default") return i===0;
  if(mode==="rock") return i===0||i===2;
  if(mode==="backbeat") return i===1||i===3;
  if(mode==="clave"){
    const p=[true,false,false,true,false,true,false,false];
    return p[i%8];
  }
  if(mode==="custom") return !!customPattern[i];
  return i===0;
}

function scheduleSubdivision(time,intv,sub){
  if(sub<=1) return;
  const swing= swingToggle.checked && sub===2;

  for(let i=1;i<sub;i++){
    let t2;
    if(swing){
      const ratio=0.66;
      if(i===1) t2=time+intv*ratio;
      if(i===2) t2=time+intv*(ratio+(1-ratio));
    }else{
      t2=time+intv*i;
    }
    playClick(t2,"subdiv");
  }
}

function handleLoop(){
  const mode=loopMode.value;
  if(mode==="none") return;

  if(mode==="2-4"){
    if(loopCounter<2) loopPlaying=true;
    else if(loopCounter<6) loopPlaying=false;
    else loopCounter=-1;
  }
  if(mode==="4-4"){
    if(loopCounter<4) loopPlaying=true;
    else if(loopCounter<8) loopPlaying=false;
    else loopCounter=-1;
  }
  if(mode==="custom"){
    const on=Number(loopOn.value);
    const off=Number(loopOff.value);
    if(loopCounter<on) loopPlaying=true;
    else if(loopCounter<on+off) loopPlaying=false;
    else loopCounter=-1;
  }
}

function applyAutoBpm(){
  if(!autoBpm.checked) return;
  if(beatIndex===0){
    bpm.value=Number(bpm.value)+Number(autoStep.value);
    bpmNum.value=bpm.value;
  }
}

function applyBpmCurve(){
  if(bpmCurve.value==="accel"){
    bpm.value=Number(bpm.value)+0.03;
  }
  if(bpmCurve.value==="rit"){
    bpm.value=Number(bpm.value)-0.03;
  }
  bpmNum.value=bpm.value;
}

let sessionRemain=0, sessionTimerID;

function scheduleNotes(){
  const bpmVal=Number(bpm.value);
  const interval=60/bpmVal;
  const subdiv=Number(subdiv.value);

  while(running && nextTime < ctx.currentTime+0.12){
    handleLoop();

    if(loopPlaying){
      if(isStrongBeat(beatIndex)) playClick(nextTime,"accent");
      else playClick(nextTime,"beat");
    }

    scheduleSubdivision(nextTime,interval/subdiv,subdiv);

    if(offbeatToggle.checked){
      flashOffbeat(nextTime+interval/2);
      playOffbeat(nextTime+interval/2);
    }

    applyAutoBpm();
    applyBpmCurve();

    pulseBeat(nextTime);
    activeBeatDot(nextTime,beatIndex);

    const d=Math.max(0,(nextTime-ctx.currentTime)*1000);
    setTimeout(()=>{
      beatNow.textContent=beatIndex+1;
      const pct=((beatIndex+1)/Number(beats.value))*100;
      bar.style.width=pct+"%";
      if(pct>=99) setTimeout(()=> bar.style.width="0%",60);
    },d);

    nextTime+=interval;
    beatIndex=(beatIndex+1)%Number(beats.value);
    loopCounter++;
  }

  timerID=setTimeout(scheduleNotes,20);
}

function startMetronome(){
  ensureAudio();
  if(ctx.state==="suspended") ctx.resume();

  running=true;
  beatIndex=0;
  loopCounter=0;
  loopPlaying=true;

  updateBeatGrid(Number(beats.value));

  nextTime=ctx.currentTime+0.1;
  scheduleNotes();

  playToggle.textContent="â–  ã‚¹ãƒˆãƒƒãƒ—";
}

function stopMetronome(){
  running=false;
  clearTimeout(timerID);
  clearInterval(sessionTimerID);

  beatNow.textContent="â€“";
  bar.style.width="0%";

  playToggle.textContent="â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ";
}

function panic(){
  stopMetronome();
  if(ctx){
    ctx.close();
    ctx=null;
    masterGain=null;
  }
}

playToggle.onclick=()=> running?stopMetronome():startMetronome();
panicBtn.onclick=panic;

/* ============================================================
   PART 4 â€” Tap / Preset / Accuracy / WAV Export
=========================================================== */

let tapTimes=[];
tapBtn.onclick=()=>{
  const now=performance.now();
  tapTimes.push(now);
  if(tapTimes.length>5) tapTimes.shift();

  if(tapTimes.length>=2){
    const iv=[];
    for(let i=1;i<tapTimes.length;i++){
      iv.push(tapTimes[i]-tapTimes[i-1]);
    }
    const avg=iv.reduce((a,b)=>a+b,0)/iv.length;
    const tap=Math.round(60000/avg);
    bpm.value=bpmNum.value=tap;
  }
};

/* accuracy */
let accuracyActive=false;
let accuracyData=[];

accuracyStart.onclick=()=>{
  accuracyActive=true;
  accuracyData=[];
  accuracyResult.textContent="è¨ˆæ¸¬ä¸­â€¦ Spaceã‚­ãƒ¼ã§æ‹ã«åˆã‚ã›ã¦ãã ã•ã„";
};

accuracyReset.onclick=()=>{
  accuracyActive=false;
  accuracyData=[];
  accuracyResult.textContent="ï¼ˆSpaceã‚­ãƒ¼ã§æ¸¬å®šï¼‰";
};

document.addEventListener("keydown",e=>{
  if(e.code!=="Space") return;
  if(!accuracyActive) return;

  const t=ctx?ctx.currentTime:0;
  const interval=60/Number(bpm.value);
  const idx=Math.round((t-nextTime)/interval);
  const nearest=nextTime+idx*interval;

  const diff=(t-nearest)*1000;
  accuracyData.push(diff);

  const avg=accuracyData.reduce((a,b)=>a+b,0)/accuracyData.length;
  const absAvg=Math.abs(avg);

  accuracyResult.textContent=
  `${accuracyData.length} å›æ¸¬å®š â€” å¹³å‡èª¤å·®: ${avg.toFixed(1)}msï¼ˆçµ¶å¯¾: ${absAvg.toFixed(1)}msï¼‰`;
});

/* WAV export */
function encodeWAV(samples,sampleRate){
  const buffer=new ArrayBuffer(44+samples.length*2);
  const view=new DataView(buffer);
  function writeStr(o,s){ for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i)); }
  writeStr(0,"RIFF");
  view.setUint32(4,36+samples.length*2,true);
  writeStr(8,"WAVE");
  writeStr(12,"fmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,sampleRate,true);
  view.setUint32(28,sampleRate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  writeStr(36,"data");
  view.setUint32(40,samples.length*2,true);

  let offset=44;
  for(let i=0;i<samples.length;i++){
    let s=Math.max(-1,Math.min(1,samples[i]));
    view.setInt16(offset,s*0x7fff,true);
    offset+=2;
  }
  return buffer;
}

exportWav.onclick=()=>{
  if(!ctx) ensureAudio();
  const bpmVal=Number(bpm.value);
  const interval=60/bpmVal;
  const total=16;
  const sampleRate=44100;
  const len=Math.ceil(sampleRate*interval*total);
  const buffer=new Float32Array(len);

  for(let i=0;i<total;i++){
    const t=i*interval;
    const idx=Math.floor(t*sampleRate);
    for(let j=0;j<100;j++){
      if(idx+j<len){
        buffer[idx+j]+= (i%Number(beats.value)===0?1:-0.5) * Math.exp(-j/40);
      }
    }
  }

  const wav=encodeWAV(buffer,sampleRate);
  const blob=new Blob([wav],{type:"audio/wav"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="clicktrack.wav";
  a.click();
  URL.revokeObjectURL(url);
};

/* History */
showHistory.onclick=()=>{
  const h=JSON.parse(localStorage.getItem("practiceHistory")||"[]");
  historyArea.style.display=historyArea.style.display==="none"?"block":"none";
  historyArea.innerHTML=h.map(it=>`<div>${it.time} â€” BPM:${it.bpm}, ${it.min}åˆ†</div>`).join("");
};

function logPractice(){
  const h=JSON.parse(localStorage.getItem("practiceHistory")||"[]");
  h.push({
    time:new Date().toLocaleString(),
    bpm:Number(bpm.value),
    min:Number(sessionTimer.value)/60
  });
  localStorage.setItem("practiceHistory",JSON.stringify(h));
}

/* ============================================================
   PART 5 â€” Init / Events / Dark Mode / Stability
=========================================================== */
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  themeToggle.textContent=
    document.body.classList.contains("dark")?"â˜€ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰":"ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰";
};

beats.oninput=()=>{
  beatsNum.value=beats.value;
  updateBeatGrid(Number(beats.value));
};
beatsNum.oninput=()=>{
  beats.value=beatsNum.value;
  updateBeatGrid(Number(beats.value));
};

vol.oninput=()=>{ volNum.value=vol.value; if(masterGain) masterGain.gain.value=vol.value; };
volNum.oninput=()=>{ vol.value=volNum.value; if(masterGain) masterGain.gain.value=vol.value; };

bpm.oninput=()=> bpmNum.value=bpm.value;
bpmNum.oninput=()=> bpm.value=bpmNum.value;

patternSelect.onchange=()=>{
  if(patternSelect.value==="custom"){
    customPatternArea.style.display="block";
    buildCustom();
  }else customPatternArea.style.display="none";
};

function buildCustom(){
  patternButtons.innerHTML="";
  const n=Number(beats.value);
  customPattern=new Array(n).fill(false);
  for(let i=0;i<n;i++){
    const b=document.createElement("div");
    b.className="patternBtn";
    b.textContent=i+1;
    b.dataset.index=i;
    b.onclick=()=>{
      const idx=Number(b.dataset.index);
      customPattern[idx]=!customPattern[idx];
      b.classList.toggle("active",customPattern[idx]);
    };
    patternButtons.appendChild(b);
  }
}

visualMode.onchange=()=>{};

window.addEventListener("blur",()=>{ if(ctx && ctx.state==="running") ctx.suspend(); });
window.addEventListener("focus",()=>{ if(ctx && ctx.state==="suspended") ctx.resume(); });

updateBeatGrid(Number(beats.value));

</script>

</body>
</html>
