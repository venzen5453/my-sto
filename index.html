<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ã‚¦ã‚§ãƒ–ãƒ»ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼ˆè£æ‹ï¼‹ã‚®ã‚¿ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ï¼‰</title>
  <style>
    :root{
      --bg:#f7fbff; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e5eaf1;
      --primary:#2563eb; --secondary:#64748b; --accent:#22c55e; --accent2:#0ea5e9; --danger:#ef4444;
      --kbd-bg:#eef2ff; --kbd-bd:#c7d2fe; --chip:#e9f7ff;
    }
    *{box-sizing:border-box}
    html,body{height:auto;min-height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#f7fbff,#ffffff 40%,#f3f8ff);color:var(--text);display:block;padding:20px 10px;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
    button,input,select,textarea{font-size:16px;touch-action:manipulation}
    .wrap{width:min(1100px,94vw);margin:0 auto;padding:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.08);padding:22px}
    h1{font-size:clamp(20px,3.2vw,28px);margin:0 0 6px}
    p.sub{margin:0 0 16px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.25fr 1fr;gap:18px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;align-items:center;gap:12px;margin:12px 0}
    .row.nowrap{flex-wrap:wrap}
    label{min-width:120px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
    .inline-help{font-size:12px;color:#64748b}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--kbd-bg);border:1px solid var(--kbd-bd);padding:5px 7px;border-radius:8px}
    .tog{display:flex;align-items:center;gap:10px}
    .tog input{width:18px;height:18px}
    .meter{height:12px;border-radius:8px;background:#eef2f7;overflow:hidden;border:1px solid var(--line)}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),#34d399,#86efac);transition:width .08s ease}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{appearance:none;border:1px solid transparent;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s transform ease,.15s background ease}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#e9edf3;color:#0f172a;border-color:#dbe2ea}
    .btn-ghost{background:#f4f8ff;color:#0f172a;border-color:#dbe2ea}
    .btn-danger{background:var(--danger);color:#fff}
    .sec-title{display:flex;align-items:center;gap:8px;margin:2px 0 8px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip);color:#0369a1;border:1px solid #cdefff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab-btn{background:#eef3fb;border:1px solid #dae3f1;color:#0f172a;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab-btn.active{background:#2563eb;color:#fff;border-color:#1d4ed8}
    .tab{display:none}
    .tab.active{display:block}
    .fret{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
    .fret .cell{border:1px solid #e5e7eb;border-radius:8px;padding:6px 4px;text-align:center;font-size:12px}
    .big{font-size:36px;font-weight:800}
    .center{display:flex;align-items:center;justify-content:center}
    .stroke-seq{display:flex;gap:6px;flex-wrap:wrap}
    .stroke-item{min-width:30px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;text-align:center}
    .stroke-item.active{background:#2563eb;color:#fff;border-color:#1d4ed8}
    .hint{font-size:12px;color:#64748b;margin-top:4px}
    .list{display:flex;gap:6px;flex-wrap:wrap}
    .list .pill{padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px}
    .rec-ind{width:10px;height:10px;border-radius:999px;background:#aaa;display:inline-block;margin-left:6px}
    .rec-on{background:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ã‚¦ã‚§ãƒ–ãƒ»ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  <span class="chip">è£æ‹å¯¾å¿œãƒ»WebAudio</span></h1>
      <p class="sub">BPMãƒ»æ‹å­ã«åˆã‚ã›ãŸã‚¯ãƒªãƒƒã‚¯ã«åŠ ãˆã¦ã€<b>ã‚®ã‚¿ãƒ¼ç·´ç¿’ç”¨ã®4ãƒ¢ãƒ¼ãƒ‰</b>ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ï¼ãƒªã‚ºãƒ ãƒ»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ï¼ã‚¹ã‚±ãƒ¼ãƒ«ç·´ç¿’ï¼è€³ã‚³ãƒ”ï¼†éŒ²éŸ³ï¼‰ã‚’æ­è¼‰ã€‚</p>
      <div class="grid">
        <!-- å·¦ï¼šãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ æœ¬ä½“ -->
        <section class="panel">
          <h2 class="sec-title">åŸºæœ¬æ“ä½œ <span class="chip">ç´ æ—©ãèª¿æ•´</span></h2>
          <div class="row nowrap"><label for="bpm">ãƒ†ãƒ³ãƒï¼ˆBPMï¼‰</label><input id="bpm" type="range" min="30" max="240" value="100"><input id="bpmNum" type="number" min="30" max="240" value="100" /><span class="inline-help">ã‚¿ãƒƒãƒ—ã§ã‚‚åˆã‚ã›ã‚‰ã‚Œã¾ã™</span></div>
          <div class="row nowrap"><label for="beats">æ‹å­ï¼ˆåˆ†å­ï¼‰</label><input id="beats" type="range" min="1" max="12" value="4"><input id="beatsNum" type="number" min="1" max="12" value="4" /></div>
          <div class="row nowrap"><label for="vol">éŸ³é‡</label><input id="vol" type="range" min="0" max="1" step="0.01" value="0.70"><input id="volNum" type="number" min="0" max="1" step="0.01" value="0.70" /></div>
          <div class="row tog"><input id="offbeatToggle" type="checkbox" checked><label for="offbeatToggle">è£æ‹ï¼ˆï¼†ï¼‰ã‚’è‡ªå‹•ã§é³´ã‚‰ã™</label></div>
          <div class="row tog"><input id="accent1" type="checkbox" checked><label for="accent1">1æ‹ç›®ã‚’å¼·èª¿ï¼ˆé«˜ããƒ»å°‘ã—å¤§ããï¼‰</label></div>
          <div class="btns">
            <button id="playToggle" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="countInBtn" class="btn-secondary">ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³</button>
            <button id="tapBtn" class="btn-ghost">ã‚¿ãƒƒãƒ—ãƒ†ãƒ³ãƒ</button>
            <button id="hitOffbeatBtn" class="btn-ghost">å³æ™‚ãƒ»è£æ‹</button>
            <button id="panicBtn" class="btn-danger">å³æ™‚åœæ­¢</button>
          </div>
          <div class="row" style="margin-top:10px"><label>é€²è¡Œ</label><div class="meter" style="flex:1"><div id="bar" class="bar"></div></div><span id="beatNow" class="kbd">â€“</span></div>
          <div class="inline-help">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š<span class="kbd">Space</span> å†ç”Ÿ/åœæ­¢ãƒ»<span class="kbd">O</span> å³æ™‚ãƒ»è£æ‹</div>
        </section>

        <!-- å³ï¼šã‚®ã‚¿ãƒ¼æ‹¡å¼µ -->
        <aside class="panel">
          <h2 class="sec-title">ã‚®ã‚¿ãƒ¼ãƒ»ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ <span class="chip">4ãƒ¢ãƒ¼ãƒ‰</span></h2>
          <div class="tabs">
            <button class="tab-btn active" data-tab="chords">ã‚³ãƒ¼ãƒ‰</button>
            <button class="tab-btn" data-tab="rhythm">ãƒªã‚ºãƒ </button>
            <button class="tab-btn" data-tab="scale">ã‚¹ã‚±ãƒ¼ãƒ«</button>
            <button class="tab-btn" data-tab="ear">è€³ã‚³ãƒ”/éŒ²éŸ³</button>
          </div>

          <!-- 1) ã‚³ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ -->
          <div id="tab-chords" class="tab active">
            <div class="row nowrap">
              <label>ã‚»ãƒƒãƒˆ</label>
              <div class="list">
                <label class="pill"><input type="checkbox" class="ch-set" value="C" checked> C</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="G" checked> G</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="D" checked> D</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="A" checked> A</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="E" checked> E</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="Am" checked> Am</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="Em" checked> Em</label>
                <label class="pill"><input type="checkbox" class="ch-set" value="Dm" checked> Dm</label>
              </div>
            </div>
            <div class="row nowrap"><label>è¡¨ç¤ºç§’æ•°</label><input id="chordSec" type="range" min="1" max="8" value="2"><input id="chordSecNum" type="number" min="1" max="8" value="2"></div>
            <div class="center" style="gap:12px;margin-top:6px">
              <div id="chordNow" class="big">â€”</div>
              <button id="chordStart" class="btn-primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
              <button id="chordStop" class="btn-secondary">ã‚¹ãƒˆãƒƒãƒ—</button>
              <button id="chordOnce" class="btn-ghost">1æšã ã‘</button>
            </div>
            <div class="hint">BPMã«é€£å‹•ã›ãšã€ä¸€å®šç§’æ•°ã§æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¸ã€‚BPMé€£å‹•ã¯ãƒªã‚ºãƒ ãƒ¢ãƒ¼ãƒ‰ã§ã©ã†ãã€‚</div>
          </div>

          <!-- 2) ãƒªã‚ºãƒ ãƒ»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ -->
          <div id="tab-rhythm" class="tab">
            <div class="row nowrap">
              <label>ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
              <select id="patternSel">
                <option value="D D U U D U">8ãƒ“ãƒ¼ãƒˆ(å®šç•ª): D D U U D U</option>
                <option value="D - D U - U D U">8ãƒ“ãƒ¼ãƒˆ(ä¼‘ç¬¦): D - D U - U D U</option>
                <option value="D D D U U D U">16ãƒ“ãƒ¼ãƒˆé¢¨: D D D U U D U</option>
                <option value="D U D U D U D U">å‡ç­‰(8åˆ†): D U D U ...</option>
                <option value="D - U - D - U -">ãƒãƒ¼ãƒ•(è£æ‹å¼·èª¿): D - U - ...</option>
              </select>
            </div>
            <div class="row nowrap"><label>1å°ç¯€ã®æ‹</label><input id="beatsRh" type="number" min="2" max="12" value="4"> <span class="inline-help">â€» å·¦ã®æ‹å­ã¨åˆ¥è¨­å®šå¯èƒ½</span></div>
            <div id="strokeSeq" class="stroke-seq" style="margin-top:6px"></div>
            <div class="hint">ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã«åŒæœŸã—ã¦ã€ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆD=ãƒ€ã‚¦ãƒ³ã€U=ã‚¢ãƒƒãƒ—ã€-=ä¼‘ã¿ï¼‰ã€‚</div>
          </div>

          <!-- 3) ã‚¹ã‚±ãƒ¼ãƒ«ç·´ç¿’ï¼ˆç°¡æ˜“ï¼‰ -->
          <div id="tab-scale" class="tab">
            <div class="row nowrap">
              <label>ã‚¹ã‚±ãƒ¼ãƒ«</label>
              <select id="scaleSel">
                <option value="C Major">Cãƒ¡ã‚¸ãƒ£ãƒ¼(è‡ªç„¶éŸ³éš)</option>
                <option value="A Minor Pentatonic">Aãƒã‚¤ãƒŠãƒ¼ãƒ»ãƒšãƒ³ã‚¿</option>
                <option value="E Minor">Eãƒã‚¤ãƒŠãƒ¼(è‡ªç„¶éŸ³éš)</option>
              </select>
            </div>
            <div class="row nowrap"><label>è¡¨ç¤º</label><button id="scalePrev" class="btn-ghost">â—€</button><span id="scaleStep" class="kbd">1</span><button id="scaleNext" class="btn-ghost">â–¶</button></div>
            <div class="fret" id="fretGrid"></div>
            <div class="hint">ç°¡æ˜“ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ï¼ˆ6å¼¦=å·¦åˆ—ï¼‰ã€‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€²ã‚ã‚‹ã¨æ¨å¥¨ãƒã‚¸ã‚·ãƒ§ãƒ³ãŒé †ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‚</div>
          </div>

          <!-- 4) è€³ã‚³ãƒ”ï¼†éŒ²éŸ³ -->
          <div id="tab-ear" class="tab">
            <div class="row nowrap"><label>è€³ã‚³ãƒ”</label>
              <button id="playRandomNote" class="btn-ghost">ãƒ©ãƒ³ãƒ€ãƒ éŸ³</button>
              <button id="playRandomChord" class="btn-ghost">ãƒ©ãƒ³ãƒ€ãƒ å’ŒéŸ³</button>
            </div>
            <div class="hint">éŸ³ã‚’è´ã„ã¦å½“ã¦ã¦ã¿ã‚ˆã†ï¼ˆãƒ’ãƒ³ãƒˆï¼šé–‹æ”¾å¼¦ã‚„ãƒ¡ã‚¸ãƒ£ãƒ¼ä¸‰å’ŒéŸ³ä¸­å¿ƒï¼‰ã€‚</div>
            <div class="row nowrap"><label>éŒ²éŸ³</label>
              <button id="recBtn" class="btn-primary">â— éŒ²éŸ³é–‹å§‹</button>
              <span id="recLamp" class="rec-ind"></span>
              <button id="recStop" class="btn-secondary">â–  åœæ­¢</button>
              <a id="recDl" style="margin-left:8px" download="guitar_record.webm">éŒ²éŸ³ã‚’ä¿å­˜</a>
            </div>
            <audio id="playback" controls style="margin-top:6px;max-width:100%"></audio>
            <div class="hint">ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®ãƒã‚¤ã‚¯ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    /* ===== Web Audio æº–å‚™ ===== */
    let ctx, masterGain;
    function ensureAudio(){
      if(ctx) return;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = ctx.createGain();
      masterGain.gain.value = parseFloat(vol.value);
      masterGain.connect(ctx.destination);
    }

    function clickSound(time, {accent=false}={}){
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      const dur = 0.03;
      osc.type = 'sine';
      const f = accent ? 1760 : 1320;   // å¼·æ‹ã¯å°‘ã—é«˜ã
      osc.frequency.setValueAtTime(f, time);
      g.gain.setValueAtTime(accent ? 0.85 : 0.6, time);
      g.gain.exponentialRampToValueAtTime(0.001, time + dur);
      osc.connect(g); g.connect(masterGain);
      osc.start(time); osc.stop(time + 0.06);
    }

    function offbeatSound(time){
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      const dur = 0.035;
      osc.type = 'square';
      osc.frequency.setValueAtTime(880, time);
      g.gain.setValueAtTime(0.55, time);
      g.gain.exponentialRampToValueAtTime(0.001, time + dur);
      osc.connect(g); g.connect(masterGain);
      osc.start(time); osc.stop(time + 0.07);
    }

    /* ===== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼ˆãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ï¼‰ ===== */
    const lookahead = 25;          // ms
    const scheduleAheadTime = 0.15;// s
    let running = false, nextNoteTime = 0, beatIdx = 0, tapTimes = [];
    let timerID = null;

    function nextNote(){
      const secondsPerBeat = 60 / Number(bpm.value);
      nextNoteTime += secondsPerBeat;
      beatIdx = (beatIdx + 1) % Number(beats.value);
    }

    function schedule(){
      while (running && nextNoteTime < ctx.currentTime + scheduleAheadTime){
        // æ‹
        clickSound(nextNoteTime, {accent: accent1.checked && beatIdx === 0});
        // è£æ‹
        if (offbeatToggle.checked){
          const half = (60 / Number(bpm.value)) / 2;
          offbeatSound(nextNoteTime + half);
        }
        queueBeatUI(nextNoteTime, beatIdx);
        // ãƒªã‚ºãƒ ãƒ¢ãƒ¼ãƒ‰åŒæœŸ
        rhythmAdvance(nextNoteTime);
        nextNote();
      }
      timerID = setTimeout(schedule, lookahead);
    }

    function start(afterCountIn=false){
      ensureAudio();
      if (ctx.state === 'suspended') ctx.resume();
      if (running) return;
      running = true;
      beatIdx = Number(beats.value) - 1;
      const now = ctx.currentTime + 0.05;

      if (afterCountIn){
        let t = now;
        for(let i=0;i<4;i++){
          clickSound(t, {accent: i===0});
          t += 60 / Number(bpm.value);
        }
        nextNoteTime = t;
      }else{
        nextNoteTime = now;
      }
      schedule();
      setPlayButton(true);
    }

    function stop(){
      running = false;
      clearTimeout(timerID);
      beatNow.textContent = 'â€“';
      bar.style.width = '0%';
      setPlayButton(false);
    }

    function panic(){
      stop();
      if(ctx){ ctx.close(); ctx = null; masterGain = null; }
    }

    function hitOffbeatNow(){
      ensureAudio();
      if (ctx.state === 'suspended') ctx.resume();
      offbeatSound(ctx.currentTime + 0.001);
    }

    /* ===== UI ç´ä»˜ã‘ ===== */
    const bpm = document.getElementById('bpm');
    const bpmNum = document.getElementById('bpmNum');
    const beats = document.getElementById('beats');
    const beatsNum = document.getElementById('beatsNum');
    const vol = document.getElementById('vol');
    const volNum = document.getElementById('volNum');

    const offbeatToggle = document.getElementById('offbeatToggle');
    const accent1 = document.getElementById('accent1');

    const playToggle = document.getElementById('playToggle');
    const tapBtn = document.getElementById('tapBtn');
    const countInBtn = document.getElementById('countInBtn');
    const panicBtn = document.getElementById('panicBtn');
    const hitOffbeatBtn = document.getElementById('hitOffbeatBtn');

    const bar = document.getElementById('bar');
    const beatNow = document.getElementById('beatNow');

    function bindRangeAndNum(rangeEl, numEl, min, max, step=1){
      const clamp = v => Math.min(max, Math.max(min, Number(v)));
      rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; });
      numEl.addEventListener('input', ()=>{ numEl.value = clamp(numEl.value); rangeEl.value = numEl.value; });
      if (step) numEl.step = step;
    }
    bindRangeAndNum(bpm, bpmNum, 30, 240, 1);
    bindRangeAndNum(beats, beatsNum, 1, 12, 1);
    bindRangeAndNum(vol, volNum, 0, 1, 0.01);

    function updateVolume(){
      ensureAudio();
      masterGain.gain.setTargetAtTime(Number(vol.value), ctx.currentTime, 0.005);
      volNum.value = vol.value;
    }
    vol.addEventListener('input', updateVolume);
    volNum.addEventListener('input', ()=>{ vol.value = volNum.value; updateVolume(); });

    function setPlayButton(isPlaying){ playToggle.textContent = isPlaying ? 'â–  ã‚¹ãƒˆãƒƒãƒ—' : 'â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ'; }
    playToggle.addEventListener('click', ()=> running ? stop() : start(false));
    countInBtn.addEventListener('click', ()=> running ? null : start(true));
    panicBtn.addEventListener('click', panic);
    hitOffbeatBtn.addEventListener('click', hitOffbeatNow);

    tapBtn.addEventListener('click', ()=>{
      const t = performance.now();
      tapTimes.push(t);
      if (tapTimes.length > 6) tapTimes.shift();
      if (tapTimes.length >= 2){
        let sum=0; for(let i=1;i<tapTimes.length;i++) sum += (tapTimes[i]-tapTimes[i-1]);
        const avgMs = sum / (tapTimes.length-1);
        const newBpm = Math.max(30, Math.min(240, Math.round(60000/avgMs)));
        bpm.value = bpmNum.value = newBpm;
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){ e.preventDefault(); running ? stop() : start(false); }
      if(e.key.toLowerCase() === 'o'){ hitOffbeatNow(); }
    });

    function queueBeatUI(time, idx){
      const delay = Math.max(0, (time - ctx.currentTime) * 1000);
      setTimeout(()=>{
        beatNow.textContent = (idx+1);
        const pct = ((idx+1)/Number(beats.value))*100;
        bar.style.width = pct + '%';
        if (pct >= 99) setTimeout(()=> bar.style.width = '0%', 60);
      }, delay);
    }

    /* ====== ã‚®ã‚¿ãƒ¼ï¼š1) ã‚³ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ ====== */
    const chordPoolEls = Array.from(document.querySelectorAll('.ch-set'));
    const chordNow = document.getElementById('chordNow');
    const chordSec = document.getElementById('chordSec');
    const chordSecNum = document.getElementById('chordSecNum');
    const chordStart = document.getElementById('chordStart');
    const chordStop = document.getElementById('chordStop');
    const chordOnce = document.getElementById('chordOnce');
    let chordTimer = null;

    bindRangeAndNum(chordSec, chordSecNum, 1, 8, 1);

    function getChordPool(){
      const vals = chordPoolEls.filter(el=>el.checked).map(el=>el.value);
      return vals.length ? vals : ['C'];
    }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function setRandomChord(){ chordNow.textContent = pick(getChordPool()); }

    chordStart.addEventListener('click', ()=>{
      clearInterval(chordTimer);
      setRandomChord();
      chordTimer = setInterval(setRandomChord, Number(chordSec.value)*1000);
    });
    chordStop.addEventListener('click', ()=>{ clearInterval(chordTimer); });
    chordOnce.addEventListener('click', setRandomChord);

    /* ====== ã‚®ã‚¿ãƒ¼ï¼š2) ãƒªã‚ºãƒ ãƒ»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ ====== */
    const patternSel = document.getElementById('patternSel');
    const beatsRh = document.getElementById('beatsRh');
    const strokeSeq = document.getElementById('strokeSeq');
    let patternArr = [];
    let strokePos = -1;
    function buildStroke(){
      strokeSeq.innerHTML='';
      patternArr = patternSel.value.split(' ');
      patternArr.forEach((s,i)=>{
        const el = document.createElement('div');
        el.className = 'stroke-item';
        el.dataset.idx = i;
        el.textContent = s;
        strokeSeq.appendChild(el);
      });
      strokePos = -1;
    }
    patternSel.addEventListener('change', buildStroke);
    beatsRh.addEventListener('input', ()=>{ /* reserved for future use */ });
    buildStroke();

    function rhythmAdvance(time){
      // å„æ‹é ­ã§1ã¤é€²ã‚€ã€‚ä¼‘ç¬¦(-)ã§ã‚‚é€²ã‚€ã€‚
      const delay = Math.max(0, (time - ctx.currentTime) * 1000);
      setTimeout(()=>{
        if(!patternArr.length) return;
        strokePos = (strokePos + 1) % patternArr.length;
        Array.from(strokeSeq.children).forEach((el,i)=>{
          if(i===strokePos) el.classList.add('active'); else el.classList.remove('active');
        });
      }, delay);
    }

    /* ====== ã‚®ã‚¿ãƒ¼ï¼š3) ã‚¹ã‚±ãƒ¼ãƒ«ç°¡æ˜“ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ  ====== */
    const fretGrid = document.getElementById('fretGrid');
    const scaleSel = document.getElementById('scaleSel');
    const scalePrev = document.getElementById('scalePrev');
    const scaleNext = document.getElementById('scaleNext');
    const scaleStep = document.getElementById('scaleStep');

    // ç°¡æ˜“è¡¨: 6å¼¦(E)ã€œ1å¼¦(E) å„å¼¦ã®æ¨å¥¨ãƒ•ãƒ¬ãƒƒãƒˆï¼ˆä¾‹ç¤ºï¼‰
    const SCALE_MAP = {
      'C Major':      [[8,10,12],[7,8,10],[7,9,10],[7,9,10],[8,10,12],[8,10,12]],
      'A Minor Pentatonic': [[5,8],[5,7],[5,7],[5,7],[5,8],[5,8]],
      'E Minor':      [[0,2,3],[0,2,3],[0,2],[0,2],[0,2],[0,2,3]],
    };
    let stepIdx = 0;

    function renderFret(){
      const key = scaleSel.value;
      const box = SCALE_MAP[key];
      fretGrid.innerHTML='';
      for(let str=0; str<6; str++){
        // å·¦ã‹ã‚‰6å¼¦è¡¨ç¾
        const cells = new Array(4).fill(''); // ç°¡æ˜“: è¡¨ç¤ºåˆ—ã¯4ã¤
        box[str].slice(0,4).forEach((fret,i)=>{ cells[i] = fret; });
        cells.forEach((val,i)=>{
          const d = document.createElement('div');
          d.className='cell';
          d.textContent = val === '' ? '-' : val;
          if (i===stepIdx) d.style.background = '#dbeafe';
          fretGrid.appendChild(d);
        });
      }
      scaleStep.textContent = (stepIdx+1);
    }
    scaleSel.addEventListener('change', ()=>{ stepIdx = 0; renderFret(); });
    scalePrev.addEventListener('click', ()=>{ stepIdx = (stepIdx + 3) % 4; renderFret(); });
    scaleNext.addEventListener('click', ()=>{ stepIdx = (stepIdx + 1) % 4; renderFret(); });
    renderFret();

    /* ====== ã‚®ã‚¿ãƒ¼ï¼š4) è€³ã‚³ãƒ”ï¼ˆç™ºéŸ³ï¼‰ï¼†éŒ²éŸ³ ====== */
    function playTone(freq, dur=0.5){
      ensureAudio();
      if (ctx.state === 'suspended') ctx.resume();
      const t = ctx.currentTime + 0.01;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.7, t);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      osc.connect(g); g.connect(masterGain);
      osc.start(t); osc.stop(t+dur+0.02);
    }
    function playChord(freqs=[440,550,660], dur=0.8){
      ensureAudio();
      if (ctx.state === 'suspended') ctx.resume();
      const t = ctx.currentTime + 0.01;
      freqs.forEach(f=>{
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(f, t);
        g.gain.setValueAtTime(0.5/freqs.length, t);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
        osc.connect(g); g.connect(masterGain);
        osc.start(t); osc.stop(t+dur+0.02);
      });
    }

    const OPEN_STRINGS = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]; // E A D G B E
    const MAJOR_TRIADS = {
      'C':[261.63, 329.63, 392.00], 'G':[196.00,246.94,392.00], 'D':[146.83, 293.66, 369.99],
      'A':[220.00, 277.18, 440.00], 'E':[164.81, 207.65, 329.63], 'F':[174.61, 220.00, 349.23]
    };

    document.getElementById('playRandomNote').addEventListener('click', ()=>{
      const f = OPEN_STRINGS[Math.floor(Math.random()*OPEN_STRINGS.length)] * Math.pow(2, Math.floor(Math.random()*3));
      playTone(f, 0.6);
    });
    document.getElementById('playRandomChord').addEventListener('click', ()=>{
      const keys = Object.keys(MAJOR_TRIADS);
      const triad = MAJOR_TRIADS[keys[Math.floor(Math.random()*keys.length)]];
      playChord(triad, 1.0);
    });

    // éŒ²éŸ³
    const recBtn = document.getElementById('recBtn');
    const recStop = document.getElementById('recStop');
    const recLamp = document.getElementById('recLamp');
    const recDl = document.getElementById('recDl');
    const playback = document.getElementById('playback');
    let mediaStream, mediaRec, chunks = [];

    recBtn.addEventListener('click', async ()=>{
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRec = new MediaRecorder(mediaStream);
        chunks = [];
        mediaRec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
        mediaRec.onstop = ()=>{
          const blob = new Blob(chunks, {type:'audio/webm'});
          const url = URL.createObjectURL(blob);
          playback.src = url;
          recDl.href = url;
        };
        mediaRec.start();
        recLamp.classList.add('rec-on');
      }catch(err){ alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“: '+err.message); }
    });
    recStop.addEventListener('click', ()=>{
      if(mediaRec && mediaRec.state !== 'inactive') mediaRec.stop();
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); }
      recLamp.classList.remove('rec-on');
    });

    /* ===== ã‚¿ãƒ–åˆ‡æ›¿ ===== */
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabs = {
      chords: document.getElementById('tab-chords'),
      rhythm: document.getElementById('tab-rhythm'),
      scale: document.getElementById('tab-scale'),
      ear: document.getElementById('tab-ear')
    };
    tabBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tabs).forEach(el=>el.classList.remove('active'));
        tabs[btn.dataset.tab].classList.add('active');
      });
    });
  </script>
  <script>
/* ===== ğŸ® ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ  ãƒ¢ãƒ¼ãƒ‰è¿½åŠ  ===== */
let gameMode = false;
let score = 0, combo = 0;
const hitWindowPerfect = 0.08; // Â±80msä»¥å†… = Perfect
const hitWindowGood = 0.15;    // Â±150msä»¥å†… = Good
let upcomingNotes = []; // æ¬¡ã®ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒªã‚¹ãƒˆ

// HUDè¡¨ç¤º
const hud = document.createElement('div');
hud.style.position = 'fixed';
hud.style.top = '20px';
hud.style.right = '20px';
hud.style.fontSize = '18px';
hud.style.fontWeight = '700';
hud.style.color = '#2563eb';
hud.innerHTML = "ğŸ¯ SCORE: 0<br>ğŸ”¥ COMBO: 0";
document.body.appendChild(hud);

// åˆ¤å®šè¡¨ç¤º
const judge = document.createElement('div');
judge.style.position = 'fixed';
judge.style.top = '50%';
judge.style.left = '50%';
judge.style.transform = 'translate(-50%, -50%)';
judge.style.fontSize = '42px';
judge.style.fontWeight = '800';
judge.style.color = '#22c55e';
judge.style.textShadow = '0 0 10px rgba(0,0,0,0.3)';
document.body.appendChild(judge);

// ãƒãƒ¼ãƒˆç”Ÿæˆã¨é€²è¡Œãƒãƒ¼åŒæœŸ
function spawnNote(time){
  upcomingNotes.push({ time, hit:false });
  const note = document.createElement('div');
  note.className = 'note';
  Object.assign(note.style, {
    position:'fixed',
    bottom:'20px',
    left:'50%',
    width:'20px',
    height:'20px',
    borderRadius:'50%',
    background:'#2563eb',
    transform:'translateX(-50%)',
    transition:'bottom 0.5s linear'
  });
  document.body.appendChild(note);
  const travel = (time - ctx.currentTime) * 1000;
  setTimeout(()=> note.style.bottom = '200px', travel);
  setTimeout(()=> note.remove(), travel + 600);
}

function scheduleGameNote(){
  if(!gameMode) return;
  spawnNote(nextNoteTime);
}

// æ—¢å­˜ schedule() å†…ã«ä¸‹è¡Œã‚’è¿½åŠ ã—ã¦ã‚‚OK
const origSchedule = schedule;
schedule = function(){
  while (running && nextNoteTime < ctx.currentTime + scheduleAheadTime){
    clickSound(nextNoteTime, {accent: accent1.checked && beatIdx === 0});
    if (offbeatToggle.checked){
      const half = (60 / Number(bpm.value)) / 2;
      offbeatSound(nextNoteTime + half);
    }
    queueBeatUI(nextNoteTime, beatIdx);
    rhythmAdvance(nextNoteTime);
    if(gameMode) scheduleGameNote(); // ğŸ®ã“ã“è¿½åŠ ï¼
    nextNote();
  }
  timerID = setTimeout(schedule, lookahead);
};

// ã‚­ãƒ¼å…¥åŠ›åˆ¤å®š
document.addEventListener('keydown', e=>{
  if(!gameMode) return;
  if(!['s','d',';',"\'"].includes(e.key.toLowerCase())) return;

  const now = ctx.currentTime;
  const note = upcomingNotes.find(n=>!n.hit && Math.abs(now - n.time) < hitWindowGood);
  if(note){
    const diff = Math.abs(now - note.time);
    note.hit = true;
    if(diff < hitWindowPerfect){
      judge.innerText = "PERFECT!";
      judge.style.color = "#22c55e";
      score += 100; combo++;
    } else {
      judge.innerText = "GOOD!";
      judge.style.color = "#3b82f6";
      score += 50; combo++;
    }
  }else{
    judge.innerText = "MISS!";
    judge.style.color = "#ef4444";
    combo = 0;
  }
  hud.innerHTML = `ğŸ¯ SCORE: ${score}<br>ğŸ”¥ COMBO: ${combo}`;
  setTimeout(()=>judge.innerText="",300);
});

// ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³
const gameBtn = document.createElement('button');
gameBtn.textContent = "ğŸ® ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ é–‹å§‹";
gameBtn.className = "btn-primary";
gameBtn.style.marginTop = "16px";
document.querySelector('.card').appendChild(gameBtn);

gameBtn.addEventListener('click', ()=>{
  ensureAudio();
  if(!gameMode){
    score=0; combo=0; gameMode=true;
    gameBtn.textContent = "ğŸ›‘ ã‚²ãƒ¼ãƒ çµ‚äº†";
    start(false);
  }else{
    gameMode=false;
    stop();
    gameBtn.textContent = "ğŸ® ãƒªã‚ºãƒ ê²Œì„é–‹å§‹";
  }
});
</script>

</body>
</html>
