<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ»DAW ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ </title>

<style>
/* ================================
   ãƒ‘ã‚¹ãƒ†ãƒ« Ã— DAW  UI ãƒ‡ã‚¶ã‚¤ãƒ³
   ================================ */

:root{
  --bg:#f9faff;
  --card:#ffffff;
  --text:#2d334a;
  --muted:#687087;
  --line:#e3e8f0;

  /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒˆãƒ¼ãƒ³ */
  --pastel-pink:#ffdcef;
  --pastel-blue:#dff1ff;
  --pastel-mint:#dcffef;

  /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ */
  --primary:#6aa6ff;
  --primary-dark:#3b82f6;
  --danger:#ff6b7a;

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  --bg-dark:#1d1f27;
  --card-dark:#2a2d38;
  --text-dark:#f1f5ff;
  --line-dark:#3c3e48;

  font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
}

body{
  margin:0;
  background:linear-gradient(135deg, var(--pastel-pink), var(--pastel-blue), var(--pastel-mint));
  min-height:100vh;
  padding:25px 10px;
  color:var(--text);
  transition:background .5s ease;
}

body.dark{
  background:#101219;
  color:var(--text-dark);
}

/* ===========================
   Layout
   =========================== */
.wrap{
  width:min(1000px, 92vw);
  margin:0 auto;
}

.card{
  background:var(--card);
  border-radius:22px;
  padding:28px;
  box-shadow:0 10px 30px rgba(0,0,0,.07);
  border:1px solid var(--line);
  transition:background .3s, color .3s;
}

body.dark .card{
  background:var(--card-dark);
  border-color:var(--line-dark);
}

/* ===========================
   Titles
   =========================== */
.title{
  font-size:clamp(22px, 4vw, 32px);
  font-weight:800;
  text-align:center;
  margin:0 0 8px;
}

.subtitle{
  text-align:center;
  color:var(--muted);
  margin-bottom:25px;
}

/* ===========================
   Panels
   =========================== */
.panel{
  background:#fff;
  border-radius:18px;
  padding:20px 18px;
  margin-bottom:22px;
  border:1px solid var(--line);
  box-shadow:0 4px 14px rgba(0,0,0,.05);
}

body.dark .panel{
  background:var(--card-dark);
  border-color:var(--line-dark);
}

.panel h2{
  margin-top:0;
  font-size:20px;
  font-weight:700;
  margin-bottom:14px;
}

/* ===========================
   Form Rows
   =========================== */
.row{
  display:flex;
  align-items:center;
  gap:14px;
  margin:12px 0;
  flex-wrap:wrap;
}

label{
  min-width:110px;
  font-weight:600;
  color:var(--muted);
}

input[type="range"]{
  flex:1;
}

input[type="number"], select{
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
  font-size:15px;
}

body.dark input, 
body.dark select{
  background:#2f3240;
  border-color:#444;
  color:#fff;
}

/* ===========================
   Buttons
   =========================== */
button{
  border:none;
  border-radius:12px;
  padding:10px 16px;
  font-weight:700;
  cursor:pointer;
  transition:0.15s ease;
}

.btn-primary{
  background:var(--primary);
  color:#fff;
}
.btn-primary:hover{
  background:var(--primary-dark);
}

.btn-secondary{
  background:#dfe7f3;
  color:#2a2f3f;
}
body.dark .btn-secondary{
  background:#383c4e;
  color:#fff;
}

.btn-ghost{
  background:#fff;
  border:1px solid var(--line);
  color:#333;
}
body.dark .btn-ghost{
  background:#2b2d37;
  border-color:#444;
  color:#fafafa;
}

.btn-danger{
  background:var(--danger);
  color:#fff;
}

/* ===========================
   Progress / Pulse
   =========================== */
.progress{
  margin-top:16px;
  height:10px;
  background:#e0e4ef;
  border-radius:10px;
  overflow:hidden;
}
#bar{
  width:0%;
  height:100%;
  background:linear-gradient(90deg,#7da7ff,#9affd9);
  transition:width .1s;
}

.beat-now{
  font-size:22px;
  font-weight:800;
}

.pulse{
  width:40px;
  height:40px;
  margin:18px auto 0;
  background:#9acbff;
  border-radius:50%;
  opacity:.35;
  transition:transform .14s ease, opacity .14s ease;
}

/* ===========================
   Offbeat Lamp
   =========================== */
.offbeat-lamp{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#ccc;
  box-shadow:0 0 6px rgba(0,0,0,0.15);
  transition:0.1s;
}

/* ===========================
   Beat Grid (DAW-style)
   =========================== */
.beat-grid{
  display:flex;
  gap:10px;
  margin-top:18px;
}
.beatDot{
  width:20px;
  height:20px;
  border-radius:50%;
  background:#e2e6ef;
  transition:.1s;
}
.beatDot.active{
  background:#7da7ff;
  box-shadow:0 0 10px #7da7ff;
}

/* ===========================
   Pattern Buttons
   =========================== */
.pattern-grid{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.patternBtn{
  width:32px;
  height:32px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
}
.patternBtn.active{
  background:#7da7ff;
  color:#fff;
  border-color:#5c8ff0;
}

/* ===========================
   Accuracy Box
   =========================== */
.accuracy-box{
  padding:12px;
  border-radius:10px;
  background:#eef3ff;
  border:1px solid #d3daf3;
}

body.dark .accuracy-box{
  background:#2e3243;
  border-color:#444;
}

/* ===========================
   History Area
   =========================== */
.history-area{
  margin-top:10px;
  padding:10px;
  background:#f6f8ff;
  border-radius:12px;
  max-height:250px;
  overflow:auto;
}

body.dark .history-area{
  background:#2e3240;
}
</style>

  
</head>

<body>
  <div class="wrap">
    <div class="card">

      <h1 class="title">ğŸ€ ãƒ‘ã‚¹ãƒ†ãƒ« Ã— DAW ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  ğŸ¶</h1>
      <p class="subtitle">ã‹ã‚ã„ã„ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ ï¼‹ ãƒ—ãƒ­éŸ³æ¥½ãƒ„ãƒ¼ãƒ«æ©Ÿèƒ½</p>

      <!-- ===================== -->
      <!-- åŸºæœ¬ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
      <!-- ===================== -->
      <section class="panel">
        <h2>åŸºæœ¬ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>

        <div class="row">
          <label>BPM</label>
          <input id="bpm" type="range" min="30" max="240" value="100" />
          <input id="bpmNum" type="number" min="30" max="240" value="100" />
        </div>

        <div class="row">
          <label>æ‹å­</label>
          <input id="beats" type="range" min="1" max="12" value="4" />
          <input id="beatsNum" type="number" min="1" max="12" value="4" />
        </div>

        <div class="row">
          <label>éŸ³é‡</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7" />
          <input id="volNum" type="number" min="0" max="1" step="0.01" value="0.7" />
        </div>

        <div class="row">
          <label>éŸ³è‰²</label>
          <select id="soundType">
            <option value="default">æ¨™æº–ã‚¯ãƒªãƒƒã‚¯</option>
            <option value="hihat">ãƒã‚¤ãƒãƒƒãƒˆ</option>
            <option value="snare">ã‚¹ãƒã‚¢</option>
            <option value="kick">ã‚­ãƒƒã‚¯</option>
          </select>
        </div>

        <button id="playToggle" class="btn-primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="panicBtn" class="btn-danger">â–  ãƒ‘ãƒ‹ãƒƒã‚¯åœæ­¢</button>

        <div class="progress">
          <div id="bar" class="bar"></div>
        </div>
        <div class="beat-indicator">
          ç¾åœ¨ã®æ‹: <span id="beatNow" class="beat-now">â€“</span>
        </div>

        <!-- DAWã‚¹ã‚¿ã‚¤ãƒ«ã®è¦–è¦šãƒ‘ãƒ«ã‚¹ -->
        <div id="pulse" class="pulse"></div>
      </section>

      <!-- ===================== -->
      <!-- è£æ‹ / ã‚µãƒ–ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ / ã‚¹ã‚¤ãƒ³ã‚° -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ãƒªã‚ºãƒ è¨­å®š</h2>

        <div class="row">
          <input id="offbeatToggle" type="checkbox" checked />
          <label for="offbeatToggle">è£æ‹ã‚’é³´ã‚‰ã™</label>
          <div id="offbeatLamp" class="offbeat-lamp"></div>
        </div>

        <div class="row">
          <label>ã‚µãƒ–ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³</label>
          <select id="subdiv">
            <option value="1">ãªã—</option>
            <option value="2">2åˆ†å‰²</option>
            <option value="3">3åˆ†å‰²</option>
            <option value="4">4åˆ†å‰²</option>
          </select>
        </div>

        <div class="row">
          <input id="swingToggle" type="checkbox" />
          <label for="swingToggle">ã‚¹ã‚¤ãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆ2é€£æ™‚ï¼‰</label>
        </div>
      </section>

      <!-- ===================== -->
      <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆæ©Ÿèƒ½ -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³</h2>

        <div class="row">
          <label>ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
          <select id="patternSelect">
            <option value="default">æœ€å¼·æ‹ã®ã¿</option>
            <option value="rock">ãƒ­ãƒƒã‚¯ï¼ˆ1,3ï¼‰</option>
            <option value="backbeat">ãƒãƒƒã‚¯ãƒ“ãƒ¼ãƒˆï¼ˆ2,4ï¼‰</option>
            <option value="clave">ã‚¯ãƒ©ãƒ¼ãƒ™</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
          </select>
        </div>

        <div id="customPatternArea" class="panel-inner" style="display:none;">
          <p>ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šï¼š</p>
          <div id="patternButtons" class="pattern-grid"></div>
        </div>

        <!-- DAWé¢¨ã®æ‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
        <div id="beatGrid" class="beat-grid"></div>
      </section>

      <!-- ===================== -->
      <!-- ãƒ«ãƒ¼ãƒ—ç·´ç¿’ / ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ãƒ«ãƒ¼ãƒ—ç·´ç¿’</h2>
        <div class="row">
          <label>ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="loopMode">
            <option value="none">ãªã—</option>
            <option value="2-4">2æ‹ã‚ªãƒ³ / 4æ‹ã‚ªãƒ•</option>
            <option value="4-4">4æ‹ã‚ªãƒ³ / 4æ‹ã‚ªãƒ•</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
          </select>
        </div>

        <div id="customLoopArea" style="display:none;">
          <div class="row">
            <label>ã‚ªãƒ³æ‹æ•°</label>
            <input id="loopOn" type="number" min="1" max="32" value="4" />
          </div>
          <div class="row">
            <label>ã‚ªãƒ•æ‹æ•°</label>
            <input id="loopOff" type="number" min="0" max="32" value="4" />
          </div>
        </div>

        <h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</h2>
        <div class="row">
          <label>ç·´ç¿’æ™‚é–“ï¼ˆç§’ï¼‰</label>
          <input id="sessionTimer" type="number" min="0" max="3600" value="0" />
        </div>
      </section>

      <!-- ===================== -->
      <!-- ã‚ªãƒ¼ãƒˆBPM / ã‚«ãƒ¼ãƒ–ï¼ˆAccel/Ritï¼‰ -->
      <!-- ===================== -->
      <section class="panel">
        <h2>BPM è‡ªå‹•å¤‰åŒ–</h2>

        <div class="row">
          <input id="autoBpm" type="checkbox" />
          <label for="autoBpm">å°ç¯€ã”ã¨ã«è‡ªå‹•BPMã‚¢ãƒƒãƒ—</label>
        </div>

        <div class="row">
          <label>ä¸Šæ˜‡é‡</label>
          <input id="autoStep" type="number" min="0" max="20" value="1" />
        </div>

        <div class="row">
          <label>ãƒ†ãƒ³ãƒã‚«ãƒ¼ãƒ–</label>
          <select id="bpmCurve">
            <option value="none">ãªã—</option>
            <option value="accel">åŠ é€Ÿï¼ˆAccelerandoï¼‰</option>
            <option value="rit">æ¸›é€Ÿï¼ˆRitardandoï¼‰</option>
          </select>
        </div>
      </section>

      <!-- ===================== -->
      <!-- Tap Tempo / Presets -->
      <!-- ===================== -->
      <section class="panel">
        <h2>Tap Tempo</h2>
        <button id="tapBtn" class="btn-secondary">TAP</button>

        <h2>ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2>
        <div class="row">
          <button id="presetSave" class="btn-ghost">ä¿å­˜</button>
          <button id="presetLoad" class="btn-secondary">èª­è¾¼</button>
        </div>
        <select id="presetList">
          <option value="0">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ</option>
        </select>
      </section>

      <!-- ===================== -->
      <!-- ç²¾åº¦æ¸¬å®š -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ãƒªã‚ºãƒ ç²¾åº¦ã®æ¸¬å®š</h2>
        <div class="row">
          <button id="accuracyStart" class="btn-primary">æ¸¬å®šé–‹å§‹</button>
          <button id="accuracyReset" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="accuracyResult" class="accuracy-box">ï¼ˆSpace ã‚­ãƒ¼ã§æ¸¬å®šï¼‰</div>
      </section>

      <!-- ===================== -->
      <!-- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</h2>

        <div class="row">
          <label>ãƒ¢ãƒ¼ãƒ‰</label>
          <select id="visualMode">
            <option value="pulse">ãƒ‘ãƒ«ã‚¹</option>
            <option value="bars">DAWãƒãƒ¼</option>
            <option value="sweep">ã‚¹ã‚¤ãƒ¼ãƒ—</option>
            <option value="none">ãªã—</option>
          </select>
        </div>
      </section>

      <!-- ===================== -->
      <!-- WAV Export -->
      <!-- ===================== -->
      <section class="panel">
        <h2>WAV æ›¸ãå‡ºã—ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯ï¼‰</h2>
        <button id="exportWav" class="btn-primary">WAVç”Ÿæˆ</button>
      </section>

      <!-- ===================== -->
      <!-- ç·´ç¿’å±¥æ­´ -->
      <!-- ===================== -->
      <section class="panel">
        <h2>ç·´ç¿’å±¥æ­´</h2>
        <button id="showHistory" class="btn-secondary">è¡¨ç¤º / éš ã™</button>
        <div id="historyArea" class="history-area" style="display:none;"></div>
      </section>

      <!-- ===================== -->
      <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
      <!-- ===================== -->
      <section class="panel center">
        <button id="themeToggle" class="btn-ghost">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
      </section>

    </div>
  </div>


  <script>
/* ============================================================
   PART 3 â€” ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ  Audio ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆéŸ³ã®ä¸­å¿ƒéƒ¨åˆ†ï¼‰
   ============================================================ */

// -----------------------------
// Audio Setup
// -----------------------------
let ctx = null;
let masterGain = null;

function ensureAudio(){
  if (ctx) return;

  ctx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = ctx.createGain();
  masterGain.gain.value = parseFloat(vol.value);
  masterGain.connect(ctx.destination);
}

// -----------------------------
// Click Sounds
// -----------------------------
function playClick(time, type="accent"){
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  let freq = 1200;

  if (type === "accent") freq = 1600;
  if (type === "subdiv") freq = 900;

  // Sound Type (snare/hihat/kick)
  if (soundType.value === "snare") freq = 1800;
  if (soundType.value === "hihat") freq = 3500;
  if (soundType.value === "kick") freq = 170;

  osc.frequency.value = freq;

  gain.gain.setValueAtTime(1.0, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.06);

  osc.connect(gain);
  gain.connect(masterGain);

  osc.start(time);
  osc.stop(time + 0.07);
}

// -----------------------------
// Offbeat Click
// -----------------------------
function playOffbeat(time){
  const osc = ctx.createOscillator();
  const g = ctx.createGain();
  osc.frequency.value = 880;
  g.gain.setValueAtTime(0.7, time);
  g.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
  osc.connect(g); 
  g.connect(masterGain);
  osc.start(time); 
  osc.stop(time + 0.06);
}

// -----------------------------
// Elements
// -----------------------------
const bar = document.getElementById("bar");
const beatNow = document.getElementById("beatNow");
const pulse = document.getElementById("pulse");
const offbeatLamp = document.getElementById("offbeatLamp");
const beatGrid = document.getElementById("beatGrid");

const customPatternArea = document.getElementById("customPatternArea");
const patternButtons = document.getElementById("patternButtons");

// -----------------------------
// Beat Grid
// -----------------------------
function updateBeatGrid(count){
  beatGrid.innerHTML = "";
  for (let i=0; i<count; i++){
    const dot = document.createElement("div");
    dot.className = "beatDot";
    beatGrid.appendChild(dot);
  }
}
updateBeatGrid(4);

// -----------------------------
// State
// -----------------------------
let nextTime = 0;
let running = false;
let beatIndex = 0;
let timerID;

let customPattern = []; 

// -----------------------------
// Custom Pattern UI
// -----------------------------
function buildCustomPatternUI(){
  patternButtons.innerHTML = "";
  const n = Number(beats.value);
  customPattern = new Array(n).fill(false);

  for (let i=0; i<n; i++){
    const b = document.createElement("div");
    b.className = "patternBtn";
    b.textContent = i+1;
    b.dataset.index = i;

    b.onclick = () => {
      const idx = Number(b.dataset.index);
      customPattern[idx] = !customPattern[idx];
      b.classList.toggle("active", customPattern[idx]);
    };

    patternButtons.appendChild(b);
  }
}

// -----------------------------
// Count-In
// -----------------------------
function scheduleCountIn(){
  const interval = 60 / Number(bpm.value);
  let t = ctx.currentTime + 0.1;

  for (let i=0; i<4; i++){
    playClick(t, "accent");
    t += interval;
  }
  return t;
}

// -----------------------------
// Pulse Visual
// -----------------------------
function pulseBeat(time){
  const delay = Math.max(0, (time - ctx.currentTime) * 1000);

  setTimeout(()=>{
    pulse.style.transform = "scale(1.5)";
    pulse.style.opacity = "1";
    setTimeout(()=>{
      pulse.style.transform = "scale(1)";
      pulse.style.opacity = ".35";
    }, 140);
  }, delay);
}

// -----------------------------
// Beat Dot Visual
// -----------------------------
function activeBeatDot(time, idx){
  const dots = beatGrid.children;
  const delay = Math.max(0, (time - ctx.currentTime)*1000);

  setTimeout(()=>{
    [...dots].forEach((d,i)=>d.classList.toggle("active", i===idx));
  }, delay);
}

// -----------------------------
// Offbeat Lamp
// -----------------------------
function flashOffbeat(time){
  const d = Math.max(0,(time-ctx.currentTime)*1000);

  setTimeout(()=>{
    offbeatLamp.style.background = "#7ce8b3";
    offbeatLamp.style.boxShadow = "0 0 14px #22c55e";
    setTimeout(()=>{
      offbeatLamp.style.background = "#ccc";
      offbeatLamp.style.boxShadow = "0 0 6px rgba(0,0,0,.2)";
    },150);
  }, d);
}

// -----------------------------
// Subdivision
// -----------------------------
function scheduleSubdivision(time, interval, subdiv){
  if (subdiv <= 1) return;

  const swingOn = swingToggle.checked && subdiv === 2;

  for (let i=1; i<subdiv; i++){
    let t2;

    if (swingOn){
      const ratio = 0.66;
      if (i === 1) t2 = time + interval * ratio;
      if (i === 2) t2 = time + interval * (ratio + (1-ratio));
    } else {
      t2 = time + interval * i;
    }

    playClick(t2, "subdiv");
  }
}

// -----------------------------
// Accent Pattern
// -----------------------------
function isStrongBeat(i){
  const b = Number(beats.value);
  const mode = patternSelect.value;

  if (mode === "default") return i === 0;
  if (mode === "rock") return i === 0 || i === 2;
  if (mode === "backbeat") return i === 1 || i === 3;

  if (mode === "clave"){
    const pattern = [true,false,false,true,false,true,false,false];
    return pattern[i % 8];
  }

  if (mode === "custom"){
    return !!customPattern[i];
  }

  return i === 0;
}

// -----------------------------
// Poly Rhythm
// -----------------------------
function schedulePoly(time){
  const A = Number(polyA?.value || 0);
  const B = Number(polyB?.value || 0);

  if (!A || !B) return;

  const interval = 60 / Number(bpm.value);
  const ia = interval / A;
  const ib = interval / B;

  for (let i=0;i<A;i++) playClick(time + ia*i, "subdiv");
  for (let j=0;j<B;j++) playClick(time + ib*j, "subdiv");
}

// -----------------------------
// Loop Training Logic
// -----------------------------
let loopCounter = 0;
let loopPlaying = true;

function handleLoop(){
  const mode = loopMode.value;

  if (mode === "none") return;

  if (mode === "2-4"){
    if (loopCounter < 2) loopPlaying = true;
    else if (loopCounter < 6) loopPlaying = false;
    else loopCounter = -1;
  }

  if (mode === "4-4"){
    if (loopCounter < 4) loopPlaying = true;
    else if (loopCounter < 8) loopPlaying = false;
    else loopCounter = -1;
  }

  if (mode === "custom"){
    const on = Number(loopOn.value);
    const off = Number(loopOff.value);
    if (loopCounter < on) loopPlaying = true;
    else if (loopCounter < on+off) loopPlaying = false;
    else loopCounter = -1;
  }
}

// -----------------------------
// Auto BPM / Tempo Curve
// -----------------------------
function applyBpmCurve(){
  if (bpmCurve.value === "accel") bpm.value = Number(bpm.value) + 0.03;
  if (bpmCurve.value === "rit")   bpm.value = Number(bpm.value) - 0.03;
  bpmNum.value = bpm.value;
}

function applyAutoBpm(){
  if (!autoBpm.checked) return;
  if (beatIndex === 0){
    bpm.value = Number(bpm.value) + Number(autoStep.value);
    bpmNum.value = bpm.value;
  }
}

// -----------------------------
// Session Timer
// -----------------------------
let sessionRemain = 0;
let sessionTimerID;

function startSessionTimer(){
  sessionRemain = Number(sessionTimer.value);

  if (sessionRemain > 0){
    sessionTimerID = setInterval(()=>{
      sessionRemain--;
      if (sessionRemain <= 0) stopMetronome();
    },1000);
  }
}

// -----------------------------
// Main Scheduler
// -----------------------------
function scheduleNotes(){
  const bpmVal = Number(bpm.value);
  const interval = 60 / bpmVal;
  const subdiv = Number(subdiv.value);

  while (running && nextTime < ctx.currentTime + 0.15){

    handleLoop();

    if (loopPlaying){
      if (isStrongBeat(beatIndex)) playClick(nextTime,"accent");
      else playClick(nextTime,"beat");
    }

    scheduleSubdivision(nextTime, interval/subdiv, subdiv);
    schedulePoly(nextTime);

    if (offbeatToggle.checked){
      flashOffbeat(nextTime + interval/2);
      playOffbeat(nextTime + interval/2);
    }

    applyAutoBpm();
    applyBpmCurve();

    pulseBeat(nextTime);
    activeBeatDot(nextTime, beatIndex);

    const delay = Math.max(0,(nextTime-ctx.currentTime)*1000);
    setTimeout(()=>{
      beatNow.textContent = beatIndex+1;
      bar.style.width = ((beatIndex+1)/Number(beats.value))*100 + "%";
    },delay);

    nextTime += interval;
    beatIndex = (beatIndex + 1) % Number(beats.value);
    loopCounter++;
  }

  timerID = setTimeout(scheduleNotes, 25);
}

// -----------------------------
// START
// -----------------------------
function startMetronome(){
  ensureAudio();
  if (ctx.state === "suspended") ctx.resume();

  running = true;
  beatIndex = 0;
  loopCounter = 0;
  loopPlaying = true;

  updateBeatGrid(Number(beats.value));

  let startAt = ctx.currentTime + 0.1;

  if (countInToggle.checked){
    startAt = scheduleCountIn();
  }

  nextTime = startAt;
  scheduleNotes();

  playToggle.textContent = "â–  ã‚¹ãƒˆãƒƒãƒ—";
  startSessionTimer();
}

// -----------------------------
// STOP
// -----------------------------
function stopMetronome(){
  running = false;
  clearTimeout(timerID);
  clearInterval(sessionTimerID);

  beatNow.textContent = "â€“";
  bar.style.width = "0%";

  playToggle.textContent = "â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ";
}

// Panic å¼·åˆ¶åœæ­¢
function panic(){
  stopMetronome();
  if (ctx){
    ctx.close();
    ctx = null;
    masterGain = null;
  }
}

playToggle.onclick = ()=> running ? stopMetronome() : startMetronome();
panicBtn.onclick = panic;

</script>

<script>
/* ============================================================
   PART 4 â€” Visualizer / TapTempo / Preset / Accuracy / WAV Export
   ============================================================ */

/* -----------------------------------------
   TAP TEMPO
----------------------------------------- */
let tapTimes = [];
tapBtn.onclick = ()=>{
  const now = performance.now();
  tapTimes.push(now);

  if (tapTimes.length > 5) tapTimes.shift();

  if (tapTimes.length >= 2){
    const intervals = [];
    for (let i=1;i<tapTimes.length;i++){
      intervals.push(tapTimes[i] - tapTimes[i-1]);
    }
    const avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
    const result = Math.round(60000 / avg);

    bpm.value = bpmNum.value = result;
  }
};

/* -----------------------------------------
   PRESET SAVE / LOAD
----------------------------------------- */
function savePreset(){
  const p = {
    bpm:bpm.value,
    beats:beats.value,
    vol:vol.value,
    subdiv:subdiv.value,
    swing:swingToggle.checked,
    offbeat:offbeatToggle.checked,
    sound:soundType.value,
    visual:visualMode.value,
    pattern:customPattern
  };
  const name = prompt("ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (!name) return;

  localStorage.setItem("preset_"+name, JSON.stringify(p));

  const opt = document.createElement("option");
  opt.value = "preset_"+name;
  opt.textContent = name;
  presetList.appendChild(opt);
}

presetSave.onclick = savePreset;

presetLoad.onclick = ()=>{
  const key = presetList.value;
  if (key === "0") return;

  const p = JSON.parse(localStorage.getItem(key)||"null");
  if (!p) return;

  bpm.value = bpmNum.value = p.bpm;
  beats.value = beatsNum.value = p.beats;
  vol.value = volNum.value = p.vol;
  subdiv.value = p.subdiv;
  swingToggle.checked = p.swing;
  offbeatToggle.checked = p.offbeat;
  soundType.value = p.sound;
  visualMode.value = p.visual;

  customPattern = p.pattern;
  if (patternSelect.value === "custom") buildCustomPatternUI();
};

/* -----------------------------------------
   ACCURACY (ãƒªã‚ºãƒ æ­£ç¢ºã•æ¸¬å®š)
----------------------------------------- */
let accuracyActive = false;
let accuracyData = [];

accuracyStart.onclick = ()=>{
  accuracyActive = true;
  accuracyData = [];
  accuracyResult.textContent = "è¨ˆæ¸¬ä¸­â€¦ Spaceã‚­ãƒ¼ã§æ‹ã«åˆã‚ã›ã¦ãã ã•ã„";
};

accuracyReset.onclick = ()=>{
  accuracyActive = false;
  accuracyData = [];
  accuracyResult.textContent = "ï¼ˆSpace ã‚­ãƒ¼ã§æ¸¬å®šï¼‰";
};

document.addEventListener("keydown", e=>{
  if (e.code !== "Space") return;
  if (!accuracyActive) return;

  const t = ctx ? ctx.currentTime : 0;
  const interval = 60 / Number(bpm.value);

  const idx = Math.round((t - nextTime) / interval);
  const nearest = nextTime + idx * interval;

  const diff = (t - nearest) * 1000;
  accuracyData.push(diff);

  const avg = accuracyData.reduce((a,b)=>a+b,0)/accuracyData.length;
  const abs = Math.abs(avg);

  accuracyResult.textContent =
    `${accuracyData.length} å›æ¸¬å®š â€” å¹³å‡èª¤å·®: ${avg.toFixed(1)}msï¼ˆçµ¶å¯¾: ${abs.toFixed(1)}msï¼‰`;
});

/* -----------------------------------------
   VISUALIZER â€” SWEEP
----------------------------------------- */
let sweepCanvas = null;
let sweepCtx = null;

function initSweep(){
  if (sweepCanvas) return;

  sweepCanvas = document.createElement("canvas");
  sweepCanvas.id = "sweepCanvas";
  sweepCanvas.style.width="100%";
  sweepCanvas.style.height="140px";
  sweepCanvas.style.marginTop="12px";
  document.querySelector(".card").appendChild(sweepCanvas);

  sweepCtx = sweepCanvas.getContext("2d");

  function resize(){
    sweepCanvas.width = sweepCanvas.clientWidth;
    sweepCanvas.height = sweepCanvas.clientHeight;
  }
  resize();
  window.addEventListener("resize", resize);
}

function drawSweep(time){
  if (visualMode.value !== "sweep") return;
  if (!sweepCanvas) return;

  const delay = Math.max(0,(time-ctx.currentTime)*1000);

  setTimeout(()=>{
    const w = sweepCanvas.width;
    const h = sweepCanvas.height;

    sweepCtx.fillStyle = "rgba(0,0,0,0.12)";
    sweepCtx.fillRect(0,0,w,h);

    sweepCtx.fillStyle = "#7da7ff";
    const x = Math.random()*w;
    sweepCtx.fillRect(x,0,4,h);
  },delay);
}

/* -----------------------------------------
   VISUALIZER â€” BARS
----------------------------------------- */
function initBars(){
  let barsArea = document.getElementById("barsArea");

  if (!barsArea){
    barsArea = document.createElement("div");
    barsArea.id="barsArea";
    barsArea.style.display="flex";
    barsArea.style.gap="8px";
    barsArea.style.marginTop="12px";
    barsArea.style.height="60px";
    document.querySelector(".card").appendChild(barsArea);
  }

  barsArea.innerHTML = "";

  for (let i=0; i<Number(beats.value); i++){
    const b = document.createElement("div");
    b.className="barBeat";
    b.style.flex="1";
    b.style.borderRadius="6px";
    b.style.background="#e1e5ef";
    b.style.transition="0.1s";
    barsArea.appendChild(b);
  }
}

function triggerBars(time, idx){
  if (visualMode.value !== "bars") return;

  const bars = document.getElementById("barsArea").children;
  const delay = Math.max(0,(time-ctx.currentTime)*1000);

  setTimeout(()=>{
    [...bars].forEach((b,i)=>
      b.style.background = (i===idx ? "#7da7ff" : "#e1e5ef")
    );
  }, delay);
}

/* -----------------------------------------
   VISUAL MODE CHANGE
----------------------------------------- */
visualMode.onchange = ()=>{
  if (visualMode.value==="pulse"){
    pulse.style.display="block";
    document.getElementById("sweepCanvas")?.style.setProperty("display","none");
    document.getElementById("barsArea")?.style.setProperty("display","none");
  }
  else if (visualMode.value==="sweep"){
    pulse.style.display="none";
    initSweep();
    document.getElementById("sweepCanvas").style.display="block";
    document.getElementById("barsArea")?.style.setProperty("display","none");
  }
  else if (visualMode.value==="bars"){
    pulse.style.display="none";
    initBars();
    document.getElementById("sweepCanvas")?.style.setProperty("display","none");
    document.getElementById("barsArea").style.display="block";
  } 
  else {
    pulse.style.display="none";
    document.getElementById("sweepCanvas")?.style.setProperty("display","none");
    document.getElementById("barsArea")?.style.setProperty("display","none");
  }
};

/* -----------------------------------------
   WAV Export (ã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯ä½œæˆ)
----------------------------------------- */
exportWav.onclick = async ()=>{
  if (!ctx) ensureAudio();

  const bpmVal = Number(bpm.value);
  const interval = 60/bpmVal;
  const totalBeats = 16;

  const sampleRate = 44100;
  const length = Math.ceil(sampleRate * interval * totalBeats);
  const buffer = new Float32Array(length);

  for (let i=0; i<totalBeats; i++){
    const t = i * interval;
    const idx = Math.floor(t * sampleRate);

    for (let j=0;j<120;j++){
      if (idx+j < length){
        buffer[idx+j] += (i%Number(beats.value)===0 ? 1 : -0.5) * Math.exp(-j/50);
      }
    }
  }

  const wav = encodeWAV(buffer, sampleRate);

  const blob = new Blob([wav], {type:"audio/wav"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "clicktrack.wav";
  a.click();

  URL.revokeObjectURL(url);
};

function encodeWAV(samples, sampleRate){
  const buffer = new ArrayBuffer(44 + samples.length*2);
  const view = new DataView(buffer);

  function str(o,s){ for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i)); }

  str(0,"RIFF");
  view.setUint32(4,36 + samples.length*2,true);
  str(8,"WAVE");
  str(12,"fmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,sampleRate,true);
  view.setUint32(28,sampleRate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  str(36,"data");
  view.setUint32(40,samples.length*2,true);

  let offset=44;

  for(let i=0;i<samples.length;i++){
    let s=Math.max(-1,Math.min(1,samples[i]));
    view.setInt16(offset, s*0x7fff, true);
    offset+=2;
  }

  return buffer;
}

/* -----------------------------------------
   Practice History
----------------------------------------- */
showHistory.onclick = ()=>{
  const h = JSON.parse(localStorage.getItem("practiceHistory")||"[]");
  const area = document.getElementById("historyArea");

  area.style.display = (area.style.display==="none" ? "block":"none");

  area.innerHTML = h.map(item =>
    `<div>${item.time} â€” BPM:${item.bpm}, ${item.min}åˆ†ç·´ç¿’</div>`
  ).join("");
};

function logPractice(){
  const h = JSON.parse(localStorage.getItem("practiceHistory")||"[]");

  h.push({
    time: new Date().toLocaleString(),
    bpm: Number(bpm.value),
    min: Number(sessionTimer.value)/60
  });

  localStorage.setItem("practiceHistory", JSON.stringify(h));
}

</script>


  <script>
/* ============================================================
   PART 5 â€” Final Integration / Init / Dark Mode / Stability
   ============================================================ */

/* -----------------------------------------
   ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
----------------------------------------- */
themeToggle.onclick = () => {
  document.body.classList.toggle("dark");

  themeToggle.textContent =
    document.body.classList.contains("dark")
      ? "â˜€ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰"
      : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰";
};

/* -----------------------------------------
   æ‹å­ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
----------------------------------------- */
beats.oninput = () => {
  beatsNum.value = beats.value;
  updateBeatGrid(Number(beats.value));

  if (patternSelect.value === "custom") {
    buildCustomPatternUI();
  }

  if (visualMode.value === "bars") {
    initBars();
  }
};

beatsNum.oninput = () => {
  beats.value = beatsNum.value;
  updateBeatGrid(Number(beats.value));

  if (patternSelect.value === "custom") {
    buildCustomPatternUI();
  }

  if (visualMode.value === "bars") {
    initBars();
  }
};

/* -----------------------------------------
   Volume
----------------------------------------- */
vol.oninput = () => {
  volNum.value = vol.value;
  if (masterGain) masterGain.gain.value = vol.value;
};
volNum.oninput = () => {
  vol.value = volNum.value;
  if (masterGain) masterGain.gain.value = vol.value;
};

/* -----------------------------------------
   BPM sync
----------------------------------------- */
bpm.oninput = () => (bpmNum.value = bpm.value);
bpmNum.oninput = () => (bpm.value = bpmNum.value);

/* -----------------------------------------
   ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ ì‹œ UI í‘œì‹œ
----------------------------------------- */
patternSelect.onchange = () => {
  if (patternSelect.value === "custom") {
    customPatternArea.style.display = "block";
    buildCustomPatternUI();
  } else {
    customPatternArea.style.display = "none";
  }
};

/* -----------------------------------------
   Loop UI
----------------------------------------- */
loopMode.onchange = () => {
  if (loopMode.value === "custom") {
    customLoopArea.style.display = "block";
  } else {
    customLoopArea.style.display = "none";
  }
};

/* -----------------------------------------
   Visualizer ì´ˆê¸°í™” (Pulse / Sweep / Bars)
----------------------------------------- */
visualMode.onchange = () => {
  if (visualMode.value === "pulse") {
    pulse.style.display = "block";
    document.getElementById("sweepCanvas")?.style.setProperty("display", "none");
    document.getElementById("barsArea")?.style.setProperty("display", "none");
  } 
  else if (visualMode.value === "sweep") {
    pulse.style.display = "none";
    initSweep();
    document.getElementById("sweepCanvas").style.display = "block";
    document.getElementById("barsArea")?.style.setProperty("display", "none");
  } 
  else if (visualMode.value === "bars") {
    pulse.style.display = "none";
    initBars();
    document.getElementById("sweepCanvas")?.style.setProperty("display", "none");
    document.getElementById("barsArea").style.display = "block";
  } 
  else {
    pulse.style.display = "none";
    document.getElementById("sweepCanvas")?.style.setProperty("display", "none");
    document.getElementById("barsArea")?.style.setProperty("display", "none");
  }
};

/* -----------------------------------------
   START / STOP override (history ê¸°ë¡ í¬í•¨)
----------------------------------------- */
const originalStart = startMetronome;
const originalStop = stopMetronome;

startMetronome = function () {
  originalStart();

  if (visualMode.value === "bars") initBars();
  if (visualMode.value === "sweep") initSweep();
};

stopMetronome = function () {
  originalStop();

  // ç·´ç¿’å±¥æ­´ ä¿å­˜
  if (Number(sessionTimer.value) > 0) {
    logPractice();
  }
};

/* -----------------------------------------
   Preset ëª©ë¡ ë¡œë”©
----------------------------------------- */
(function loadPresets() {
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("preset_")) {
      const name = key.replace("preset_", "");
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = name;
      presetList.appendChild(opt);
    }
  }
})();

/* -----------------------------------------
   ì´ˆê¸° BeatGrid ìƒì„±
----------------------------------------- */
updateBeatGrid(Number(beats.value));

/* -----------------------------------------
   ê¸°ë³¸ ë¹„ì£¼ì–¼ ëª¨ë“œ ì‹¤í–‰
----------------------------------------- */
visualMode.dispatchEvent(new Event("change"));

/* -----------------------------------------
   Chrome íƒ­ ë°”ê¿€ ë•Œ ì˜¤ë””ì˜¤ ëŠê¹€ ë°©ì§€
----------------------------------------- */
window.addEventListener("blur", () => {
  if (ctx && ctx.state === "running") ctx.suspend();
});
window.addEventListener("focus", () => {
  if (ctx && ctx.state === "suspended") ctx.resume();
});
</script>
